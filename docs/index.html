<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mitchell Maltenfort">

<title>R_medicine_competition_MGM - R Medicine Opioid competition</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R_medicine_competition_MGM</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> INTRODUCTION</a></li>
  <li><a href="#successful-randomization" id="toc-successful-randomization" class="nav-link" data-scroll-target="#successful-randomization"><span class="header-section-number">2</span> SUCCESSFUL RANDOMIZATION</a></li>
  <li><a href="#attendance-and-compliance-post-randomization" id="toc-attendance-and-compliance-post-randomization" class="nav-link" data-scroll-target="#attendance-and-compliance-post-randomization"><span class="header-section-number">3</span> ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">4</span> CONCLUSIONS</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">R Medicine Opioid competition</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mitchell Maltenfort </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> INTRODUCTION</h1>
<p>This is my attempt at the analyses requested in <a href="https://rconsortium.github.io/RMedicine_website/Competition.html" class="uri">https://rconsortium.github.io/RMedicine_website/Competition.html</a>. I focused on identifying predictive factors associated with two questions.</p>
<ol type="1">
<li><p>Of the potential patients providing data, what factors were associated with succesful randomization?</p></li>
<li><p>Defining compliance as the % of potential study weeks where a patient showed up with a negative test, what factors were associated with higher compliance?</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data and packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: tidyverse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.0     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(public.ctn0094data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: public.ctn0094data</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(public.ctn0094extra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: public.ctn0094extra</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(pROC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: pROC
Type 'citation("pROC")' for a citation.

Attaching package: 'pROC'

The following objects are masked from 'package:stats':

    cov, smooth, var</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggeffects)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggeffects</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(kableExtra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: kableExtra

Attaching package: 'kableExtra'

The following object is masked from 'package:dplyr':

    group_rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(broom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: broom</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(rms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rms
Loading required package: Hmisc

Attaching package: 'Hmisc'

The following objects are masked from 'package:dplyr':

    src, summarize

The following objects are masked from 'package:base':

    format.pval, units</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(betareg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: betareg</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(scales)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: scales

Attaching package: 'scales'

The following object is masked from 'package:purrr':

    discard

The following object is masked from 'package:readr':

    col_factor</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(emmeans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: emmeans

Attaching package: 'emmeans'

The following object is masked from 'package:rms':

    contrast</code></pre>
</div>
</div>
</section>
<section id="successful-randomization" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> SUCCESSFUL RANDOMIZATION</h1>
<p>Of the patients listed in ‘everybody’ which ones are successfully randomized (‘randomization’)?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create wide table of drug usge</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>rbs_wide <span class="ot">&lt;-</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  rbs <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(did_use <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="dv">1</span>, did_use <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(who, what, value) <span class="sc">%&gt;%</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(everybody <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(who)) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(value) <span class="sc">~</span> <span class="dv">0</span>, <span class="cn">TRUE</span> <span class="sc">~</span> value)) <span class="sc">%&gt;%</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> what, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_reported_drugs =</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed) <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">NA</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_reported_drugs =</span> <span class="fu">as.factor</span>(total_reported_drugs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(who)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>randomization_tbl <span class="ot">&lt;-</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  demographics <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(randomization <span class="sc">%&gt;%</span> <span class="fu">filter</span>(which <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomization =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(which) <span class="sc">~</span> <span class="st">"0"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> which))) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(rbs_wide) <span class="sc">%&gt;%</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(job) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> job))) <span class="sc">%&gt;%</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_living_stable =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(is_living_stable) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> is_living_stable))) <span class="sc">%&gt;%</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">education =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(education) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> education))) <span class="sc">%&gt;%</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">marital =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(marital) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> marital))) <span class="sc">%&gt;%</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job =</span> <span class="fu">fct_relevel</span>(job, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_living_stable =</span> <span class="fu">fct_relevel</span>(is_living_stable, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">education =</span> <span class="fu">fct_relevel</span>(education, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">marital =</span> <span class="fu">fct_relevel</span>(marital, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cocaine =</span> <span class="fu">as.factor</span>(cocaine), <span class="at">heroin =</span> <span class="fu">as.factor</span>(heroin), <span class="at">speedball =</span> <span class="fu">as.factor</span>(speedball), <span class="at">opioid =</span> <span class="fu">as.factor</span>(opioid), <span class="at">speed =</span> <span class="fu">as.factor</span>(speed)) <span class="sc">%&gt;%</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(everybody)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(who)`
Joining with `by = join_by(who)`
Joining with `by = join_by(who)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use optimum penalty of 1 determined manually using 'pentrace'</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>lrm_randomization <span class="ot">&lt;-</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrm</span>(randomization <span class="sc">~</span> <span class="fu">pol</span>(age, <span class="dv">2</span>) <span class="sc">+</span> job <span class="sc">+</span> education <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> total_reported_drugs <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid, randomization_tbl, <span class="at">x =</span> <span class="cn">TRUE</span>, <span class="at">y =</span> <span class="cn">TRUE</span>, <span class="at">penalty =</span> <span class="dv">1</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Use bootstrap validation to determine what values are persistent</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## Use bootstrap validation to determine what values are persistent</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>validate_randomization <span class="ot">&lt;-</span> <span class="fu">validate</span>(lrm_randomization, <span class="at">B =</span> <span class="dv">200</span>, <span class="at">bw =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
        Backwards Step-down - Original Model

 Deleted     Chi-Sq d.f. P      Residual d.f. P      AIC   
 job         0.23   5    0.9988  0.23     5   0.9988  -9.77
 education   2.69   3    0.4427  2.92     8   0.9395 -13.08
 is_hispanic 0.11   1    0.7370  3.03     9   0.9632 -14.97
 is_male     0.17   1    0.6795  3.20    10   0.9763 -16.80
 speedball   1.84   1    0.1749  5.04    11   0.9293 -16.96
 race        8.97   3    0.0297 14.01    14   0.4493 -13.99
 heroin      6.24   1    0.0125 20.25    15   0.1627  -9.75
 opioid      5.43   1    0.0198 25.68    16   0.0587  -6.32

Approximate Estimates after Deleting Factors

                                         Coef      S.E.  Wald Z         P
Intercept                           0.2726217 0.6201659  0.4396 6.602e-01
age                                -0.0731720 0.0295826 -2.4735 1.338e-02
age^2                               0.0005492 0.0003716  1.4780 1.394e-01
marital=Never married               0.1830554 0.2178662  0.8402 4.008e-01
marital=Separated/Divorced/Widowed  0.2124224 0.2446399  0.8683 3.852e-01
marital=Missing                    -0.9641235 0.1857561 -5.1903 2.100e-07
total_reported_drugs=1              3.7372456 0.2154768 17.3441 0.000e+00
total_reported_drugs=2              3.6986121 0.2124678 17.4079 0.000e+00
total_reported_drugs=3              3.6472251 0.2211314 16.4935 0.000e+00
total_reported_drugs=4              3.8151182 0.2815350 13.5511 0.000e+00
total_reported_drugs=5              3.4882191 0.4293229  8.1249 4.441e-16

Factors in Final Model

[1] age                  marital              total_reported_drugs</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">attr</span>(validate_randomization, <span class="st">"kept"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">age</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">job</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">education</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">marital</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">is_male</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">is_hispanic</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">race</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">total_reported_drugs</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">heroin</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">speedball</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">opioid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode:logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">FALSE:1</td>
<td style="text-align: left;">FALSE:198</td>
<td style="text-align: left;">FALSE:177</td>
<td style="text-align: left;">FALSE:17</td>
<td style="text-align: left;">FALSE:198</td>
<td style="text-align: left;">FALSE:193</td>
<td style="text-align: left;">FALSE:139</td>
<td style="text-align: left;">TRUE:200</td>
<td style="text-align: left;">FALSE:155</td>
<td style="text-align: left;">FALSE:168</td>
<td style="text-align: left;">FALSE:137</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">TRUE :199</td>
<td style="text-align: left;">TRUE :2</td>
<td style="text-align: left;">TRUE :23</td>
<td style="text-align: left;">TRUE :183</td>
<td style="text-align: left;">TRUE :2</td>
<td style="text-align: left;">TRUE :7</td>
<td style="text-align: left;">TRUE :61</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE :45</td>
<td style="text-align: left;">TRUE :32</td>
<td style="text-align: left;">TRUE :63</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>lrm_final <span class="ot">&lt;-</span> <span class="fu">lrm</span>(randomization <span class="sc">~</span> <span class="fu">pol</span>(age, <span class="dv">2</span>) <span class="sc">+</span> marital <span class="sc">+</span> total_reported_drugs, randomization_tbl, <span class="at">x =</span> <span class="cn">TRUE</span>, <span class="at">y =</span> <span class="cn">TRUE</span>, <span class="at">penalty =</span> <span class="dv">1</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>randomization_tbl<span class="sc">$</span>predict_randomization <span class="ot">&lt;-</span> <span class="fu">predict</span>(lrm_final, <span class="at">type =</span> <span class="st">"fitted"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Project 51 has almost perfect randomization compared to other two</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## Project 51 has almost perfect randomization compared to other two</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(lrm_final,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">project</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">predicted</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">27</td>
<td style="text-align: right;">0.6509355</td>
<td style="text-align: right;">0.5791867</td>
<td style="text-align: right;">0.7164402</td>
</tr>
<tr class="even">
<td style="text-align: left;">30</td>
<td style="text-align: right;">0.7240205</td>
<td style="text-align: right;">0.6693301</td>
<td style="text-align: right;">0.7727367</td>
</tr>
<tr class="odd">
<td style="text-align: left;">51</td>
<td style="text-align: right;">0.9940233</td>
<td style="text-align: right;">0.9824580</td>
<td style="text-align: right;">0.9979793</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Use bootstrap validtion to determine what values are persistent</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## Use bootstrap validtion to determine what values are persistent</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>coef <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(lrm_final)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(lrm_final)))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Final logistic regression model predicting successful randomization (log-odds)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## Final logistic regression model predicting successful randomization (log-odds)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">(factor reference levels based on alphabetical order)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

(factor reference levels based on alphabetical order)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">term =</span> <span class="fu">names</span>(coef), coef, se) <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">case_when</span>(coef <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">pnorm</span>(coef <span class="sc">/</span> se, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>), <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">pnorm</span>(coef <span class="sc">/</span> se, <span class="at">lower.tail =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">4</span>, <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Total Reported Drugs (reference level 0)"</span>, <span class="dv">7</span>, <span class="dv">11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">coef</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">0.1741456</td>
<td style="text-align: right;">0.6158886</td>
<td style="text-align: right;">0.7773647</td>
</tr>
<tr class="even">
<td style="text-align: left;">age</td>
<td style="text-align: right;">-0.0722803</td>
<td style="text-align: right;">0.0294367</td>
<td style="text-align: right;">0.0140707</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age^2</td>
<td style="text-align: right;">0.0005367</td>
<td style="text-align: right;">0.0003702</td>
<td style="text-align: right;">0.1471491</td>
</tr>
<tr class="even" data-grouplength="3">
<td colspan="4" style="text-align: left; border-bottom: 1px solid;"><strong>Marital (ref level Married or Partnered)</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">marital=Never married</td>
<td style="text-align: right;">0.1860933</td>
<td style="text-align: right;">0.2177973</td>
<td style="text-align: right;">0.3928649</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">marital=Separated/Divorced/Widowed</td>
<td style="text-align: right;">0.2180355</td>
<td style="text-align: right;">0.2447502</td>
<td style="text-align: right;">0.3730099</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">marital=Missing</td>
<td style="text-align: right;">-0.9700294</td>
<td style="text-align: right;">0.1860135</td>
<td style="text-align: right;">0.0000002</td>
</tr>
<tr class="even" data-grouplength="5">
<td colspan="4" style="text-align: left; border-bottom: 1px solid;"><strong>Total Reported Drugs (reference level 0)</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=1</td>
<td style="text-align: right;">3.8333471</td>
<td style="text-align: right;">0.2133380</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=2</td>
<td style="text-align: right;">3.8023090</td>
<td style="text-align: right;">0.2102814</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=3</td>
<td style="text-align: right;">3.7605650</td>
<td style="text-align: right;">0.2188092</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=4</td>
<td style="text-align: right;">3.9294689</td>
<td style="text-align: right;">0.2790591</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=5</td>
<td style="text-align: right;">3.5772414</td>
<td style="text-align: right;">0.4260219</td>
<td style="text-align: right;">0.0000000</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>calibrate_final <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(lrm_final, <span class="at">B =</span> <span class="dv">200</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>calibrate_tbl <span class="ot">&lt;-</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  calibrate_final[, <span class="fu">c</span>(<span class="st">"predy"</span>, <span class="st">"calibrated.orig"</span>, <span class="st">"calibrated.corrected"</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(calibrated.orig<span class="sc">:</span>calibrated.corrected)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Show calibration (predicted vs actual) for predictive model of randomization</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## Show calibration (predicted vs actual) for predictive model of randomization</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>calibrate_tbl <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> predy, <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"calibration"</span>, <span class="at">x =</span> <span class="st">"Predicted Probability"</span>, <span class="at">y =</span> <span class="st">"Actual Probability"</span>) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: A numeric `legend.position` argument in `theme()` was deprecated in ggplot2
3.5.0.
ℹ Please use the `legend.position.inside` argument of `theme()` instead.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/randomization-1.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">&lt;-</span> <span class="fu">ci.auc</span>(<span class="fu">roc</span>(randomization <span class="sc">~</span> predict_randomization, <span class="at">data =</span> randomization_tbl <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(predict_randomization))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting levels: control = 0, case = 1
Setting direction: controls &lt; cases</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## ROC curve AUC is %0.2f (95 percent CI %0.2f - %0.2f), </span><span class="sc">\n\n</span><span class="st">"</span>, auc[<span class="dv">2</span>], auc[<span class="dv">1</span>], auc[<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## ROC curve AUC is 0.81 (95 percent CI 0.79 - 0.83), </code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">roc</span>(randomization <span class="sc">~</span> predict_randomization, <span class="at">data =</span> randomization_tbl <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(predict_randomization))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting levels: control = 0, case = 1
Setting direction: controls &lt; cases</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/randomization-2.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Estimated marginal means</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## Estimated marginal means</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Marital</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Marital</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"marital"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/randomization-3.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_predictions</span>(lrm_final, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">marital</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Contrast</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Married or Partnered-Never married</td>
<td style="text-align: right;">-0.0252404</td>
<td style="text-align: right;">-0.0824855</td>
<td style="text-align: right;">0.0320046</td>
<td style="text-align: right;">0.3874862</td>
</tr>
<tr class="even">
<td style="text-align: left;">Married or Partnered-Separated/Divorced/Widowed</td>
<td style="text-align: right;">-0.0298955</td>
<td style="text-align: right;">-0.0961135</td>
<td style="text-align: right;">0.0363225</td>
<td style="text-align: right;">0.3762287</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Married or Partnered-Missing</td>
<td style="text-align: right;">0.0870519</td>
<td style="text-align: right;">0.0348838</td>
<td style="text-align: right;">0.1392201</td>
<td style="text-align: right;">0.0010734</td>
</tr>
<tr class="even">
<td style="text-align: left;">Never married-Separated/Divorced/Widowed</td>
<td style="text-align: right;">-0.0046551</td>
<td style="text-align: right;">-0.0666364</td>
<td style="text-align: right;">0.0573262</td>
<td style="text-align: right;">0.8829721</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Never married-Missing</td>
<td style="text-align: right;">0.1122923</td>
<td style="text-align: right;">0.0624778</td>
<td style="text-align: right;">0.1621069</td>
<td style="text-align: right;">0.0000100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Separated/Divorced/Widowed-Missing</td>
<td style="text-align: right;">0.1169474</td>
<td style="text-align: right;">0.0563531</td>
<td style="text-align: right;">0.1775418</td>
<td style="text-align: right;">0.0001551</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Total reported drugs</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Total reported drugs</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"total_reported_drugs"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/randomization-4.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_predictions</span>(lrm_final, <span class="st">"total_reported_drugs"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">total_reported_drugs</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Contrast</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0-1</td>
<td style="text-align: right;">-0.7408890</td>
<td style="text-align: right;">-0.7933182</td>
<td style="text-align: right;">-0.6884598</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">0-2</td>
<td style="text-align: right;">-0.7378239</td>
<td style="text-align: right;">-0.7897550</td>
<td style="text-align: right;">-0.6858928</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0-3</td>
<td style="text-align: right;">-0.7335837</td>
<td style="text-align: right;">-0.7869992</td>
<td style="text-align: right;">-0.6801682</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">0-4</td>
<td style="text-align: right;">-0.7499212</td>
<td style="text-align: right;">-0.8116047</td>
<td style="text-align: right;">-0.6882376</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0-5</td>
<td style="text-align: right;">-0.7132936</td>
<td style="text-align: right;">-0.8138319</td>
<td style="text-align: right;">-0.6127554</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">1-2</td>
<td style="text-align: right;">0.0030651</td>
<td style="text-align: right;">-0.0206425</td>
<td style="text-align: right;">0.0267727</td>
<td style="text-align: right;">0.7999593</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1-3</td>
<td style="text-align: right;">0.0073053</td>
<td style="text-align: right;">-0.0197899</td>
<td style="text-align: right;">0.0344004</td>
<td style="text-align: right;">0.5971954</td>
</tr>
<tr class="even">
<td style="text-align: left;">1-4</td>
<td style="text-align: right;">-0.0090321</td>
<td style="text-align: right;">-0.0490508</td>
<td style="text-align: right;">0.0309865</td>
<td style="text-align: right;">0.6582287</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1-5</td>
<td style="text-align: right;">0.0275954</td>
<td style="text-align: right;">-0.0627017</td>
<td style="text-align: right;">0.1178925</td>
<td style="text-align: right;">0.5491874</td>
</tr>
<tr class="even">
<td style="text-align: left;">2-3</td>
<td style="text-align: right;">0.0042402</td>
<td style="text-align: right;">-0.0220300</td>
<td style="text-align: right;">0.0305104</td>
<td style="text-align: right;">0.7517362</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2-4</td>
<td style="text-align: right;">-0.0120972</td>
<td style="text-align: right;">-0.0516237</td>
<td style="text-align: right;">0.0274293</td>
<td style="text-align: right;">0.5486031</td>
</tr>
<tr class="even">
<td style="text-align: left;">2-5</td>
<td style="text-align: right;">0.0245303</td>
<td style="text-align: right;">-0.0654250</td>
<td style="text-align: right;">0.1144856</td>
<td style="text-align: right;">0.5930158</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3-4</td>
<td style="text-align: right;">-0.0163374</td>
<td style="text-align: right;">-0.0578999</td>
<td style="text-align: right;">0.0252251</td>
<td style="text-align: right;">0.4410482</td>
</tr>
<tr class="even">
<td style="text-align: left;">3-5</td>
<td style="text-align: right;">0.0202901</td>
<td style="text-align: right;">-0.0704499</td>
<td style="text-align: right;">0.1110301</td>
<td style="text-align: right;">0.6611965</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4-5</td>
<td style="text-align: right;">0.0366275</td>
<td style="text-align: right;">-0.0585622</td>
<td style="text-align: right;">0.1318173</td>
<td style="text-align: right;">0.4507509</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Age</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"age[all]"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/randomization-5.png" class="img-fluid" width="2400"></p>
</div>
</div>
</section>
<section id="attendance-and-compliance-post-randomization" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION</h1>
<p>This adapts the code from ‘public.ctn0094extra’ vignette to summarise substance use across weeks.</p>
<p>I define compliance as how many times the patient showed up with a negative UDS report, divided by the length of time in the study (Study Week + 1 for Baseline). Attendance is how many times the patient showed up with a report (positive or negative), divided by length of time in the study.</p>
<p>Beta regression is used to create a parsimonious model, pruned “by hand” to get rid of irrelevant predictors. The correlation coefficients for these models are not good (R-squared &lt; 0.03) but there may be some insight into how to get better attendance or compliance for patients</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>data_ls <span class="ot">&lt;-</span> <span class="fu">loadRawData</span>(<span class="fu">c</span>(<span class="st">"randomization"</span>, <span class="st">"treatment"</span>))</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>randomization <span class="ot">&lt;-</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, treatment, <span class="at">randomized =</span> which) <span class="sc">%&gt;%</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove second randomization events</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized <span class="sc">!=</span> <span class="dv">2</span>)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>treatment <span class="ot">&lt;-</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>treatment</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>start_int <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">27</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span>30L, <span class="st">`</span><span class="at">51</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span>30L)</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>end_int <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">27</span><span class="st">`</span> <span class="ot">=</span> 168L, <span class="st">`</span><span class="at">51</span><span class="st">`</span> <span class="ot">=</span> 168L)</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>backbone2751_df <span class="ot">&lt;-</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CreateProtocolHistory</span>(</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_vec =</span> start_int,</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_vec =</span> end_int</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>backbone30_df <span class="ot">&lt;-</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(project <span class="sc">==</span> <span class="st">"30"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CreateCTN30ProtocolHistory</span>() <span class="sc">%&gt;%</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">project =</span> <span class="st">"30"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, project, when)</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>backbone_df <span class="ot">&lt;-</span></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(backbone2751_df, backbone30_df) <span class="sc">%&gt;%</span></span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(who)</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(backbone2751_df, backbone30_df, start_int, end_int)</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>data_ls <span class="ot">&lt;-</span> <span class="fu">loadRawData</span>(<span class="fu">c</span>(<span class="st">"randomization"</span>, <span class="st">"visit"</span>))</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>randomization <span class="ot">&lt;-</span></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, treatment, <span class="at">randomized =</span> which) <span class="sc">%&gt;%</span></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove second randomization events</span></span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized <span class="sc">!=</span> <span class="dv">2</span>)</span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>visit <span class="ot">&lt;-</span></span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>visit</span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a>timelineRand1_df <span class="ot">&lt;-</span></span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomized =</span> randomized <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join to backbone and arrange within subject by day</span></span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(backbone_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(when, <span class="at">.by_group =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, project, when, randomized)</span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a>timelineVisit1_df <span class="ot">&lt;-</span></span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>visit <span class="sc">%&gt;%</span></span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visit, <span class="at">status =</span> what) <span class="sc">%&gt;%</span></span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"visit"</span>, <span class="st">"final"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visit) <span class="sc">%&gt;%</span></span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(timelineRand1_df, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a>timelineMissing1_df <span class="ot">&lt;-</span> <span class="fu">MarkMissing</span>(timelineVisit1_df)</span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a>derived_visitImputed <span class="ot">&lt;-</span></span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a>  timelineMissing1_df <span class="sc">%&gt;%</span></span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visit =</span> <span class="fu">as.character</span>(visit)) <span class="sc">%&gt;%</span></span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">visit =</span> <span class="st">""</span>, <span class="at">visitYM =</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visitImputed =</span> <span class="fu">paste0</span>(visit, visitYM)) <span class="sc">%&gt;%</span></span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">visitImputed =</span> <span class="fu">str_replace</span>(</span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a>      visitImputed,</span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">pattern =</span> <span class="st">"TRUETRUE"</span>, <span class="at">replacement =</span> <span class="st">"Present"</span></span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-76"><a href="#cb71-76" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb71-77"><a href="#cb71-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visitImputed) <span class="sc">%&gt;%</span></span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(visitImputed <span class="sc">!=</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-82"><a href="#cb71-82" aria-hidden="true" tabindex="-1"></a>randomized_df <span class="ot">&lt;-</span></span>
<span id="cb71-83"><a href="#cb71-83" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb71-84"><a href="#cb71-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomized =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(which))) <span class="sc">%&gt;%</span></span>
<span id="cb71-85"><a href="#cb71-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, randomized) <span class="sc">%&gt;%</span></span>
<span id="cb71-86"><a href="#cb71-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-87"><a href="#cb71-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> project <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"27"</span>, <span class="st">"51"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb71-88"><a href="#cb71-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>project)</span>
<span id="cb71-89"><a href="#cb71-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-90"><a href="#cb71-90" aria-hidden="true" tabindex="-1"></a>udsUse2_df <span class="ot">&lt;-</span></span>
<span id="cb71-91"><a href="#cb71-91" aria-hidden="true" tabindex="-1"></a>  backbone_df <span class="sc">%&gt;%</span></span>
<span id="cb71-92"><a href="#cb71-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(randomized_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-93"><a href="#cb71-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(derived_visitImputed, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-94"><a href="#cb71-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(uds, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-95"><a href="#cb71-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So we can use MarkUse() with UDS data (instead of all_drugs)</span></span>
<span id="cb71-96"><a href="#cb71-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"UDS"</span>)</span>
<span id="cb71-97"><a href="#cb71-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-98"><a href="#cb71-98" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(</span>
<span id="cb71-99"><a href="#cb71-99" aria-hidden="true" tabindex="-1"></a>  backbone_df, data_ls, timelineMissing1_df, timelineRand1_df, timelineVisit1_df</span>
<span id="cb71-100"><a href="#cb71-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-101"><a href="#cb71-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-102"><a href="#cb71-102" aria-hidden="true" tabindex="-1"></a>nonStudyOpioids_ls <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb71-103"><a href="#cb71-103" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Buprenorphine"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>),</span>
<span id="cb71-104"><a href="#cb71-104" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Methadone"</span>     <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Buprenorphine"</span>),</span>
<span id="cb71-105"><a href="#cb71-105" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Naltrexone"</span>    <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>, <span class="st">"Buprenorphine"</span>),</span>
<span id="cb71-106"><a href="#cb71-106" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Not treated"</span>   <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>, <span class="st">"Buprenorphine"</span>)</span>
<span id="cb71-107"><a href="#cb71-107" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-108"><a href="#cb71-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-109"><a href="#cb71-109" aria-hidden="true" tabindex="-1"></a>treatGroups_ls <span class="ot">&lt;-</span></span>
<span id="cb71-110"><a href="#cb71-110" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb71-111"><a href="#cb71-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(which <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-112"><a href="#cb71-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-113"><a href="#cb71-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, treatment) <span class="sc">%&gt;%</span></span>
<span id="cb71-114"><a href="#cb71-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb71-115"><a href="#cb71-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_drug =</span> <span class="fu">case_when</span>(</span>
<span id="cb71-116"><a href="#cb71-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(treatment, <span class="st">"BUP"</span>) <span class="sc">~</span> <span class="st">"Buprenorphine"</span>,</span>
<span id="cb71-117"><a href="#cb71-117" aria-hidden="true" tabindex="-1"></a>      treatment <span class="sc">==</span> <span class="st">"Methadone"</span> <span class="sc">~</span> <span class="st">"Methadone"</span>,</span>
<span id="cb71-118"><a href="#cb71-118" aria-hidden="true" tabindex="-1"></a>      treatment <span class="sc">==</span> <span class="st">"Inpatient NR-NTX"</span> <span class="sc">~</span> <span class="st">"Naltrexone"</span></span>
<span id="cb71-119"><a href="#cb71-119" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-120"><a href="#cb71-120" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb71-121"><a href="#cb71-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>treatment) <span class="sc">%&gt;%</span></span>
<span id="cb71-122"><a href="#cb71-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="at">f =</span> .<span class="sc">$</span>treat_drug) <span class="sc">%&gt;%</span></span>
<span id="cb71-123"><a href="#cb71-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="st">"who"</span>)</span>
<span id="cb71-124"><a href="#cb71-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-125"><a href="#cb71-125" aria-hidden="true" tabindex="-1"></a>opioidUse_df <span class="ot">&lt;-</span></span>
<span id="cb71-126"><a href="#cb71-126" aria-hidden="true" tabindex="-1"></a>  udsUse2_df <span class="sc">%&gt;%</span></span>
<span id="cb71-127"><a href="#cb71-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb71-128"><a href="#cb71-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb71-129"><a href="#cb71-129" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Buprenorphine <span class="sc">~</span> <span class="st">"Buprenorphine"</span>,</span>
<span id="cb71-130"><a href="#cb71-130" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Methadone <span class="sc">~</span> <span class="st">"Methadone"</span>,</span>
<span id="cb71-131"><a href="#cb71-131" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Naltrexone <span class="sc">~</span> <span class="st">"Naltrexone"</span>,</span>
<span id="cb71-132"><a href="#cb71-132" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Not treated"</span></span>
<span id="cb71-133"><a href="#cb71-133" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-134"><a href="#cb71-134" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb71-135"><a href="#cb71-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="at">f =</span> .<span class="sc">$</span>treat_group) <span class="sc">%&gt;%</span></span>
<span id="cb71-136"><a href="#cb71-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of data in alphabetical order, so the non-study drugs ls should match</span></span>
<span id="cb71-137"><a href="#cb71-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map2</span>(</span>
<span id="cb71-138"><a href="#cb71-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">.y =</span> nonStudyOpioids_ls,</span>
<span id="cb71-139"><a href="#cb71-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb71-140"><a href="#cb71-140" aria-hidden="true" tabindex="-1"></a>      <span class="co"># REQUIRES "source" COLUMN</span></span>
<span id="cb71-141"><a href="#cb71-141" aria-hidden="true" tabindex="-1"></a>      <span class="fu">MarkUse</span>(</span>
<span id="cb71-142"><a href="#cb71-142" aria-hidden="true" tabindex="-1"></a>        <span class="at">targetDrugs_char =</span> .y,</span>
<span id="cb71-143"><a href="#cb71-143" aria-hidden="true" tabindex="-1"></a>        <span class="at">drugs_df =</span> .x,</span>
<span id="cb71-144"><a href="#cb71-144" aria-hidden="true" tabindex="-1"></a>        <span class="co"># because we have participants with no recorded UDS; in practice DO NOT</span></span>
<span id="cb71-145"><a href="#cb71-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   use this command</span></span>
<span id="cb71-146"><a href="#cb71-146" aria-hidden="true" tabindex="-1"></a>        <span class="at">retainEmptyRows =</span> <span class="cn">TRUE</span></span>
<span id="cb71-147"><a href="#cb71-147" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb71-148"><a href="#cb71-148" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-149"><a href="#cb71-149" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb71-150"><a href="#cb71-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span></span>
<span id="cb71-151"><a href="#cb71-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb71-152"><a href="#cb71-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">udsOpioid =</span> <span class="fu">case_when</span>(</span>
<span id="cb71-153"><a href="#cb71-153" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(when) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb71-154"><a href="#cb71-154" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(when) <span class="sc">~</span> <span class="cn">TRUE</span></span>
<span id="cb71-155"><a href="#cb71-155" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-156"><a href="#cb71-156" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb71-157"><a href="#cb71-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, udsOpioid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The following drugs were not matched: Buprenorphine. Please check for
possible spelling/capitalization errors.

Warning: The following drugs were not matched: Buprenorphine. Please check for
possible spelling/capitalization errors.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>timelineUDS_df <span class="ot">&lt;-</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  udsUse2_df <span class="sc">%&gt;%</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(opioidUse_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>what, <span class="sc">-</span>source) <span class="sc">%&gt;%</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2,089 rows to 1,994</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  derived_visitImputed, opioidUse_df, randomized_df, treatGroups_ls, udsUse2_df</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>wasRandomized_int <span class="ot">&lt;-</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">randomized =</span> <span class="fu">any</span>(randomized <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized) <span class="sc">%&gt;%</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(who)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>notRandomized_int <span class="ot">&lt;-</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(who <span class="sc">%in%</span> wasRandomized_int)) <span class="sc">%&gt;%</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>timelineUDS2_df <span class="ot">&lt;-</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(who <span class="sc">%in%</span> wasRandomized_int) <span class="sc">%&gt;%</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(randomized)) <span class="sc">%&gt;%</span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">whenRandomized1 =</span> <span class="fu">case_when</span>(randomized <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> when),</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">whenRandomized2 =</span> <span class="fu">case_when</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> when)</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, whenRandomized1, whenRandomized2) <span class="sc">%&gt;%</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(timelineUDS_df, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(who <span class="sc">%in%</span> wasRandomized_int) <span class="sc">%&gt;%</span></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add back in the groupings BEFORE the fill()</span></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(whenRandomized1, <span class="at">.direction =</span> <span class="st">"updown"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(whenRandomized2, <span class="at">.direction =</span> <span class="st">"updown"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">daysSinceRand1 =</span> when <span class="sc">-</span> whenRandomized1) <span class="sc">%&gt;%</span></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">daysSinceRand2 =</span> when <span class="sc">-</span> whenRandomized2) <span class="sc">%&gt;%</span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>whenRandomized1, <span class="sc">-</span>whenRandomized2)</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>weeklyUse_df <span class="ot">&lt;-</span></span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>  timelineUDS2_df <span class="sc">%&gt;%</span></span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The (daysSinceRand1 - 1) adjustment is to ensure that the first study week</span></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   is a full 7 days, since "day 0" is the day before randomization. The "+1"</span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   at the end is to shift the study week label such that "week 0" is the</span></span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   week *BEFORE* treatment, rather than the first week of treatment. So, the</span></span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   randomization day is the last day of "week 0" (the pre-treatment period).</span></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">studyWeek1 =</span> (daysSinceRand1 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> <span class="dv">7</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">studyWeek2 =</span> (daysSinceRand2 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> <span class="dv">7</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who, studyWeek1) <span class="sc">%&gt;%</span></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># There are some study weeks with multiple UDS, so we count the number of</span></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   positive and negative UDS per week.</span></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">nPosUDS  =</span> <span class="fu">sum</span>(udsOpioid <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">nNegUDS  =</span> <span class="fu">sum</span>(visitImputed <span class="sc">==</span> <span class="st">"Present"</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(udsOpioid), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">nMissing =</span> <span class="fu">sum</span>(visitImputed <span class="sc">==</span> <span class="st">"Missing"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">randWk1  =</span> <span class="fu">sum</span>(randomized <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">randWk2  =</span> <span class="fu">sum</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> project <span class="sc">==</span> <span class="st">"30"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'who'. You can override using the `.groups`
argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>useByWeekRandomized_df <span class="ot">&lt;-</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  weeklyUse_df <span class="sc">%&gt;%</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">udsStatus =</span> <span class="fu">case_when</span>(</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see a positive UDS and no negative UDS, it's positive</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"+"</span>,</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see a negative UDS and no positive UDS, it's negative</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"-"</span>,</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see both positive and negative UDS in a single week, it's both</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   (note that we can recode all "B"s to be "+" as necessary)</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"*"</span>,</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we don't have any UDS in a week after randomization, it's missing</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># UPDATE 2022-03-08: I had this as a 0 originally, and I was using this</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   in context of consent, not randomization. This was wrong.</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> studyWeek1 <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"o"</span>,</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If none of the above are true, but we still have a missing value as</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   marked by the MarkMissing() function, then it's missing</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>      nMissing <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"o"</span>,</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If none of the above conditions are true (probably because it's a week</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   before randomization but not during a baseline visit for consent),</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   then leave it blank (pre-study)</span></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"_"</span></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For CTN-0030, Phase II could have started on any day of the week, even in</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   the middle of a treatment week. If we try to start counting Phase II</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   weeks the day after treatment arms are switched, we can end up with the</span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   last "week" of Phase I not having 7 days. I'm going to leave the first</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   week of Phase II as whatever week the switch happened in.</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">rand1Active =</span> studyWeek1 <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This returns 0 for any week before the Phase II randomization, and 1 for</span></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   the Phase II randomization week and all subsequent weeks (because the</span></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   randWk2 column is 1 only for the week of second randomization and 0</span></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   all other rows).</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">rand2Active =</span> <span class="fu">cumsum</span>(randWk2),</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">trialPhase  =</span> rand1Active <span class="sc">+</span> rand2Active</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>    who,</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">studyWeek =</span> studyWeek1, randWk1, randWk2, udsStatus, trialPhase</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a><span class="do">#### NEW</span></span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="ot">&lt;-</span></span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>  useByWeekRandomized_df <span class="sc">%&gt;%</span></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(trialPhase <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(studyWeek <span class="sc">&gt;=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(everybody) <span class="sc">%&gt;%</span></span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(project, who) <span class="sc">%&gt;%</span></span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">sum_pos =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"+"</span>), <span class="at">sum_neg =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"-"</span>), <span class="at">sumMissing =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"o"</span>), <span class="at">total_weeks =</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">max</span>(studyWeek)) <span class="sc">%&gt;%</span></span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">compliance =</span> sum_neg <span class="sc">/</span> total_weeks, <span class="at">attendance =</span> (sum_neg<span class="sc">+</span>sum_pos)<span class="sc">/</span>total_weeks) <span class="sc">%&gt;%</span></span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(randomization_tbl <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(who, age, is_hispanic, race, job, education, is_living_stable, marital, is_male, cocaine<span class="sc">:</span>total_reported_drugs, predict_randomization)) <span class="sc">%&gt;%</span></span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">project=</span><span class="fu">as.factor</span>(project))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(who)`
`summarise()` has grouped output by 'project'. You can override using the
`.groups` argument.
Joining with `by = join_by(who)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from https://stats.stackexchange.com/questions/31300/dealing-with-0-1-values-in-a-beta-regression</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># squeeze 0 and 1 so can use beta regression</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">dim</span>(compliance_results)[<span class="dv">1</span>]</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="ot">&lt;-</span> <span class="fu">mutate</span>(compliance_results, <span class="at">squeeze_compliance =</span> (compliance <span class="sc">*</span> (N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">/</span> N, <span class="at">squeeze_attendance =</span> (attendance <span class="sc">*</span> (N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">/</span> N)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>beta_compliance <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_compliance <span class="sc">~</span> age <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>beta_compliance_red <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_compliance <span class="sc">~</span> age <span class="sc">+</span> race <span class="sc">+</span> job <span class="sc">+</span> marital <span class="sc">+</span> heroin <span class="sc">+</span> opioid, compliance_results)</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>beta_attendance <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_attendance <span class="sc">~</span> age <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in betareg.fit(X, Y, Z, weights, offset, link, link.phi, type,
control): no valid starting value for precision parameter found, using 1
instead</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>beta_attendance_red <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_attendance <span class="sc">~</span> age   <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in betareg.fit(X, Y, Z, weights, offset, link, link.phi, type,
control): no valid starting value for precision parameter found, using 1
instead</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Beta regression coefficients (factor reference levels based on alphabetical order)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## Beta regression coefficients (factor reference levels based on alphabetical order)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Compliance</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Compliance</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(beta_compliance_red) <span class="sc">%&gt;%</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>statistic) <span class="sc">%&gt;%</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Race (reference level Black)"</span>, <span class="dv">3</span>, <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"job (reference level Full Time)"</span>, <span class="dv">6</span>, <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">11</span>, <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">component</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.4656202</td>
<td style="text-align: right;">0.1722355</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.0077218</td>
<td style="text-align: right;">0.0025338</td>
<td style="text-align: right;">0.0023075</td>
</tr>
<tr class="odd" data-grouplength="3">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Race (reference level Black)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">raceOther</td>
<td style="text-align: right;">-0.0000154</td>
<td style="text-align: right;">0.1035300</td>
<td style="text-align: right;">0.9998809</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">raceRefused/missing</td>
<td style="text-align: right;">-0.1131639</td>
<td style="text-align: right;">0.3348571</td>
<td style="text-align: right;">0.7354034</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">raceWhite</td>
<td style="text-align: right;">0.1482887</td>
<td style="text-align: right;">0.0878694</td>
<td style="text-align: right;">0.0914874</td>
</tr>
<tr class="odd" data-grouplength="5">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>job (reference level Full Time)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobOther</td>
<td style="text-align: right;">0.3114931</td>
<td style="text-align: right;">0.1846286</td>
<td style="text-align: right;">0.0915776</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobPart Time</td>
<td style="text-align: right;">-0.1640795</td>
<td style="text-align: right;">0.0855055</td>
<td style="text-align: right;">0.0549926</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobStudent</td>
<td style="text-align: right;">-0.2596616</td>
<td style="text-align: right;">0.1956821</td>
<td style="text-align: right;">0.1845232</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobUnemployed</td>
<td style="text-align: right;">0.0299534</td>
<td style="text-align: right;">0.0846908</td>
<td style="text-align: right;">0.7235793</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobMissing</td>
<td style="text-align: right;">-0.5690129</td>
<td style="text-align: right;">0.6021055</td>
<td style="text-align: right;">0.3446392</td>
</tr>
<tr class="odd" data-grouplength="3">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Marital (ref level Married or Partnered)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalNever married</td>
<td style="text-align: right;">0.2686716</td>
<td style="text-align: right;">0.0884782</td>
<td style="text-align: right;">0.0023927</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalSeparated/Divorced/Widowed</td>
<td style="text-align: right;">0.2431355</td>
<td style="text-align: right;">0.1008997</td>
<td style="text-align: right;">0.0159667</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalMissing</td>
<td style="text-align: right;">0.5755636</td>
<td style="text-align: right;">0.6054473</td>
<td style="text-align: right;">0.3417862</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">heroin1</td>
<td style="text-align: right;">-0.1291437</td>
<td style="text-align: right;">0.0619663</td>
<td style="text-align: right;">0.0371516</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">opioid1</td>
<td style="text-align: right;">0.2627274</td>
<td style="text-align: right;">0.0567428</td>
<td style="text-align: right;">0.0000037</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">(phi)</td>
<td style="text-align: right;">1.2804061</td>
<td style="text-align: right;">0.0325090</td>
<td style="text-align: right;">0.0000000</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### No major difference between Projects</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### No major difference between Projects</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">Update models by adding project and look for marginal means between projects</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

Update models by adding project and look for marginal means between projects</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">#### Compliance</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

#### Compliance</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(beta_compliance_red,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">project</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">predicted</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">27</td>
<td style="text-align: right;">0.2862537</td>
<td style="text-align: right;">0.2271404</td>
<td style="text-align: right;">0.3453670</td>
</tr>
<tr class="even">
<td style="text-align: left;">30</td>
<td style="text-align: right;">0.2495486</td>
<td style="text-align: right;">0.1970343</td>
<td style="text-align: right;">0.3020629</td>
</tr>
<tr class="odd">
<td style="text-align: left;">51</td>
<td style="text-align: right;">0.3312811</td>
<td style="text-align: right;">0.2736646</td>
<td style="text-align: right;">0.3888977</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">#### Attendance</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

#### Attendance</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(beta_attendance_red,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in betareg.fit(X, Y, Z, weights, offset, link, link.phi, type,
control): no valid starting value for precision parameter found, using 1
instead</code></pre>
</div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">project</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">predicted</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">27</td>
<td style="text-align: right;">0.4234444</td>
<td style="text-align: right;">0.3310894</td>
<td style="text-align: right;">0.5157993</td>
</tr>
<tr class="even">
<td style="text-align: left;">30</td>
<td style="text-align: right;">0.4437619</td>
<td style="text-align: right;">0.3556613</td>
<td style="text-align: right;">0.5318625</td>
</tr>
<tr class="odd">
<td style="text-align: left;">51</td>
<td style="text-align: right;">0.4345425</td>
<td style="text-align: right;">0.3448335</td>
<td style="text-align: right;">0.5242516</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Attendance</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Attendance</code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(beta_attendance_red) <span class="sc">%&gt;%</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>statistic) <span class="sc">%&gt;%</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Job (reference level Full Time)"</span>, <span class="dv">3</span>, <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Is living stable (reference level No)"</span>, <span class="dv">8</span>, <span class="dv">9</span>) <span class="sc">%&gt;%</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">10</span>, <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">component</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.1593638</td>
<td style="text-align: right;">0.2248213</td>
<td style="text-align: right;">0.0000003</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.0075580</td>
<td style="text-align: right;">0.0024485</td>
<td style="text-align: right;">0.0020234</td>
</tr>
<tr class="odd" data-grouplength="5">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Job (reference level Full Time)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobOther</td>
<td style="text-align: right;">0.3098685</td>
<td style="text-align: right;">0.1813007</td>
<td style="text-align: right;">0.0874248</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobPart Time</td>
<td style="text-align: right;">-0.1632520</td>
<td style="text-align: right;">0.0856712</td>
<td style="text-align: right;">0.0567067</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobStudent</td>
<td style="text-align: right;">0.0124950</td>
<td style="text-align: right;">0.1970223</td>
<td style="text-align: right;">0.9494328</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobUnemployed</td>
<td style="text-align: right;">0.0808107</td>
<td style="text-align: right;">0.0845202</td>
<td style="text-align: right;">0.3390160</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobMissing</td>
<td style="text-align: right;">-0.7457840</td>
<td style="text-align: right;">0.8317397</td>
<td style="text-align: right;">0.3699027</td>
</tr>
<tr class="odd" data-grouplength="2">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Is living stable (reference level No)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">is_living_stableYes</td>
<td style="text-align: right;">0.3387088</td>
<td style="text-align: right;">0.1782797</td>
<td style="text-align: right;">0.0574498</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">is_living_stableMissing</td>
<td style="text-align: right;">1.2729703</td>
<td style="text-align: right;">1.1954770</td>
<td style="text-align: right;">0.2869565</td>
</tr>
<tr class="even" data-grouplength="3">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Marital (ref level Married or Partnered)</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalNever married</td>
<td style="text-align: right;">0.2358692</td>
<td style="text-align: right;">0.0874130</td>
<td style="text-align: right;">0.0069688</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalSeparated/Divorced/Widowed</td>
<td style="text-align: right;">0.0987595</td>
<td style="text-align: right;">0.1001031</td>
<td style="text-align: right;">0.3238495</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalMissing</td>
<td style="text-align: right;">0.0036187</td>
<td style="text-align: right;">0.8424911</td>
<td style="text-align: right;">0.9965729</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">opioid1</td>
<td style="text-align: right;">0.2378354</td>
<td style="text-align: right;">0.0517281</td>
<td style="text-align: right;">0.0000043</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">speed1</td>
<td style="text-align: right;">-0.1193640</td>
<td style="text-align: right;">0.0573867</td>
<td style="text-align: right;">0.0375262</td>
</tr>
<tr class="even">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">(phi)</td>
<td style="text-align: right;">1.4512074</td>
<td style="text-align: right;">0.0337427</td>
<td style="text-align: right;">0.0000000</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Estimated marginal means</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

## Estimated marginal means</code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Age</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>emm_compliance_age <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"age"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>emm_attendance_age <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"age"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_age, emm_compliance_age) <span class="sc">%&gt;%</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>predicted, <span class="at">ymax=</span>conf.high, <span class="at">ymin=</span>conf.low, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_smooth</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">geom_ribbon</span>(<span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="cn">NA</span>) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Estimate"</span>,<span class="at">x=</span><span class="st">"Age"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-1.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age (raw data) </span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Age (raw data) </code></pre>
</div>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(compliance, attendance, age) <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>age) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>age,<span class="at">y=</span>value, <span class="at">color=</span>name, <span class="at">fill=</span>name)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.25</span>) <span class="sc">+</span> <span class="fu">geom_smooth</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">color=</span><span class="st">"Outcome"</span>, <span class="at">fill=</span><span class="st">"Outcome"</span>, <span class="at">y=</span><span class="st">"Rate"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">label=</span>percent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-2.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Marital</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Marital</code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>emm_compliance_marital <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>emm_attendance_marital <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_marital, emm_compliance_marital) <span class="sc">%&gt;%</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Marital"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-3.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Job</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Job</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>emm_compliance_job <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"job"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>emm_attendance_job <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"job"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_job, emm_compliance_job) <span class="sc">%&gt;%</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Job"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-4.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Opioid</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Opioid</code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>emm_compliance_opioid <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"opioid"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>emm_attendance_opioid <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"opioid"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_opioid, emm_compliance_opioid) <span class="sc">%&gt;%</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"opioid"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-5.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">#test_predictions(beta_compliance_red, "marital") %&gt;%</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  kable() %&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  kable_styling()</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Race (compliance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Race (compliance alone)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"race"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-6.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Heroin (compliance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Heroin (compliance alone)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"heroin"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-7.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Speed (attendance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Speed (attendance alone)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"speed"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-8.png" class="img-fluid" width="2400"></p>
</div>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Is living stable (attendance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

### Is living stable (attendance alone)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"is_living_stable"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compliance-9.png" class="img-fluid" width="2400"></p>
</div>
</div>
</section>
<section id="conclusions" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> CONCLUSIONS</h1>
<p>Analyses of the data indicate that the age of the participant is the most important factor for both successful randomization and higher attendance/compliance, however the effects go in opposite directions:</p>
<ul>
<li><p>For randomization, the probability of enrollment is lower with increasing age.</p></li>
<li><p>Once randomized, the rates of attendance and compliance goe up with increasing age.</p></li>
</ul>
<p>For randomization, the other predictors are the total reported drugs and martial status, but in both cases missing is the most important factor – and there, lack of reported data (indicating unwillingness to participate by reporting data?) indicates lower probability of being randomized. The predictive power of this model is quite strong (AUC 0.8, linear calibration curve).</p>
<p>For compliance and attendance, the predictive power of models are lower. Age remains the most powerful predictor, while other predictors appear to be race, job, marital status, and heroin and opioid.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb131" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "R Medicine Opioid competition"</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Mitchell Maltenfort"</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="an">number-sections:</span><span class="co"> TRUE</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a><span class="an">fig-height:</span><span class="co"> 8</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="an">fig-width:</span><span class="co"> 8</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="an">fig-dpi:</span><span class="co"> 300</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="fu"># INTRODUCTION</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>This is my attempt at the analyses requested in <span class="ot">&lt;https://rconsortium.github.io/RMedicine_website/Competition.html&gt;</span>. I focused on identifying predictive factors associated with two questions.</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Of the potential patients providing data, what factors were associated with succesful randomization?</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Defining compliance as the % of potential study weeks where a patient showed up with a negative test, what factors were associated with higher compliance?</span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a><span class="co"># load data and packages</span></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(public.ctn0094data)</span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(public.ctn0094extra)</span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(pROC)</span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggeffects)</span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(kableExtra)</span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(broom)</span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(rms)</span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(betareg)</span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(scales)</span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(emmeans)</span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a><span class="fu"># SUCCESSFUL RANDOMIZATION</span></span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a>Of the patients listed in 'everybody' which ones are successfully randomized ('randomization')?</span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r randomization}</span></span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a><span class="co"># create wide table of drug usge</span></span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a>rbs_wide <span class="ot">&lt;-</span></span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a>  rbs <span class="sc">%&gt;%</span></span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(did_use <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="dv">1</span>, did_use <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(who, what, value) <span class="sc">%&gt;%</span></span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(everybody <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(who)) <span class="sc">%&gt;%</span></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(value) <span class="sc">~</span> <span class="dv">0</span>, <span class="cn">TRUE</span> <span class="sc">~</span> value)) <span class="sc">%&gt;%</span></span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> what, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_reported_drugs =</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed) <span class="sc">%&gt;%</span></span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">NA</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_reported_drugs =</span> <span class="fu">as.factor</span>(total_reported_drugs))</span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a>randomization_tbl <span class="ot">&lt;-</span></span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a>  demographics <span class="sc">%&gt;%</span></span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(randomization <span class="sc">%&gt;%</span> <span class="fu">filter</span>(which <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomization =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(which) <span class="sc">~</span> <span class="st">"0"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> which))) <span class="sc">%&gt;%</span></span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(rbs_wide) <span class="sc">%&gt;%</span></span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(job) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> job))) <span class="sc">%&gt;%</span></span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_living_stable =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(is_living_stable) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> is_living_stable))) <span class="sc">%&gt;%</span></span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">education =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(education) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> education))) <span class="sc">%&gt;%</span></span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">marital =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(marital) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> marital))) <span class="sc">%&gt;%</span></span>
<span id="cb131-61"><a href="#cb131-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job =</span> <span class="fu">fct_relevel</span>(job, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-62"><a href="#cb131-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_living_stable =</span> <span class="fu">fct_relevel</span>(is_living_stable, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-63"><a href="#cb131-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">education =</span> <span class="fu">fct_relevel</span>(education, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-64"><a href="#cb131-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">marital =</span> <span class="fu">fct_relevel</span>(marital, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-65"><a href="#cb131-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cocaine =</span> <span class="fu">as.factor</span>(cocaine), <span class="at">heroin =</span> <span class="fu">as.factor</span>(heroin), <span class="at">speedball =</span> <span class="fu">as.factor</span>(speedball), <span class="at">opioid =</span> <span class="fu">as.factor</span>(opioid), <span class="at">speed =</span> <span class="fu">as.factor</span>(speed)) <span class="sc">%&gt;%</span></span>
<span id="cb131-66"><a href="#cb131-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(everybody)</span>
<span id="cb131-67"><a href="#cb131-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-68"><a href="#cb131-68" aria-hidden="true" tabindex="-1"></a><span class="co"># use optimum penalty of 1 determined manually using 'pentrace'</span></span>
<span id="cb131-69"><a href="#cb131-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-70"><a href="#cb131-70" aria-hidden="true" tabindex="-1"></a>lrm_randomization <span class="ot">&lt;-</span></span>
<span id="cb131-71"><a href="#cb131-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrm</span>(randomization <span class="sc">~</span> <span class="fu">pol</span>(age, <span class="dv">2</span>) <span class="sc">+</span> job <span class="sc">+</span> education <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> total_reported_drugs <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid, randomization_tbl, <span class="at">x =</span> <span class="cn">TRUE</span>, <span class="at">y =</span> <span class="cn">TRUE</span>, <span class="at">penalty =</span> <span class="dv">1</span>)</span>
<span id="cb131-72"><a href="#cb131-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-73"><a href="#cb131-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-74"><a href="#cb131-74" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Use bootstrap validation to determine what values are persistent</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-75"><a href="#cb131-75" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-76"><a href="#cb131-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-77"><a href="#cb131-77" aria-hidden="true" tabindex="-1"></a>validate_randomization <span class="ot">&lt;-</span> <span class="fu">validate</span>(lrm_randomization, <span class="at">B =</span> <span class="dv">200</span>, <span class="at">bw =</span> <span class="cn">TRUE</span>)</span>
<span id="cb131-78"><a href="#cb131-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-79"><a href="#cb131-79" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">attr</span>(validate_randomization, <span class="st">"kept"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-80"><a href="#cb131-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-81"><a href="#cb131-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb131-82"><a href="#cb131-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-83"><a href="#cb131-83" aria-hidden="true" tabindex="-1"></a>lrm_final <span class="ot">&lt;-</span> <span class="fu">lrm</span>(randomization <span class="sc">~</span> <span class="fu">pol</span>(age, <span class="dv">2</span>) <span class="sc">+</span> marital <span class="sc">+</span> total_reported_drugs, randomization_tbl, <span class="at">x =</span> <span class="cn">TRUE</span>, <span class="at">y =</span> <span class="cn">TRUE</span>, <span class="at">penalty =</span> <span class="dv">1</span>)</span>
<span id="cb131-84"><a href="#cb131-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-85"><a href="#cb131-85" aria-hidden="true" tabindex="-1"></a>randomization_tbl<span class="sc">$</span>predict_randomization <span class="ot">&lt;-</span> <span class="fu">predict</span>(lrm_final, <span class="at">type =</span> <span class="st">"fitted"</span>)</span>
<span id="cb131-86"><a href="#cb131-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-87"><a href="#cb131-87" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Project 51 has almost perfect randomization compared to other two</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-88"><a href="#cb131-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-89"><a href="#cb131-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(lrm_final,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span>
<span id="cb131-90"><a href="#cb131-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-91"><a href="#cb131-91" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Use bootstrap validtion to determine what values are persistent</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-92"><a href="#cb131-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-93"><a href="#cb131-93" aria-hidden="true" tabindex="-1"></a>coef <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(lrm_final)</span>
<span id="cb131-94"><a href="#cb131-94" aria-hidden="true" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(lrm_final)))</span>
<span id="cb131-95"><a href="#cb131-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-96"><a href="#cb131-96" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Final logistic regression model predicting successful randomization (log-odds)</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-97"><a href="#cb131-97" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">(factor reference levels based on alphabetical order)</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-98"><a href="#cb131-98" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">term =</span> <span class="fu">names</span>(coef), coef, se) <span class="sc">%&gt;%</span></span>
<span id="cb131-99"><a href="#cb131-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">case_when</span>(coef <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">pnorm</span>(coef <span class="sc">/</span> se, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>), <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">pnorm</span>(coef <span class="sc">/</span> se, <span class="at">lower.tail =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb131-100"><a href="#cb131-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-101"><a href="#cb131-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-102"><a href="#cb131-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">4</span>, <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-103"><a href="#cb131-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Total Reported Drugs (reference level 0)"</span>, <span class="dv">7</span>, <span class="dv">11</span>)</span>
<span id="cb131-104"><a href="#cb131-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-105"><a href="#cb131-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-106"><a href="#cb131-106" aria-hidden="true" tabindex="-1"></a>calibrate_final <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(lrm_final, <span class="at">B =</span> <span class="dv">200</span>)</span>
<span id="cb131-107"><a href="#cb131-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-108"><a href="#cb131-108" aria-hidden="true" tabindex="-1"></a>calibrate_tbl <span class="ot">&lt;-</span></span>
<span id="cb131-109"><a href="#cb131-109" aria-hidden="true" tabindex="-1"></a>  calibrate_final[, <span class="fu">c</span>(<span class="st">"predy"</span>, <span class="st">"calibrated.orig"</span>, <span class="st">"calibrated.corrected"</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb131-110"><a href="#cb131-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-111"><a href="#cb131-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(calibrated.orig<span class="sc">:</span>calibrated.corrected)</span>
<span id="cb131-112"><a href="#cb131-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-113"><a href="#cb131-113" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Show calibration (predicted vs actual) for predictive model of randomization</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-114"><a href="#cb131-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-115"><a href="#cb131-115" aria-hidden="true" tabindex="-1"></a>calibrate_tbl <span class="sc">%&gt;%</span></span>
<span id="cb131-116"><a href="#cb131-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> predy, <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb131-117"><a href="#cb131-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb131-118"><a href="#cb131-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb131-119"><a href="#cb131-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"calibration"</span>, <span class="at">x =</span> <span class="st">"Predicted Probability"</span>, <span class="at">y =</span> <span class="st">"Actual Probability"</span>) <span class="sc">+</span></span>
<span id="cb131-120"><a href="#cb131-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb131-121"><a href="#cb131-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">linetype =</span> <span class="st">"dashed"</span>)</span>
<span id="cb131-122"><a href="#cb131-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-123"><a href="#cb131-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-124"><a href="#cb131-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-125"><a href="#cb131-125" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">&lt;-</span> <span class="fu">ci.auc</span>(<span class="fu">roc</span>(randomization <span class="sc">~</span> predict_randomization, <span class="at">data =</span> randomization_tbl <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(predict_randomization))))</span>
<span id="cb131-126"><a href="#cb131-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-127"><a href="#cb131-127" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## ROC curve AUC is %0.2f (95 percent CI %0.2f - %0.2f), </span><span class="sc">\n\n</span><span class="st">"</span>, auc[<span class="dv">2</span>], auc[<span class="dv">1</span>], auc[<span class="dv">3</span>]))</span>
<span id="cb131-128"><a href="#cb131-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-129"><a href="#cb131-129" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">roc</span>(randomization <span class="sc">~</span> predict_randomization, <span class="at">data =</span> randomization_tbl <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(predict_randomization))))</span>
<span id="cb131-130"><a href="#cb131-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-131"><a href="#cb131-131" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-132"><a href="#cb131-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-133"><a href="#cb131-133" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Estimated marginal means</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-134"><a href="#cb131-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-135"><a href="#cb131-135" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Marital</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-136"><a href="#cb131-136" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"marital"</span>))</span>
<span id="cb131-137"><a href="#cb131-137" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-138"><a href="#cb131-138" aria-hidden="true" tabindex="-1"></a><span class="fu">test_predictions</span>(lrm_final, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-139"><a href="#cb131-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-140"><a href="#cb131-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb131-141"><a href="#cb131-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-142"><a href="#cb131-142" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Total reported drugs</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-143"><a href="#cb131-143" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"total_reported_drugs"</span>))</span>
<span id="cb131-144"><a href="#cb131-144" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-145"><a href="#cb131-145" aria-hidden="true" tabindex="-1"></a><span class="fu">test_predictions</span>(lrm_final, <span class="st">"total_reported_drugs"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-146"><a href="#cb131-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-147"><a href="#cb131-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb131-148"><a href="#cb131-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-149"><a href="#cb131-149" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-150"><a href="#cb131-150" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"age[all]"</span>))</span>
<span id="cb131-151"><a href="#cb131-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb131-152"><a href="#cb131-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-153"><a href="#cb131-153" aria-hidden="true" tabindex="-1"></a><span class="fu"># ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION</span></span>
<span id="cb131-154"><a href="#cb131-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-155"><a href="#cb131-155" aria-hidden="true" tabindex="-1"></a>This adapts the code from 'public.ctn0094extra' vignette to summarise substance use across weeks.</span>
<span id="cb131-156"><a href="#cb131-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-157"><a href="#cb131-157" aria-hidden="true" tabindex="-1"></a>I define compliance as how many times the patient showed up with a negative UDS report, divided by the length of time in the study (Study Week + 1 for Baseline). Attendance is how many times the patient showed up with a report (positive or negative), divided by length of time in the study.</span>
<span id="cb131-158"><a href="#cb131-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-159"><a href="#cb131-159" aria-hidden="true" tabindex="-1"></a>Beta regression is used to create a parsimonious model, pruned "by hand" to get rid of irrelevant predictors. The correlation coefficients for these models are not good (R-squared <span class="sc">\&lt;</span> 0.03) but there may be some insight into how to get better attendance or compliance for patients</span>
<span id="cb131-160"><a href="#cb131-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-161"><a href="#cb131-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compliance}</span></span>
<span id="cb131-162"><a href="#cb131-162" aria-hidden="true" tabindex="-1"></a>data_ls <span class="ot">&lt;-</span> <span class="fu">loadRawData</span>(<span class="fu">c</span>(<span class="st">"randomization"</span>, <span class="st">"treatment"</span>))</span>
<span id="cb131-163"><a href="#cb131-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-164"><a href="#cb131-164" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>randomization <span class="ot">&lt;-</span></span>
<span id="cb131-165"><a href="#cb131-165" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb131-166"><a href="#cb131-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, treatment, <span class="at">randomized =</span> which) <span class="sc">%&gt;%</span></span>
<span id="cb131-167"><a href="#cb131-167" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove second randomization events</span></span>
<span id="cb131-168"><a href="#cb131-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized <span class="sc">!=</span> <span class="dv">2</span>)</span>
<span id="cb131-169"><a href="#cb131-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-170"><a href="#cb131-170" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>treatment <span class="ot">&lt;-</span></span>
<span id="cb131-171"><a href="#cb131-171" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>treatment</span>
<span id="cb131-172"><a href="#cb131-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-173"><a href="#cb131-173" aria-hidden="true" tabindex="-1"></a>start_int <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">27</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span>30L, <span class="st">`</span><span class="at">51</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span>30L)</span>
<span id="cb131-174"><a href="#cb131-174" aria-hidden="true" tabindex="-1"></a>end_int <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">27</span><span class="st">`</span> <span class="ot">=</span> 168L, <span class="st">`</span><span class="at">51</span><span class="st">`</span> <span class="ot">=</span> 168L)</span>
<span id="cb131-175"><a href="#cb131-175" aria-hidden="true" tabindex="-1"></a>backbone2751_df <span class="ot">&lt;-</span></span>
<span id="cb131-176"><a href="#cb131-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CreateProtocolHistory</span>(</span>
<span id="cb131-177"><a href="#cb131-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_vec =</span> start_int,</span>
<span id="cb131-178"><a href="#cb131-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_vec =</span> end_int</span>
<span id="cb131-179"><a href="#cb131-179" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb131-180"><a href="#cb131-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-181"><a href="#cb131-181" aria-hidden="true" tabindex="-1"></a>backbone30_df <span class="ot">&lt;-</span></span>
<span id="cb131-182"><a href="#cb131-182" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb131-183"><a href="#cb131-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-184"><a href="#cb131-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(project <span class="sc">==</span> <span class="st">"30"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-185"><a href="#cb131-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CreateCTN30ProtocolHistory</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-186"><a href="#cb131-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">project =</span> <span class="st">"30"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-187"><a href="#cb131-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, project, when)</span>
<span id="cb131-188"><a href="#cb131-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-189"><a href="#cb131-189" aria-hidden="true" tabindex="-1"></a>backbone_df <span class="ot">&lt;-</span></span>
<span id="cb131-190"><a href="#cb131-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(backbone2751_df, backbone30_df) <span class="sc">%&gt;%</span></span>
<span id="cb131-191"><a href="#cb131-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(who)</span>
<span id="cb131-192"><a href="#cb131-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-193"><a href="#cb131-193" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(backbone2751_df, backbone30_df, start_int, end_int)</span>
<span id="cb131-194"><a href="#cb131-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-195"><a href="#cb131-195" aria-hidden="true" tabindex="-1"></a>data_ls <span class="ot">&lt;-</span> <span class="fu">loadRawData</span>(<span class="fu">c</span>(<span class="st">"randomization"</span>, <span class="st">"visit"</span>))</span>
<span id="cb131-196"><a href="#cb131-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-197"><a href="#cb131-197" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>randomization <span class="ot">&lt;-</span></span>
<span id="cb131-198"><a href="#cb131-198" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb131-199"><a href="#cb131-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, treatment, <span class="at">randomized =</span> which) <span class="sc">%&gt;%</span></span>
<span id="cb131-200"><a href="#cb131-200" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove second randomization events</span></span>
<span id="cb131-201"><a href="#cb131-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized <span class="sc">!=</span> <span class="dv">2</span>)</span>
<span id="cb131-202"><a href="#cb131-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-203"><a href="#cb131-203" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>visit <span class="ot">&lt;-</span></span>
<span id="cb131-204"><a href="#cb131-204" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>visit</span>
<span id="cb131-205"><a href="#cb131-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-206"><a href="#cb131-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-207"><a href="#cb131-207" aria-hidden="true" tabindex="-1"></a>timelineRand1_df <span class="ot">&lt;-</span></span>
<span id="cb131-208"><a href="#cb131-208" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb131-209"><a href="#cb131-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomized =</span> randomized <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-210"><a href="#cb131-210" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join to backbone and arrange within subject by day</span></span>
<span id="cb131-211"><a href="#cb131-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(backbone_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-212"><a href="#cb131-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb131-213"><a href="#cb131-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(when, <span class="at">.by_group =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-214"><a href="#cb131-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, project, when, randomized)</span>
<span id="cb131-215"><a href="#cb131-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-216"><a href="#cb131-216" aria-hidden="true" tabindex="-1"></a>timelineVisit1_df <span class="ot">&lt;-</span></span>
<span id="cb131-217"><a href="#cb131-217" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>visit <span class="sc">%&gt;%</span></span>
<span id="cb131-218"><a href="#cb131-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visit, <span class="at">status =</span> what) <span class="sc">%&gt;%</span></span>
<span id="cb131-219"><a href="#cb131-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"visit"</span>, <span class="st">"final"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-220"><a href="#cb131-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-221"><a href="#cb131-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visit) <span class="sc">%&gt;%</span></span>
<span id="cb131-222"><a href="#cb131-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(timelineRand1_df, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-223"><a href="#cb131-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb131-224"><a href="#cb131-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-225"><a href="#cb131-225" aria-hidden="true" tabindex="-1"></a>timelineMissing1_df <span class="ot">&lt;-</span> <span class="fu">MarkMissing</span>(timelineVisit1_df)</span>
<span id="cb131-226"><a href="#cb131-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-227"><a href="#cb131-227" aria-hidden="true" tabindex="-1"></a>derived_visitImputed <span class="ot">&lt;-</span></span>
<span id="cb131-228"><a href="#cb131-228" aria-hidden="true" tabindex="-1"></a>  timelineMissing1_df <span class="sc">%&gt;%</span></span>
<span id="cb131-229"><a href="#cb131-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visit =</span> <span class="fu">as.character</span>(visit)) <span class="sc">%&gt;%</span></span>
<span id="cb131-230"><a href="#cb131-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">visit =</span> <span class="st">""</span>, <span class="at">visitYM =</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-231"><a href="#cb131-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visitImputed =</span> <span class="fu">paste0</span>(visit, visitYM)) <span class="sc">%&gt;%</span></span>
<span id="cb131-232"><a href="#cb131-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-233"><a href="#cb131-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">visitImputed =</span> <span class="fu">str_replace</span>(</span>
<span id="cb131-234"><a href="#cb131-234" aria-hidden="true" tabindex="-1"></a>      visitImputed,</span>
<span id="cb131-235"><a href="#cb131-235" aria-hidden="true" tabindex="-1"></a>      <span class="at">pattern =</span> <span class="st">"TRUETRUE"</span>, <span class="at">replacement =</span> <span class="st">"Present"</span></span>
<span id="cb131-236"><a href="#cb131-236" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb131-237"><a href="#cb131-237" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-238"><a href="#cb131-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visitImputed) <span class="sc">%&gt;%</span></span>
<span id="cb131-239"><a href="#cb131-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(visitImputed <span class="sc">!=</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-240"><a href="#cb131-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb131-241"><a href="#cb131-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-242"><a href="#cb131-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-243"><a href="#cb131-243" aria-hidden="true" tabindex="-1"></a>randomized_df <span class="ot">&lt;-</span></span>
<span id="cb131-244"><a href="#cb131-244" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb131-245"><a href="#cb131-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomized =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(which))) <span class="sc">%&gt;%</span></span>
<span id="cb131-246"><a href="#cb131-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, randomized) <span class="sc">%&gt;%</span></span>
<span id="cb131-247"><a href="#cb131-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-248"><a href="#cb131-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> project <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"27"</span>, <span class="st">"51"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb131-249"><a href="#cb131-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>project)</span>
<span id="cb131-250"><a href="#cb131-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-251"><a href="#cb131-251" aria-hidden="true" tabindex="-1"></a>udsUse2_df <span class="ot">&lt;-</span></span>
<span id="cb131-252"><a href="#cb131-252" aria-hidden="true" tabindex="-1"></a>  backbone_df <span class="sc">%&gt;%</span></span>
<span id="cb131-253"><a href="#cb131-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(randomized_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-254"><a href="#cb131-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(derived_visitImputed, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-255"><a href="#cb131-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(uds, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-256"><a href="#cb131-256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So we can use MarkUse() with UDS data (instead of all_drugs)</span></span>
<span id="cb131-257"><a href="#cb131-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"UDS"</span>)</span>
<span id="cb131-258"><a href="#cb131-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-259"><a href="#cb131-259" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(</span>
<span id="cb131-260"><a href="#cb131-260" aria-hidden="true" tabindex="-1"></a>  backbone_df, data_ls, timelineMissing1_df, timelineRand1_df, timelineVisit1_df</span>
<span id="cb131-261"><a href="#cb131-261" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb131-262"><a href="#cb131-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-263"><a href="#cb131-263" aria-hidden="true" tabindex="-1"></a>nonStudyOpioids_ls <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb131-264"><a href="#cb131-264" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Buprenorphine"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>),</span>
<span id="cb131-265"><a href="#cb131-265" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Methadone"</span>     <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Buprenorphine"</span>),</span>
<span id="cb131-266"><a href="#cb131-266" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Naltrexone"</span>    <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>, <span class="st">"Buprenorphine"</span>),</span>
<span id="cb131-267"><a href="#cb131-267" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Not treated"</span>   <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>, <span class="st">"Buprenorphine"</span>)</span>
<span id="cb131-268"><a href="#cb131-268" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb131-269"><a href="#cb131-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-270"><a href="#cb131-270" aria-hidden="true" tabindex="-1"></a>treatGroups_ls <span class="ot">&lt;-</span></span>
<span id="cb131-271"><a href="#cb131-271" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb131-272"><a href="#cb131-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(which <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-273"><a href="#cb131-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-274"><a href="#cb131-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, treatment) <span class="sc">%&gt;%</span></span>
<span id="cb131-275"><a href="#cb131-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-276"><a href="#cb131-276" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_drug =</span> <span class="fu">case_when</span>(</span>
<span id="cb131-277"><a href="#cb131-277" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(treatment, <span class="st">"BUP"</span>) <span class="sc">~</span> <span class="st">"Buprenorphine"</span>,</span>
<span id="cb131-278"><a href="#cb131-278" aria-hidden="true" tabindex="-1"></a>      treatment <span class="sc">==</span> <span class="st">"Methadone"</span> <span class="sc">~</span> <span class="st">"Methadone"</span>,</span>
<span id="cb131-279"><a href="#cb131-279" aria-hidden="true" tabindex="-1"></a>      treatment <span class="sc">==</span> <span class="st">"Inpatient NR-NTX"</span> <span class="sc">~</span> <span class="st">"Naltrexone"</span></span>
<span id="cb131-280"><a href="#cb131-280" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb131-281"><a href="#cb131-281" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-282"><a href="#cb131-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>treatment) <span class="sc">%&gt;%</span></span>
<span id="cb131-283"><a href="#cb131-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="at">f =</span> .<span class="sc">$</span>treat_drug) <span class="sc">%&gt;%</span></span>
<span id="cb131-284"><a href="#cb131-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="st">"who"</span>)</span>
<span id="cb131-285"><a href="#cb131-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-286"><a href="#cb131-286" aria-hidden="true" tabindex="-1"></a>opioidUse_df <span class="ot">&lt;-</span></span>
<span id="cb131-287"><a href="#cb131-287" aria-hidden="true" tabindex="-1"></a>  udsUse2_df <span class="sc">%&gt;%</span></span>
<span id="cb131-288"><a href="#cb131-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-289"><a href="#cb131-289" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb131-290"><a href="#cb131-290" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Buprenorphine <span class="sc">~</span> <span class="st">"Buprenorphine"</span>,</span>
<span id="cb131-291"><a href="#cb131-291" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Methadone <span class="sc">~</span> <span class="st">"Methadone"</span>,</span>
<span id="cb131-292"><a href="#cb131-292" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Naltrexone <span class="sc">~</span> <span class="st">"Naltrexone"</span>,</span>
<span id="cb131-293"><a href="#cb131-293" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Not treated"</span></span>
<span id="cb131-294"><a href="#cb131-294" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb131-295"><a href="#cb131-295" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-296"><a href="#cb131-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="at">f =</span> .<span class="sc">$</span>treat_group) <span class="sc">%&gt;%</span></span>
<span id="cb131-297"><a href="#cb131-297" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of data in alphabetical order, so the non-study drugs ls should match</span></span>
<span id="cb131-298"><a href="#cb131-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map2</span>(</span>
<span id="cb131-299"><a href="#cb131-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">.y =</span> nonStudyOpioids_ls,</span>
<span id="cb131-300"><a href="#cb131-300" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb131-301"><a href="#cb131-301" aria-hidden="true" tabindex="-1"></a>      <span class="co"># REQUIRES "source" COLUMN</span></span>
<span id="cb131-302"><a href="#cb131-302" aria-hidden="true" tabindex="-1"></a>      <span class="fu">MarkUse</span>(</span>
<span id="cb131-303"><a href="#cb131-303" aria-hidden="true" tabindex="-1"></a>        <span class="at">targetDrugs_char =</span> .y,</span>
<span id="cb131-304"><a href="#cb131-304" aria-hidden="true" tabindex="-1"></a>        <span class="at">drugs_df =</span> .x,</span>
<span id="cb131-305"><a href="#cb131-305" aria-hidden="true" tabindex="-1"></a>        <span class="co"># because we have participants with no recorded UDS; in practice DO NOT</span></span>
<span id="cb131-306"><a href="#cb131-306" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   use this command</span></span>
<span id="cb131-307"><a href="#cb131-307" aria-hidden="true" tabindex="-1"></a>        <span class="at">retainEmptyRows =</span> <span class="cn">TRUE</span></span>
<span id="cb131-308"><a href="#cb131-308" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb131-309"><a href="#cb131-309" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb131-310"><a href="#cb131-310" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-311"><a href="#cb131-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-312"><a href="#cb131-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-313"><a href="#cb131-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">udsOpioid =</span> <span class="fu">case_when</span>(</span>
<span id="cb131-314"><a href="#cb131-314" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(when) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb131-315"><a href="#cb131-315" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(when) <span class="sc">~</span> <span class="cn">TRUE</span></span>
<span id="cb131-316"><a href="#cb131-316" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb131-317"><a href="#cb131-317" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-318"><a href="#cb131-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, udsOpioid)</span>
<span id="cb131-319"><a href="#cb131-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-320"><a href="#cb131-320" aria-hidden="true" tabindex="-1"></a>timelineUDS_df <span class="ot">&lt;-</span></span>
<span id="cb131-321"><a href="#cb131-321" aria-hidden="true" tabindex="-1"></a>  udsUse2_df <span class="sc">%&gt;%</span></span>
<span id="cb131-322"><a href="#cb131-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(opioidUse_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-323"><a href="#cb131-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>what, <span class="sc">-</span>source) <span class="sc">%&gt;%</span></span>
<span id="cb131-324"><a href="#cb131-324" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2,089 rows to 1,994</span></span>
<span id="cb131-325"><a href="#cb131-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb131-326"><a href="#cb131-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-327"><a href="#cb131-327" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(</span>
<span id="cb131-328"><a href="#cb131-328" aria-hidden="true" tabindex="-1"></a>  derived_visitImputed, opioidUse_df, randomized_df, treatGroups_ls, udsUse2_df</span>
<span id="cb131-329"><a href="#cb131-329" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb131-330"><a href="#cb131-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-331"><a href="#cb131-331" aria-hidden="true" tabindex="-1"></a>wasRandomized_int <span class="ot">&lt;-</span></span>
<span id="cb131-332"><a href="#cb131-332" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb131-333"><a href="#cb131-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb131-334"><a href="#cb131-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">randomized =</span> <span class="fu">any</span>(randomized <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-335"><a href="#cb131-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized) <span class="sc">%&gt;%</span></span>
<span id="cb131-336"><a href="#cb131-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(who)</span>
<span id="cb131-337"><a href="#cb131-337" aria-hidden="true" tabindex="-1"></a>notRandomized_int <span class="ot">&lt;-</span></span>
<span id="cb131-338"><a href="#cb131-338" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb131-339"><a href="#cb131-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(who <span class="sc">%in%</span> wasRandomized_int)) <span class="sc">%&gt;%</span></span>
<span id="cb131-340"><a href="#cb131-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb131-341"><a href="#cb131-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb131-342"><a href="#cb131-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-343"><a href="#cb131-343" aria-hidden="true" tabindex="-1"></a>timelineUDS2_df <span class="ot">&lt;-</span></span>
<span id="cb131-344"><a href="#cb131-344" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb131-345"><a href="#cb131-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(who <span class="sc">%in%</span> wasRandomized_int) <span class="sc">%&gt;%</span></span>
<span id="cb131-346"><a href="#cb131-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb131-347"><a href="#cb131-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(randomized)) <span class="sc">%&gt;%</span></span>
<span id="cb131-348"><a href="#cb131-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-349"><a href="#cb131-349" aria-hidden="true" tabindex="-1"></a>    <span class="at">whenRandomized1 =</span> <span class="fu">case_when</span>(randomized <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> when),</span>
<span id="cb131-350"><a href="#cb131-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">whenRandomized2 =</span> <span class="fu">case_when</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> when)</span>
<span id="cb131-351"><a href="#cb131-351" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-352"><a href="#cb131-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, whenRandomized1, whenRandomized2) <span class="sc">%&gt;%</span></span>
<span id="cb131-353"><a href="#cb131-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(timelineUDS_df, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb131-354"><a href="#cb131-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(who <span class="sc">%in%</span> wasRandomized_int) <span class="sc">%&gt;%</span></span>
<span id="cb131-355"><a href="#cb131-355" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add back in the groupings BEFORE the fill()</span></span>
<span id="cb131-356"><a href="#cb131-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb131-357"><a href="#cb131-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(whenRandomized1, <span class="at">.direction =</span> <span class="st">"updown"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-358"><a href="#cb131-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(whenRandomized2, <span class="at">.direction =</span> <span class="st">"updown"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-359"><a href="#cb131-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">daysSinceRand1 =</span> when <span class="sc">-</span> whenRandomized1) <span class="sc">%&gt;%</span></span>
<span id="cb131-360"><a href="#cb131-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">daysSinceRand2 =</span> when <span class="sc">-</span> whenRandomized2) <span class="sc">%&gt;%</span></span>
<span id="cb131-361"><a href="#cb131-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>whenRandomized1, <span class="sc">-</span>whenRandomized2)</span>
<span id="cb131-362"><a href="#cb131-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-363"><a href="#cb131-363" aria-hidden="true" tabindex="-1"></a>weeklyUse_df <span class="ot">&lt;-</span></span>
<span id="cb131-364"><a href="#cb131-364" aria-hidden="true" tabindex="-1"></a>  timelineUDS2_df <span class="sc">%&gt;%</span></span>
<span id="cb131-365"><a href="#cb131-365" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The (daysSinceRand1 - 1) adjustment is to ensure that the first study week</span></span>
<span id="cb131-366"><a href="#cb131-366" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   is a full 7 days, since "day 0" is the day before randomization. The "+1"</span></span>
<span id="cb131-367"><a href="#cb131-367" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   at the end is to shift the study week label such that "week 0" is the</span></span>
<span id="cb131-368"><a href="#cb131-368" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   week *BEFORE* treatment, rather than the first week of treatment. So, the</span></span>
<span id="cb131-369"><a href="#cb131-369" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   randomization day is the last day of "week 0" (the pre-treatment period).</span></span>
<span id="cb131-370"><a href="#cb131-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">studyWeek1 =</span> (daysSinceRand1 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> <span class="dv">7</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-371"><a href="#cb131-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">studyWeek2 =</span> (daysSinceRand2 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> <span class="dv">7</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-372"><a href="#cb131-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who, studyWeek1) <span class="sc">%&gt;%</span></span>
<span id="cb131-373"><a href="#cb131-373" aria-hidden="true" tabindex="-1"></a>  <span class="co"># There are some study weeks with multiple UDS, so we count the number of</span></span>
<span id="cb131-374"><a href="#cb131-374" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   positive and negative UDS per week.</span></span>
<span id="cb131-375"><a href="#cb131-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb131-376"><a href="#cb131-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">nPosUDS  =</span> <span class="fu">sum</span>(udsOpioid <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb131-377"><a href="#cb131-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">nNegUDS  =</span> <span class="fu">sum</span>(visitImputed <span class="sc">==</span> <span class="st">"Present"</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(udsOpioid), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb131-378"><a href="#cb131-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">nMissing =</span> <span class="fu">sum</span>(visitImputed <span class="sc">==</span> <span class="st">"Missing"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb131-379"><a href="#cb131-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">randWk1  =</span> <span class="fu">sum</span>(randomized <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb131-380"><a href="#cb131-380" aria-hidden="true" tabindex="-1"></a>    <span class="at">randWk2  =</span> <span class="fu">sum</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> project <span class="sc">==</span> <span class="st">"30"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb131-381"><a href="#cb131-381" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-382"><a href="#cb131-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb131-383"><a href="#cb131-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-384"><a href="#cb131-384" aria-hidden="true" tabindex="-1"></a>useByWeekRandomized_df <span class="ot">&lt;-</span></span>
<span id="cb131-385"><a href="#cb131-385" aria-hidden="true" tabindex="-1"></a>  weeklyUse_df <span class="sc">%&gt;%</span></span>
<span id="cb131-386"><a href="#cb131-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-387"><a href="#cb131-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">udsStatus =</span> <span class="fu">case_when</span>(</span>
<span id="cb131-388"><a href="#cb131-388" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see a positive UDS and no negative UDS, it's positive</span></span>
<span id="cb131-389"><a href="#cb131-389" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"+"</span>,</span>
<span id="cb131-390"><a href="#cb131-390" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see a negative UDS and no positive UDS, it's negative</span></span>
<span id="cb131-391"><a href="#cb131-391" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"-"</span>,</span>
<span id="cb131-392"><a href="#cb131-392" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see both positive and negative UDS in a single week, it's both</span></span>
<span id="cb131-393"><a href="#cb131-393" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   (note that we can recode all "B"s to be "+" as necessary)</span></span>
<span id="cb131-394"><a href="#cb131-394" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"*"</span>,</span>
<span id="cb131-395"><a href="#cb131-395" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we don't have any UDS in a week after randomization, it's missing</span></span>
<span id="cb131-396"><a href="#cb131-396" aria-hidden="true" tabindex="-1"></a>      <span class="co"># UPDATE 2022-03-08: I had this as a 0 originally, and I was using this</span></span>
<span id="cb131-397"><a href="#cb131-397" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   in context of consent, not randomization. This was wrong.</span></span>
<span id="cb131-398"><a href="#cb131-398" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> studyWeek1 <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"o"</span>,</span>
<span id="cb131-399"><a href="#cb131-399" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If none of the above are true, but we still have a missing value as</span></span>
<span id="cb131-400"><a href="#cb131-400" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   marked by the MarkMissing() function, then it's missing</span></span>
<span id="cb131-401"><a href="#cb131-401" aria-hidden="true" tabindex="-1"></a>      nMissing <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"o"</span>,</span>
<span id="cb131-402"><a href="#cb131-402" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If none of the above conditions are true (probably because it's a week</span></span>
<span id="cb131-403"><a href="#cb131-403" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   before randomization but not during a baseline visit for consent),</span></span>
<span id="cb131-404"><a href="#cb131-404" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   then leave it blank (pre-study)</span></span>
<span id="cb131-405"><a href="#cb131-405" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"_"</span></span>
<span id="cb131-406"><a href="#cb131-406" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb131-407"><a href="#cb131-407" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-408"><a href="#cb131-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb131-409"><a href="#cb131-409" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For CTN-0030, Phase II could have started on any day of the week, even in</span></span>
<span id="cb131-410"><a href="#cb131-410" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   the middle of a treatment week. If we try to start counting Phase II</span></span>
<span id="cb131-411"><a href="#cb131-411" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   weeks the day after treatment arms are switched, we can end up with the</span></span>
<span id="cb131-412"><a href="#cb131-412" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   last "week" of Phase I not having 7 days. I'm going to leave the first</span></span>
<span id="cb131-413"><a href="#cb131-413" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   week of Phase II as whatever week the switch happened in.</span></span>
<span id="cb131-414"><a href="#cb131-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-415"><a href="#cb131-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">rand1Active =</span> studyWeek1 <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb131-416"><a href="#cb131-416" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This returns 0 for any week before the Phase II randomization, and 1 for</span></span>
<span id="cb131-417"><a href="#cb131-417" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   the Phase II randomization week and all subsequent weeks (because the</span></span>
<span id="cb131-418"><a href="#cb131-418" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   randWk2 column is 1 only for the week of second randomization and 0</span></span>
<span id="cb131-419"><a href="#cb131-419" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   all other rows).</span></span>
<span id="cb131-420"><a href="#cb131-420" aria-hidden="true" tabindex="-1"></a>    <span class="at">rand2Active =</span> <span class="fu">cumsum</span>(randWk2),</span>
<span id="cb131-421"><a href="#cb131-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">trialPhase  =</span> rand1Active <span class="sc">+</span> rand2Active</span>
<span id="cb131-422"><a href="#cb131-422" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb131-423"><a href="#cb131-423" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb131-424"><a href="#cb131-424" aria-hidden="true" tabindex="-1"></a>    who,</span>
<span id="cb131-425"><a href="#cb131-425" aria-hidden="true" tabindex="-1"></a>    <span class="at">studyWeek =</span> studyWeek1, randWk1, randWk2, udsStatus, trialPhase</span>
<span id="cb131-426"><a href="#cb131-426" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb131-427"><a href="#cb131-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-428"><a href="#cb131-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-429"><a href="#cb131-429" aria-hidden="true" tabindex="-1"></a><span class="do">#### NEW</span></span>
<span id="cb131-430"><a href="#cb131-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-431"><a href="#cb131-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-432"><a href="#cb131-432" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="ot">&lt;-</span></span>
<span id="cb131-433"><a href="#cb131-433" aria-hidden="true" tabindex="-1"></a>  useByWeekRandomized_df <span class="sc">%&gt;%</span></span>
<span id="cb131-434"><a href="#cb131-434" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(trialPhase <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-435"><a href="#cb131-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(studyWeek <span class="sc">&gt;=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-436"><a href="#cb131-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(everybody) <span class="sc">%&gt;%</span></span>
<span id="cb131-437"><a href="#cb131-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(project, who) <span class="sc">%&gt;%</span></span>
<span id="cb131-438"><a href="#cb131-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">sum_pos =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"+"</span>), <span class="at">sum_neg =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"-"</span>), <span class="at">sumMissing =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"o"</span>), <span class="at">total_weeks =</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">max</span>(studyWeek)) <span class="sc">%&gt;%</span></span>
<span id="cb131-439"><a href="#cb131-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">compliance =</span> sum_neg <span class="sc">/</span> total_weeks, <span class="at">attendance =</span> (sum_neg<span class="sc">+</span>sum_pos)<span class="sc">/</span>total_weeks) <span class="sc">%&gt;%</span></span>
<span id="cb131-440"><a href="#cb131-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(randomization_tbl <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(who, age, is_hispanic, race, job, education, is_living_stable, marital, is_male, cocaine<span class="sc">:</span>total_reported_drugs, predict_randomization)) <span class="sc">%&gt;%</span></span>
<span id="cb131-441"><a href="#cb131-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">project=</span><span class="fu">as.factor</span>(project))</span>
<span id="cb131-442"><a href="#cb131-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-443"><a href="#cb131-443" aria-hidden="true" tabindex="-1"></a><span class="co"># from https://stats.stackexchange.com/questions/31300/dealing-with-0-1-values-in-a-beta-regression</span></span>
<span id="cb131-444"><a href="#cb131-444" aria-hidden="true" tabindex="-1"></a><span class="co"># squeeze 0 and 1 so can use beta regression</span></span>
<span id="cb131-445"><a href="#cb131-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-446"><a href="#cb131-446" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">dim</span>(compliance_results)[<span class="dv">1</span>]</span>
<span id="cb131-447"><a href="#cb131-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-448"><a href="#cb131-448" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="ot">&lt;-</span> <span class="fu">mutate</span>(compliance_results, <span class="at">squeeze_compliance =</span> (compliance <span class="sc">*</span> (N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">/</span> N, <span class="at">squeeze_attendance =</span> (attendance <span class="sc">*</span> (N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">/</span> N)</span>
<span id="cb131-449"><a href="#cb131-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-450"><a href="#cb131-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-451"><a href="#cb131-451" aria-hidden="true" tabindex="-1"></a>beta_compliance <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_compliance <span class="sc">~</span> age <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span>
<span id="cb131-452"><a href="#cb131-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-453"><a href="#cb131-453" aria-hidden="true" tabindex="-1"></a>beta_compliance_red <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_compliance <span class="sc">~</span> age <span class="sc">+</span> race <span class="sc">+</span> job <span class="sc">+</span> marital <span class="sc">+</span> heroin <span class="sc">+</span> opioid, compliance_results)</span>
<span id="cb131-454"><a href="#cb131-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-455"><a href="#cb131-455" aria-hidden="true" tabindex="-1"></a>beta_attendance <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_attendance <span class="sc">~</span> age <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span>
<span id="cb131-456"><a href="#cb131-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-457"><a href="#cb131-457" aria-hidden="true" tabindex="-1"></a>beta_attendance_red <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_attendance <span class="sc">~</span> age   <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span>
<span id="cb131-458"><a href="#cb131-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-459"><a href="#cb131-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-460"><a href="#cb131-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-461"><a href="#cb131-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-462"><a href="#cb131-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-463"><a href="#cb131-463" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Beta regression coefficients (factor reference levels based on alphabetical order)</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-464"><a href="#cb131-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-465"><a href="#cb131-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-466"><a href="#cb131-466" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Compliance</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-467"><a href="#cb131-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-468"><a href="#cb131-468" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(beta_compliance_red) <span class="sc">%&gt;%</span></span>
<span id="cb131-469"><a href="#cb131-469" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>statistic) <span class="sc">%&gt;%</span></span>
<span id="cb131-470"><a href="#cb131-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-471"><a href="#cb131-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-472"><a href="#cb131-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Race (reference level Black)"</span>, <span class="dv">3</span>, <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-473"><a href="#cb131-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"job (reference level Full Time)"</span>, <span class="dv">6</span>, <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-474"><a href="#cb131-474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">11</span>, <span class="dv">13</span>)</span>
<span id="cb131-475"><a href="#cb131-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-476"><a href="#cb131-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-477"><a href="#cb131-477" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### No major difference between Projects</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-478"><a href="#cb131-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-479"><a href="#cb131-479" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">Update models by adding project and look for marginal means between projects</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-480"><a href="#cb131-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-481"><a href="#cb131-481" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">#### Compliance</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-482"><a href="#cb131-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-483"><a href="#cb131-483" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(beta_compliance_red,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span>
<span id="cb131-484"><a href="#cb131-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-485"><a href="#cb131-485" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">#### Attendance</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-486"><a href="#cb131-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-487"><a href="#cb131-487" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(beta_attendance_red,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span>
<span id="cb131-488"><a href="#cb131-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-489"><a href="#cb131-489" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Attendance</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-490"><a href="#cb131-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-491"><a href="#cb131-491" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(beta_attendance_red) <span class="sc">%&gt;%</span></span>
<span id="cb131-492"><a href="#cb131-492" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>statistic) <span class="sc">%&gt;%</span></span>
<span id="cb131-493"><a href="#cb131-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-494"><a href="#cb131-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-495"><a href="#cb131-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Job (reference level Full Time)"</span>, <span class="dv">3</span>, <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-496"><a href="#cb131-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Is living stable (reference level No)"</span>, <span class="dv">8</span>, <span class="dv">9</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-497"><a href="#cb131-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">10</span>, <span class="dv">12</span>)</span>
<span id="cb131-498"><a href="#cb131-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-499"><a href="#cb131-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-500"><a href="#cb131-500" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Estimated marginal means</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-501"><a href="#cb131-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-502"><a href="#cb131-502" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-503"><a href="#cb131-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-504"><a href="#cb131-504" aria-hidden="true" tabindex="-1"></a>emm_compliance_age <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"age"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>)</span>
<span id="cb131-505"><a href="#cb131-505" aria-hidden="true" tabindex="-1"></a>emm_attendance_age <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"age"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)</span>
<span id="cb131-506"><a href="#cb131-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-507"><a href="#cb131-507" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_age, emm_compliance_age) <span class="sc">%&gt;%</span></span>
<span id="cb131-508"><a href="#cb131-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>predicted, <span class="at">ymax=</span>conf.high, <span class="at">ymin=</span>conf.low, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_smooth</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">geom_ribbon</span>(<span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="cn">NA</span>) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Estimate"</span>,<span class="at">x=</span><span class="st">"Age"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb131-509"><a href="#cb131-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-510"><a href="#cb131-510" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age (raw data) </span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-511"><a href="#cb131-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-512"><a href="#cb131-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-513"><a href="#cb131-513" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(compliance, attendance, age) <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>age) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>age,<span class="at">y=</span>value, <span class="at">color=</span>name, <span class="at">fill=</span>name)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.25</span>) <span class="sc">+</span> <span class="fu">geom_smooth</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">color=</span><span class="st">"Outcome"</span>, <span class="at">fill=</span><span class="st">"Outcome"</span>, <span class="at">y=</span><span class="st">"Rate"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">label=</span>percent)</span>
<span id="cb131-514"><a href="#cb131-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-515"><a href="#cb131-515" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Marital</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-516"><a href="#cb131-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-517"><a href="#cb131-517" aria-hidden="true" tabindex="-1"></a>emm_compliance_marital <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb131-518"><a href="#cb131-518" aria-hidden="true" tabindex="-1"></a>emm_attendance_marital <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb131-519"><a href="#cb131-519" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_marital, emm_compliance_marital) <span class="sc">%&gt;%</span></span>
<span id="cb131-520"><a href="#cb131-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb131-521"><a href="#cb131-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Marital"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span>
<span id="cb131-522"><a href="#cb131-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-523"><a href="#cb131-523" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Job</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-524"><a href="#cb131-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-525"><a href="#cb131-525" aria-hidden="true" tabindex="-1"></a>emm_compliance_job <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"job"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb131-526"><a href="#cb131-526" aria-hidden="true" tabindex="-1"></a>emm_attendance_job <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"job"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb131-527"><a href="#cb131-527" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_job, emm_compliance_job) <span class="sc">%&gt;%</span></span>
<span id="cb131-528"><a href="#cb131-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb131-529"><a href="#cb131-529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Job"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span>
<span id="cb131-530"><a href="#cb131-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-531"><a href="#cb131-531" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Opioid</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-532"><a href="#cb131-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-533"><a href="#cb131-533" aria-hidden="true" tabindex="-1"></a>emm_compliance_opioid <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"opioid"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb131-534"><a href="#cb131-534" aria-hidden="true" tabindex="-1"></a>emm_attendance_opioid <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"opioid"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb131-535"><a href="#cb131-535" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_opioid, emm_compliance_opioid) <span class="sc">%&gt;%</span></span>
<span id="cb131-536"><a href="#cb131-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb131-537"><a href="#cb131-537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"opioid"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span>
<span id="cb131-538"><a href="#cb131-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-539"><a href="#cb131-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-540"><a href="#cb131-540" aria-hidden="true" tabindex="-1"></a><span class="co">#test_predictions(beta_compliance_red, "marital") %&gt;%</span></span>
<span id="cb131-541"><a href="#cb131-541" aria-hidden="true" tabindex="-1"></a><span class="co">#  kable() %&gt;%</span></span>
<span id="cb131-542"><a href="#cb131-542" aria-hidden="true" tabindex="-1"></a><span class="co">#  kable_styling()</span></span>
<span id="cb131-543"><a href="#cb131-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-544"><a href="#cb131-544" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Race (compliance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-545"><a href="#cb131-545" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"race"</span>))</span>
<span id="cb131-546"><a href="#cb131-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-547"><a href="#cb131-547" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Heroin (compliance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-548"><a href="#cb131-548" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"heroin"</span>))</span>
<span id="cb131-549"><a href="#cb131-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-550"><a href="#cb131-550" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Speed (attendance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-551"><a href="#cb131-551" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"speed"</span>))</span>
<span id="cb131-552"><a href="#cb131-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-553"><a href="#cb131-553" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Is living stable (attendance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb131-554"><a href="#cb131-554" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"is_living_stable"</span>))</span>
<span id="cb131-555"><a href="#cb131-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-556"><a href="#cb131-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-557"><a href="#cb131-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-558"><a href="#cb131-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-559"><a href="#cb131-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb131-560"><a href="#cb131-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-561"><a href="#cb131-561" aria-hidden="true" tabindex="-1"></a><span class="fu"># CONCLUSIONS</span></span>
<span id="cb131-562"><a href="#cb131-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-563"><a href="#cb131-563" aria-hidden="true" tabindex="-1"></a>Analyses of the data indicate that the age of the participant is the most important factor for both successful randomization and higher attendance/compliance, however the effects go in opposite directions:</span>
<span id="cb131-564"><a href="#cb131-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-565"><a href="#cb131-565" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>For randomization, the probability of enrollment is lower with increasing age.</span>
<span id="cb131-566"><a href="#cb131-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-567"><a href="#cb131-567" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Once randomized, the rates of attendance and compliance goe up with increasing age.</span>
<span id="cb131-568"><a href="#cb131-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-569"><a href="#cb131-569" aria-hidden="true" tabindex="-1"></a>For randomization, the other predictors are the total reported drugs and martial status, but in both cases missing is the most important factor – and there, lack of reported data (indicating unwillingness to participate by reporting data?) indicates lower probability of being randomized. The predictive power of this model is quite strong (AUC 0.8, linear calibration curve).</span>
<span id="cb131-570"><a href="#cb131-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-571"><a href="#cb131-571" aria-hidden="true" tabindex="-1"></a>For compliance and attendance, the predictive power of models are lower. Age remains the most powerful predictor, while other predictors appear to be race, job, marital status, and heroin and opioid.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>