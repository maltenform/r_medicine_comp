{
  "hash": "a3b584087f4eea56807515ffe9102878",
  "result": {
    "markdown": "---\ntitle: \"R/Medicine 2024 Data Challenge\"\nauthor: \"Mitchell Maltenfort\"\n\nnumber-sections: TRUE\nfig-height: 8\nfig-width: 8\nfig-dpi: 300\n\nexecute:\n  output: asis\n  warning: false\n  error: false\n---\n\n\n# INTRODUCTION\n\nThis is my attempt at the analyses requested in <https://rconsortium.github.io/RMedicine_website/Competition.html>. I focused on identifying predictive factors associated with two questions.\n\n1.  Of the potential patients providing data, what factors were associated with succesful randomization?\n\n2.  Defining compliance as the % of potential study weeks where a patient showed up with a negative test, what factors were associated with higher compliance?\n\n\n\n```{.r .cell-code}\n# load data and packages\nrequire(tidyverse)\nrequire(public.ctn0094data)\nrequire(public.ctn0094extra)\nrequire(pROC)\nrequire(ggeffects)\nrequire(kableExtra)\nrequire(broom)\nrequire(rms)\nrequire(betareg)\nrequire(scales)\nrequire(emmeans)\n```\n\n\n# SUCCESSFUL RANDOMIZATION\n\nOf the patients listed in 'everybody' which ones are successfully randomized ('randomization')?\n\n\n\n```{.r .cell-code}\n# create wide table of drug usge\n\nrbs_wide <-\n  rbs %>%\n  mutate(value = case_when(did_use == \"Yes\" ~ 1, did_use == \"No\" ~ 0)) %>%\n  dplyr::select(who, what, value) %>%\n  right_join(everybody %>% dplyr::select(who)) %>%\n  mutate(value = case_when(is.na(value) ~ 0, TRUE ~ value)) %>%\n  pivot_wider(names_from = what, values_fill = 0) %>%\n  mutate(total_reported_drugs = cocaine + heroin + speedball + opioid + speed) %>%\n  dplyr::select(-`NA`) %>%\n  mutate(total_reported_drugs = as.factor(total_reported_drugs))\n\nrandomization_tbl <-\n  demographics %>%\n  left_join(randomization %>% filter(which == 1)) %>%\n  mutate(randomization = as.factor(case_when(is.na(which) ~ \"0\", TRUE ~ which))) %>%\n  inner_join(rbs_wide) %>%\n  mutate(job = as.factor(case_when(is.na(job) ~ \"Missing\", TRUE ~ job))) %>%\n  mutate(is_living_stable = as.factor(case_when(is.na(is_living_stable) ~ \"Missing\", TRUE ~ is_living_stable))) %>%\n  mutate(education = as.factor(case_when(is.na(education) ~ \"Missing\", TRUE ~ education))) %>%\n  mutate(marital = as.factor(case_when(is.na(marital) ~ \"Missing\", TRUE ~ marital))) %>%\n  mutate(job = fct_relevel(job, \"Missing\", after = Inf)) %>%\n  mutate(is_living_stable = fct_relevel(is_living_stable, \"Missing\", after = Inf)) %>%\n  mutate(education = fct_relevel(education, \"Missing\", after = Inf)) %>%\n  mutate(marital = fct_relevel(marital, \"Missing\", after = Inf)) %>%\n  mutate(cocaine = as.factor(cocaine), heroin = as.factor(heroin), speedball = as.factor(speedball), opioid = as.factor(opioid), speed = as.factor(speed)) %>%\n  inner_join(everybody)\n\n# use optimum penalty of 1 determined manually using 'pentrace'\n\nlrm_randomization <-\n  lrm(randomization ~ pol(age, 2) + job + education + marital + is_male + is_hispanic + race + total_reported_drugs + heroin + speedball + opioid, randomization_tbl, x = TRUE, y = TRUE, penalty = 1)\n\n\ncat(\"\\n\\n## Use bootstrap validation to determine what values are persistent\\n\\n\")\n```\n\n\n\n## Use bootstrap validation to determine what values are persistent\n\n```{.r .cell-code}\ncat(\"\\n\\n'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs\\n\\n\")\n```\n\n\n\n'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs\n\n```{.r .cell-code}\nvalidate_randomization <- validate(lrm_randomization, B = 200, bw = TRUE)\n```\n\n\n\t\tBackwards Step-down - Original Model\n\n Deleted     Chi-Sq d.f. P      Residual d.f. P      AIC   \n job         0.23   5    0.9988  0.23     5   0.9988  -9.77\n education   2.69   3    0.4427  2.92     8   0.9395 -13.08\n is_hispanic 0.11   1    0.7370  3.03     9   0.9632 -14.97\n is_male     0.17   1    0.6795  3.20    10   0.9763 -16.80\n speedball   1.84   1    0.1749  5.04    11   0.9293 -16.96\n race        8.97   3    0.0297 14.01    14   0.4493 -13.99\n heroin      6.24   1    0.0125 20.25    15   0.1627  -9.75\n opioid      5.43   1    0.0198 25.68    16   0.0587  -6.32\n\nApproximate Estimates after Deleting Factors\n\n                                         Coef      S.E.  Wald Z         P\nIntercept                           0.2726217 0.6201659  0.4396 6.602e-01\nage                                -0.0731720 0.0295826 -2.4735 1.338e-02\nage^2                               0.0005492 0.0003716  1.4780 1.394e-01\nmarital=Never married               0.1830554 0.2178662  0.8402 4.008e-01\nmarital=Separated/Divorced/Widowed  0.2124224 0.2446399  0.8683 3.852e-01\nmarital=Missing                    -0.9641235 0.1857561 -5.1903 2.100e-07\ntotal_reported_drugs=1              3.7372456 0.2154768 17.3441 0.000e+00\ntotal_reported_drugs=2              3.6986121 0.2124678 17.4079 0.000e+00\ntotal_reported_drugs=3              3.6472251 0.2211314 16.4935 0.000e+00\ntotal_reported_drugs=4              3.8151182 0.2815350 13.5511 0.000e+00\ntotal_reported_drugs=5              3.4882191 0.4293229  8.1249 4.441e-16\n\nFactors in Final Model\n\n[1] age                  marital              total_reported_drugs\n\n```{.r .cell-code}\nsummary(attr(validate_randomization, \"kept\")) %>%\n  kable() %>%\n  kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">  </th>\n   <th style=\"text-align:left;\"> age </th>\n   <th style=\"text-align:left;\"> job </th>\n   <th style=\"text-align:left;\"> education </th>\n   <th style=\"text-align:left;\"> marital </th>\n   <th style=\"text-align:left;\"> is_male </th>\n   <th style=\"text-align:left;\"> is_hispanic </th>\n   <th style=\"text-align:left;\"> race </th>\n   <th style=\"text-align:left;\"> total_reported_drugs </th>\n   <th style=\"text-align:left;\"> heroin </th>\n   <th style=\"text-align:left;\"> speedball </th>\n   <th style=\"text-align:left;\"> opioid </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode:logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n   <td style=\"text-align:left;\"> Mode :logical </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> FALSE:2 </td>\n   <td style=\"text-align:left;\"> FALSE:197 </td>\n   <td style=\"text-align:left;\"> FALSE:163 </td>\n   <td style=\"text-align:left;\"> FALSE:32 </td>\n   <td style=\"text-align:left;\"> FALSE:196 </td>\n   <td style=\"text-align:left;\"> FALSE:193 </td>\n   <td style=\"text-align:left;\"> FALSE:137 </td>\n   <td style=\"text-align:left;\"> TRUE:200 </td>\n   <td style=\"text-align:left;\"> FALSE:149 </td>\n   <td style=\"text-align:left;\"> FALSE:176 </td>\n   <td style=\"text-align:left;\"> FALSE:115 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> TRUE :198 </td>\n   <td style=\"text-align:left;\"> TRUE :3 </td>\n   <td style=\"text-align:left;\"> TRUE :37 </td>\n   <td style=\"text-align:left;\"> TRUE :168 </td>\n   <td style=\"text-align:left;\"> TRUE :4 </td>\n   <td style=\"text-align:left;\"> TRUE :7 </td>\n   <td style=\"text-align:left;\"> TRUE :63 </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:left;\"> TRUE :51 </td>\n   <td style=\"text-align:left;\"> TRUE :24 </td>\n   <td style=\"text-align:left;\"> TRUE :85 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\nlrm_final <- lrm(randomization ~ pol(age, 2) + marital + total_reported_drugs, randomization_tbl, x = TRUE, y = TRUE, penalty = 1)\n\nrandomization_tbl$predict_randomization <- predict(lrm_final, type = \"fitted\")\n\ncat(\"\\n\\n## Project 51 has almost perfect randomization compared to other two\\n\\n\")\n```\n\n\n\n## Project 51 has almost perfect randomization compared to other two\n\n```{.r .cell-code}\nggemmeans(update(lrm_final,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> project </th>\n   <th style=\"text-align:right;\"> predicted </th>\n   <th style=\"text-align:right;\"> conf.low </th>\n   <th style=\"text-align:right;\"> conf.high </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 27 </td>\n   <td style=\"text-align:right;\"> 0.6509355 </td>\n   <td style=\"text-align:right;\"> 0.5791867 </td>\n   <td style=\"text-align:right;\"> 0.7164402 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 30 </td>\n   <td style=\"text-align:right;\"> 0.7240205 </td>\n   <td style=\"text-align:right;\"> 0.6693301 </td>\n   <td style=\"text-align:right;\"> 0.7727367 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 51 </td>\n   <td style=\"text-align:right;\"> 0.9940233 </td>\n   <td style=\"text-align:right;\"> 0.9824580 </td>\n   <td style=\"text-align:right;\"> 0.9979793 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncat(\"\\n\\n## Use bootstrap validtion to determine what values are persistent\\n\\n\")\n```\n\n\n\n## Use bootstrap validtion to determine what values are persistent\n\n```{.r .cell-code}\ncoef <- coefficients(lrm_final)\nse <- sqrt(diag(vcov(lrm_final)))\n\ncat(\"\\n\\n## Final logistic regression model predicting successful randomization (log-odds)\\n\\n\")\n```\n\n\n\n## Final logistic regression model predicting successful randomization (log-odds)\n\n```{.r .cell-code}\ncat(\"\\n\\n(factor reference levels based on alphabetical order)\\n\\n\")\n```\n\n\n\n(factor reference levels based on alphabetical order)\n\n```{.r .cell-code}\ntibble(term = names(coef), coef, se) %>%\n  mutate(p = 2 * case_when(coef > 0 ~ pnorm(coef / se, lower.tail = FALSE), TRUE ~ pnorm(coef / se, lower.tail = TRUE))) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 4, 6) %>%\n  pack_rows(\"Total Reported Drugs (reference level 0)\", 7, 11)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> coef </th>\n   <th style=\"text-align:right;\"> se </th>\n   <th style=\"text-align:right;\"> p </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Intercept </td>\n   <td style=\"text-align:right;\"> 0.1741456 </td>\n   <td style=\"text-align:right;\"> 0.6158886 </td>\n   <td style=\"text-align:right;\"> 0.7773647 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> age </td>\n   <td style=\"text-align:right;\"> -0.0722803 </td>\n   <td style=\"text-align:right;\"> 0.0294367 </td>\n   <td style=\"text-align:right;\"> 0.0140707 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> age^2 </td>\n   <td style=\"text-align:right;\"> 0.0005367 </td>\n   <td style=\"text-align:right;\"> 0.0003702 </td>\n   <td style=\"text-align:right;\"> 0.1471491 </td>\n  </tr>\n  <tr grouplength=\"3\"><td colspan=\"4\" style=\"border-bottom: 1px solid;\"><strong>Marital (ref level Married or Partnered)</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> marital=Never married </td>\n   <td style=\"text-align:right;\"> 0.1860933 </td>\n   <td style=\"text-align:right;\"> 0.2177973 </td>\n   <td style=\"text-align:right;\"> 0.3928649 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> marital=Separated/Divorced/Widowed </td>\n   <td style=\"text-align:right;\"> 0.2180355 </td>\n   <td style=\"text-align:right;\"> 0.2447502 </td>\n   <td style=\"text-align:right;\"> 0.3730099 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> marital=Missing </td>\n   <td style=\"text-align:right;\"> -0.9700294 </td>\n   <td style=\"text-align:right;\"> 0.1860135 </td>\n   <td style=\"text-align:right;\"> 0.0000002 </td>\n  </tr>\n  <tr grouplength=\"5\"><td colspan=\"4\" style=\"border-bottom: 1px solid;\"><strong>Total Reported Drugs (reference level 0)</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> total_reported_drugs=1 </td>\n   <td style=\"text-align:right;\"> 3.8333471 </td>\n   <td style=\"text-align:right;\"> 0.2133380 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> total_reported_drugs=2 </td>\n   <td style=\"text-align:right;\"> 3.8023090 </td>\n   <td style=\"text-align:right;\"> 0.2102814 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> total_reported_drugs=3 </td>\n   <td style=\"text-align:right;\"> 3.7605650 </td>\n   <td style=\"text-align:right;\"> 0.2188092 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> total_reported_drugs=4 </td>\n   <td style=\"text-align:right;\"> 3.9294689 </td>\n   <td style=\"text-align:right;\"> 0.2790591 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> total_reported_drugs=5 </td>\n   <td style=\"text-align:right;\"> 3.5772414 </td>\n   <td style=\"text-align:right;\"> 0.4260219 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncalibrate_final <- calibrate(lrm_final, B = 200)\n\ncalibrate_tbl <-\n  calibrate_final[, c(\"predy\", \"calibrated.orig\", \"calibrated.corrected\")] %>%\n  as_tibble() %>%\n  pivot_longer(calibrated.orig:calibrated.corrected)\n\ncat(\"\\n\\n## Show calibration (predicted vs actual) for predictive model of randomization\\n\\n\")\n```\n\n\n\n## Show calibration (predicted vs actual) for predictive model of randomization\n\n```{.r .cell-code}\ncalibrate_tbl %>%\n  ggplot(aes(x = predy, y = value, color = name)) +\n  geom_line(linewidth = 1) +\n  theme_bw() +\n  labs(color = \"calibration\", x = \"Predicted Probability\", y = \"Actual Probability\") +\n  theme(legend.position = c(0.8, 0.2)) +\n  geom_abline(linetype = \"dashed\")\n```\n\n![](index_files/figure-html/randomization-1.png){width=2400}\n\n```{.r .cell-code}\nauc <- ci.auc(roc(randomization ~ predict_randomization, data = randomization_tbl %>% filter(!is.na(predict_randomization))))\n\ncat(sprintf(\"\\n\\n## ROC curve AUC is %0.2f (95 percent CI %0.2f - %0.2f)\\n\\n\", auc[2], auc[1], auc[3]))\n```\n\n\n\n## ROC curve AUC is 0.81 (95 percent CI 0.79 - 0.83)\n\n```{.r .cell-code}\nplot(roc(randomization ~ predict_randomization, data = randomization_tbl %>% filter(!is.na(predict_randomization))))\n```\n\n![](index_files/figure-html/randomization-2.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n\")\n```\n\n```{.r .cell-code}\ncat(\"\\n\\n## Estimated marginal means\\n\\n\")\n```\n\n\n\n## Estimated marginal means\n\n```{.r .cell-code}\ncat(\"\\n\\n### Marital\\n\\n\")\n```\n\n\n\n### Marital\n\n```{.r .cell-code}\nplot(ggemmeans(lrm_final, \"marital\"))\n```\n\n![](index_files/figure-html/randomization-3.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n\")\n```\n\n```{.r .cell-code}\ntest_predictions(lrm_final, \"marital\") %>%\n  kable() %>%\n  kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> marital </th>\n   <th style=\"text-align:right;\"> Contrast </th>\n   <th style=\"text-align:right;\"> conf.low </th>\n   <th style=\"text-align:right;\"> conf.high </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Married or Partnered-Never married </td>\n   <td style=\"text-align:right;\"> -0.0252404 </td>\n   <td style=\"text-align:right;\"> -0.0824855 </td>\n   <td style=\"text-align:right;\"> 0.0320046 </td>\n   <td style=\"text-align:right;\"> 0.3874862 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Married or Partnered-Separated/Divorced/Widowed </td>\n   <td style=\"text-align:right;\"> -0.0298955 </td>\n   <td style=\"text-align:right;\"> -0.0961135 </td>\n   <td style=\"text-align:right;\"> 0.0363225 </td>\n   <td style=\"text-align:right;\"> 0.3762287 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Married or Partnered-Missing </td>\n   <td style=\"text-align:right;\"> 0.0870519 </td>\n   <td style=\"text-align:right;\"> 0.0348838 </td>\n   <td style=\"text-align:right;\"> 0.1392201 </td>\n   <td style=\"text-align:right;\"> 0.0010734 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Never married-Separated/Divorced/Widowed </td>\n   <td style=\"text-align:right;\"> -0.0046551 </td>\n   <td style=\"text-align:right;\"> -0.0666364 </td>\n   <td style=\"text-align:right;\"> 0.0573262 </td>\n   <td style=\"text-align:right;\"> 0.8829721 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Never married-Missing </td>\n   <td style=\"text-align:right;\"> 0.1122923 </td>\n   <td style=\"text-align:right;\"> 0.0624778 </td>\n   <td style=\"text-align:right;\"> 0.1621069 </td>\n   <td style=\"text-align:right;\"> 0.0000100 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Separated/Divorced/Widowed-Missing </td>\n   <td style=\"text-align:right;\"> 0.1169474 </td>\n   <td style=\"text-align:right;\"> 0.0563531 </td>\n   <td style=\"text-align:right;\"> 0.1775418 </td>\n   <td style=\"text-align:right;\"> 0.0001551 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncat(\"\\n\\n### Total reported drugs\\n\\n\")\n```\n\n\n\n### Total reported drugs\n\n```{.r .cell-code}\nplot(ggemmeans(lrm_final, \"total_reported_drugs\"))\n```\n\n![](index_files/figure-html/randomization-4.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n\")\n```\n\n```{.r .cell-code}\ntest_predictions(lrm_final, \"total_reported_drugs\") %>%\n  kable() %>%\n  kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> total_reported_drugs </th>\n   <th style=\"text-align:right;\"> Contrast </th>\n   <th style=\"text-align:right;\"> conf.low </th>\n   <th style=\"text-align:right;\"> conf.high </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 0-1 </td>\n   <td style=\"text-align:right;\"> -0.7408890 </td>\n   <td style=\"text-align:right;\"> -0.7933182 </td>\n   <td style=\"text-align:right;\"> -0.6884598 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0-2 </td>\n   <td style=\"text-align:right;\"> -0.7378239 </td>\n   <td style=\"text-align:right;\"> -0.7897550 </td>\n   <td style=\"text-align:right;\"> -0.6858928 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0-3 </td>\n   <td style=\"text-align:right;\"> -0.7335837 </td>\n   <td style=\"text-align:right;\"> -0.7869992 </td>\n   <td style=\"text-align:right;\"> -0.6801682 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0-4 </td>\n   <td style=\"text-align:right;\"> -0.7499212 </td>\n   <td style=\"text-align:right;\"> -0.8116047 </td>\n   <td style=\"text-align:right;\"> -0.6882376 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0-5 </td>\n   <td style=\"text-align:right;\"> -0.7132936 </td>\n   <td style=\"text-align:right;\"> -0.8138319 </td>\n   <td style=\"text-align:right;\"> -0.6127554 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1-2 </td>\n   <td style=\"text-align:right;\"> 0.0030651 </td>\n   <td style=\"text-align:right;\"> -0.0206425 </td>\n   <td style=\"text-align:right;\"> 0.0267727 </td>\n   <td style=\"text-align:right;\"> 0.7999593 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1-3 </td>\n   <td style=\"text-align:right;\"> 0.0073053 </td>\n   <td style=\"text-align:right;\"> -0.0197899 </td>\n   <td style=\"text-align:right;\"> 0.0344004 </td>\n   <td style=\"text-align:right;\"> 0.5971954 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1-4 </td>\n   <td style=\"text-align:right;\"> -0.0090321 </td>\n   <td style=\"text-align:right;\"> -0.0490508 </td>\n   <td style=\"text-align:right;\"> 0.0309865 </td>\n   <td style=\"text-align:right;\"> 0.6582287 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1-5 </td>\n   <td style=\"text-align:right;\"> 0.0275954 </td>\n   <td style=\"text-align:right;\"> -0.0627017 </td>\n   <td style=\"text-align:right;\"> 0.1178925 </td>\n   <td style=\"text-align:right;\"> 0.5491874 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-3 </td>\n   <td style=\"text-align:right;\"> 0.0042402 </td>\n   <td style=\"text-align:right;\"> -0.0220300 </td>\n   <td style=\"text-align:right;\"> 0.0305104 </td>\n   <td style=\"text-align:right;\"> 0.7517362 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-4 </td>\n   <td style=\"text-align:right;\"> -0.0120972 </td>\n   <td style=\"text-align:right;\"> -0.0516237 </td>\n   <td style=\"text-align:right;\"> 0.0274293 </td>\n   <td style=\"text-align:right;\"> 0.5486031 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-5 </td>\n   <td style=\"text-align:right;\"> 0.0245303 </td>\n   <td style=\"text-align:right;\"> -0.0654250 </td>\n   <td style=\"text-align:right;\"> 0.1144856 </td>\n   <td style=\"text-align:right;\"> 0.5930158 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3-4 </td>\n   <td style=\"text-align:right;\"> -0.0163374 </td>\n   <td style=\"text-align:right;\"> -0.0578999 </td>\n   <td style=\"text-align:right;\"> 0.0252251 </td>\n   <td style=\"text-align:right;\"> 0.4410482 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3-5 </td>\n   <td style=\"text-align:right;\"> 0.0202901 </td>\n   <td style=\"text-align:right;\"> -0.0704499 </td>\n   <td style=\"text-align:right;\"> 0.1110301 </td>\n   <td style=\"text-align:right;\"> 0.6611965 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4-5 </td>\n   <td style=\"text-align:right;\"> 0.0366275 </td>\n   <td style=\"text-align:right;\"> -0.0585622 </td>\n   <td style=\"text-align:right;\"> 0.1318173 </td>\n   <td style=\"text-align:right;\"> 0.4507509 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncat(\"\\n\\n### Age\\n\\n\")\n```\n\n\n\n### Age\n\n```{.r .cell-code}\nplot(ggemmeans(lrm_final, \"age[all]\"))\n```\n\n![](index_files/figure-html/randomization-5.png){width=2400}\n\n\n# ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION\n\nThis adapts the code from 'public.ctn0094extra' vignette to summarise substance use across weeks.\n\nI define compliance as how many times the patient showed up with a negative UDS report, divided by the length of time in the study (Study Week + 1 for Baseline). Attendance is how many times the patient showed up with a report (positive or negative), divided by length of time in the study.\n\nBeta regression is used to create a parsimonious model, pruned \"by hand\" to get rid of irrelevant predictors. The correlation coefficients for these models are not good (R-squared \\< 0.03) but there may be some insight into how to get better attendance or compliance for patients\n\n\n\n```{.r .cell-code}\ndata_ls <- loadRawData(c(\"randomization\", \"treatment\"))\n\ndata_ls$randomization <-\n  data_ls$randomization %>%\n  select(who, when, treatment, randomized = which) %>%\n  # Remove second randomization events\n  filter(randomized != 2)\n\ndata_ls$treatment <-\n  data_ls$treatment\n\nstart_int <- c(`27` = -30L, `51` = -30L)\nend_int <- c(`27` = 168L, `51` = 168L)\nbackbone2751_df <-\n  CreateProtocolHistory(\n    start_vec = start_int,\n    end_vec = end_int\n  )\n\nbackbone30_df <-\n  randomization %>%\n  full_join(everybody, by = \"who\") %>%\n  filter(project == \"30\") %>%\n  CreateCTN30ProtocolHistory() %>%\n  mutate(project = \"30\") %>%\n  select(who, project, when)\n\nbackbone_df <-\n  bind_rows(backbone2751_df, backbone30_df) %>%\n  arrange(who)\n\nrm(backbone2751_df, backbone30_df, start_int, end_int)\n\ndata_ls <- loadRawData(c(\"randomization\", \"visit\"))\n\ndata_ls$randomization <-\n  data_ls$randomization %>%\n  select(who, when, treatment, randomized = which) %>%\n  # Remove second randomization events\n  filter(randomized != 2)\n\ndata_ls$visit <-\n  data_ls$visit\n\n\ntimelineRand1_df <-\n  data_ls$randomization %>%\n  mutate(randomized = randomized == \"1\") %>%\n  # Join to backbone and arrange within subject by day\n  full_join(backbone_df, by = c(\"who\", \"when\")) %>%\n  group_by(who) %>%\n  arrange(when, .by_group = TRUE) %>%\n  select(who, project, when, randomized)\n\ntimelineVisit1_df <-\n  data_ls$visit %>%\n  select(who, when, visit, status = what) %>%\n  filter(status %in% c(\"visit\", \"final\")) %>%\n  mutate(visit = TRUE) %>%\n  select(who, when, visit) %>%\n  left_join(timelineRand1_df, ., by = c(\"who\", \"when\")) %>%\n  distinct()\n\ntimelineMissing1_df <- MarkMissing(timelineVisit1_df)\n\nderived_visitImputed <-\n  timelineMissing1_df %>%\n  mutate(visit = as.character(visit)) %>%\n  replace_na(list(visit = \"\", visitYM = \"\")) %>%\n  mutate(visitImputed = paste0(visit, visitYM)) %>%\n  mutate(\n    visitImputed = str_replace(\n      visitImputed,\n      pattern = \"TRUETRUE\", replacement = \"Present\"\n    )\n  ) %>%\n  select(who, when, visitImputed) %>%\n  filter(visitImputed != \"\") %>%\n  ungroup()\n\n\nrandomized_df <-\n  randomization %>%\n  mutate(randomized = as.integer(as.character(which))) %>%\n  select(who, when, randomized) %>%\n  left_join(everybody, by = \"who\") %>%\n  filter(!(randomized == 2 & project %in% c(\"27\", \"51\"))) %>%\n  select(-project)\n\nudsUse2_df <-\n  backbone_df %>%\n  left_join(randomized_df, by = c(\"who\", \"when\")) %>%\n  left_join(derived_visitImputed, by = c(\"who\", \"when\")) %>%\n  left_join(uds, by = c(\"who\", \"when\")) %>%\n  # So we can use MarkUse() with UDS data (instead of all_drugs)\n  mutate(source = \"UDS\")\n\nrm(\n  backbone_df, data_ls, timelineMissing1_df, timelineRand1_df, timelineVisit1_df\n)\n\nnonStudyOpioids_ls <- list(\n  \"Buprenorphine\" = c(\"Opioid\", \"Methadone\"),\n  \"Methadone\"     = c(\"Opioid\", \"Buprenorphine\"),\n  \"Naltrexone\"    = c(\"Opioid\", \"Methadone\", \"Buprenorphine\"),\n  \"Not treated\"   = c(\"Opioid\", \"Methadone\", \"Buprenorphine\")\n)\n\ntreatGroups_ls <-\n  randomization %>%\n  filter(which == 1) %>%\n  left_join(everybody, by = \"who\") %>%\n  select(who, treatment) %>%\n  mutate(\n    treat_drug = case_when(\n      str_detect(treatment, \"BUP\") ~ \"Buprenorphine\",\n      treatment == \"Methadone\" ~ \"Methadone\",\n      treatment == \"Inpatient NR-NTX\" ~ \"Naltrexone\"\n    )\n  ) %>%\n  select(-treatment) %>%\n  split(f = .$treat_drug) %>%\n  map(.f = \"who\")\n\nopioidUse_df <-\n  udsUse2_df %>%\n  mutate(\n    treat_group = case_when(\n      who %in% treatGroups_ls$Buprenorphine ~ \"Buprenorphine\",\n      who %in% treatGroups_ls$Methadone ~ \"Methadone\",\n      who %in% treatGroups_ls$Naltrexone ~ \"Naltrexone\",\n      TRUE ~ \"Not treated\"\n    )\n  ) %>%\n  split(f = .$treat_group) %>%\n  # List of data in alphabetical order, so the non-study drugs ls should match\n  map2(\n    .y = nonStudyOpioids_ls,\n    .f = ~ {\n      # REQUIRES \"source\" COLUMN\n      MarkUse(\n        targetDrugs_char = .y,\n        drugs_df = .x,\n        # because we have participants with no recorded UDS; in practice DO NOT\n        #   use this command\n        retainEmptyRows = TRUE\n      )\n    }\n  ) %>%\n  bind_rows() %>%\n  mutate(\n    udsOpioid = case_when(\n      is.na(when) ~ NA,\n      !is.na(when) ~ TRUE\n    )\n  ) %>%\n  select(who, when, udsOpioid)\n\ntimelineUDS_df <-\n  udsUse2_df %>%\n  left_join(opioidUse_df, by = c(\"who\", \"when\")) %>%\n  select(-what, -source) %>%\n  # 2,089 rows to 1,994\n  distinct()\n\nrm(\n  derived_visitImputed, opioidUse_df, randomized_df, treatGroups_ls, udsUse2_df\n)\n\nwasRandomized_int <-\n  timelineUDS_df %>%\n  group_by(who) %>%\n  summarise(randomized = any(randomized %in% 1:2)) %>%\n  filter(randomized) %>%\n  pull(who)\nnotRandomized_int <-\n  timelineUDS_df %>%\n  filter(!(who %in% wasRandomized_int)) %>%\n  pull(who) %>%\n  unique()\n\ntimelineUDS2_df <-\n  timelineUDS_df %>%\n  filter(who %in% wasRandomized_int) %>%\n  group_by(who) %>%\n  filter(!is.na(randomized)) %>%\n  mutate(\n    whenRandomized1 = case_when(randomized == 1 ~ when),\n    whenRandomized2 = case_when(randomized == 2 ~ when)\n  ) %>%\n  select(who, when, whenRandomized1, whenRandomized2) %>%\n  left_join(timelineUDS_df, ., by = c(\"who\", \"when\")) %>%\n  filter(who %in% wasRandomized_int) %>%\n  # Add back in the groupings BEFORE the fill()\n  group_by(who) %>%\n  fill(whenRandomized1, .direction = \"updown\") %>%\n  fill(whenRandomized2, .direction = \"updown\") %>%\n  mutate(daysSinceRand1 = when - whenRandomized1) %>%\n  mutate(daysSinceRand2 = when - whenRandomized2) %>%\n  select(-whenRandomized1, -whenRandomized2)\n\nweeklyUse_df <-\n  timelineUDS2_df %>%\n  # The (daysSinceRand1 - 1) adjustment is to ensure that the first study week\n  #   is a full 7 days, since \"day 0\" is the day before randomization. The \"+1\"\n  #   at the end is to shift the study week label such that \"week 0\" is the\n  #   week *BEFORE* treatment, rather than the first week of treatment. So, the\n  #   randomization day is the last day of \"week 0\" (the pre-treatment period).\n  mutate(studyWeek1 = (daysSinceRand1 - 1) %/% 7 + 1) %>%\n  mutate(studyWeek2 = (daysSinceRand2 - 1) %/% 7 + 1) %>%\n  group_by(who, studyWeek1) %>%\n  # There are some study weeks with multiple UDS, so we count the number of\n  #   positive and negative UDS per week.\n  summarise(\n    nPosUDS  = sum(udsOpioid == 1, na.rm = TRUE),\n    nNegUDS  = sum(visitImputed == \"Present\" & is.na(udsOpioid), na.rm = TRUE),\n    nMissing = sum(visitImputed == \"Missing\", na.rm = TRUE),\n    randWk1  = sum(randomized == 1, na.rm = TRUE) > 0,\n    randWk2  = sum(randomized == 2 & project == \"30\", na.rm = TRUE) > 0\n  ) %>%\n  ungroup()\n\nuseByWeekRandomized_df <-\n  weeklyUse_df %>%\n  mutate(\n    udsStatus = case_when(\n      # If we see a positive UDS and no negative UDS, it's positive\n      nPosUDS > 0 & nNegUDS == 0 ~ \"+\",\n      # If we see a negative UDS and no positive UDS, it's negative\n      nPosUDS == 0 & nNegUDS > 0 ~ \"-\",\n      # If we see both positive and negative UDS in a single week, it's both\n      #   (note that we can recode all \"B\"s to be \"+\" as necessary)\n      nPosUDS > 0 & nNegUDS > 0 ~ \"*\",\n      # If we don't have any UDS in a week after randomization, it's missing\n      # UPDATE 2022-03-08: I had this as a 0 originally, and I was using this\n      #   in context of consent, not randomization. This was wrong.\n      nPosUDS == 0 & nNegUDS == 0 & studyWeek1 >= 1 ~ \"o\",\n      # If none of the above are true, but we still have a missing value as\n      #   marked by the MarkMissing() function, then it's missing\n      nMissing > 0 ~ \"o\",\n      # If none of the above conditions are true (probably because it's a week\n      #   before randomization but not during a baseline visit for consent),\n      #   then leave it blank (pre-study)\n      TRUE ~ \"_\"\n    )\n  ) %>%\n  group_by(who) %>%\n  # For CTN-0030, Phase II could have started on any day of the week, even in\n  #   the middle of a treatment week. If we try to start counting Phase II\n  #   weeks the day after treatment arms are switched, we can end up with the\n  #   last \"week\" of Phase I not having 7 days. I'm going to leave the first\n  #   week of Phase II as whatever week the switch happened in.\n  mutate(\n    rand1Active = studyWeek1 > 0,\n    # This returns 0 for any week before the Phase II randomization, and 1 for\n    #   the Phase II randomization week and all subsequent weeks (because the\n    #   randWk2 column is 1 only for the week of second randomization and 0\n    #   all other rows).\n    rand2Active = cumsum(randWk2),\n    trialPhase  = rand1Active + rand2Active\n  ) %>%\n  dplyr::select(\n    who,\n    studyWeek = studyWeek1, randWk1, randWk2, udsStatus, trialPhase\n  )\n\n\n#### NEW\n\n\ncompliance_results <-\n  useByWeekRandomized_df %>%\n  filter(trialPhase == 1) %>%\n  filter(studyWeek >= 0) %>%\n  inner_join(everybody) %>%\n  group_by(project, who) %>%\n  summarise(sum_pos = sum(udsStatus == \"+\"), sum_neg = sum(udsStatus == \"-\"), sumMissing = sum(udsStatus == \"o\"), total_weeks = 1 + max(studyWeek)) %>%\n  mutate(compliance = sum_neg / total_weeks, attendance = (sum_neg+sum_pos)/total_weeks) %>%\n  inner_join(randomization_tbl %>% dplyr::select(who, age, is_hispanic, race, job, education, is_living_stable, marital, is_male, cocaine:total_reported_drugs, predict_randomization)) %>%\n  mutate(project=as.factor(project))\n\n# from https://stats.stackexchange.com/questions/31300/dealing-with-0-1-values-in-a-beta-regression\n# squeeze 0 and 1 so can use beta regression\n\nN <- dim(compliance_results)[1]\n\ncompliance_results <- mutate(compliance_results, squeeze_compliance = (compliance * (N - 1) + 0.5) / N, squeeze_attendance = (attendance * (N - 1) + 0.5) / N)\n\n\nbeta_compliance <- betareg(squeeze_compliance ~ age + is_hispanic + race + education + job + is_living_stable + marital + is_male + cocaine + heroin + speedball + opioid + speed, compliance_results)\n\nbeta_compliance_red <- betareg(squeeze_compliance ~ age + race + job + marital + heroin + opioid, compliance_results)\n\nbeta_attendance <- betareg(squeeze_attendance ~ age + is_hispanic + race + education + job + is_living_stable + marital + is_male + cocaine + heroin + speedball + opioid + speed, compliance_results)\n\nbeta_attendance_red <- betareg(squeeze_attendance ~ age   + job + is_living_stable + marital + opioid + speed, compliance_results)\n\n\n\n\n\ncat(\"\\n\\n## Beta regression coefficients (factor reference levels based on alphabetical order)\\n\\n\")\n```\n\n\n\n## Beta regression coefficients (factor reference levels based on alphabetical order)\n\n```{.r .cell-code}\ncat(\"\\n\\n### Compliance\\n\\n\")\n```\n\n\n\n### Compliance\n\n```{.r .cell-code}\ntidy(beta_compliance_red) %>%\n  dplyr::select(-statistic) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Race (reference level Black)\", 3, 5) %>%\n  pack_rows(\"job (reference level Full Time)\", 6, 10) %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 11, 13)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> component </th>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> mean </td>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> -1.4656202 </td>\n   <td style=\"text-align:right;\"> 0.1722355 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean </td>\n   <td style=\"text-align:left;\"> age </td>\n   <td style=\"text-align:right;\"> 0.0077218 </td>\n   <td style=\"text-align:right;\"> 0.0025338 </td>\n   <td style=\"text-align:right;\"> 0.0023075 </td>\n  </tr>\n  <tr grouplength=\"3\"><td colspan=\"5\" style=\"border-bottom: 1px solid;\"><strong>Race (reference level Black)</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> raceOther </td>\n   <td style=\"text-align:right;\"> -0.0000154 </td>\n   <td style=\"text-align:right;\"> 0.1035300 </td>\n   <td style=\"text-align:right;\"> 0.9998809 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> raceRefused/missing </td>\n   <td style=\"text-align:right;\"> -0.1131639 </td>\n   <td style=\"text-align:right;\"> 0.3348571 </td>\n   <td style=\"text-align:right;\"> 0.7354034 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> raceWhite </td>\n   <td style=\"text-align:right;\"> 0.1482887 </td>\n   <td style=\"text-align:right;\"> 0.0878694 </td>\n   <td style=\"text-align:right;\"> 0.0914874 </td>\n  </tr>\n  <tr grouplength=\"5\"><td colspan=\"5\" style=\"border-bottom: 1px solid;\"><strong>job (reference level Full Time)</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobOther </td>\n   <td style=\"text-align:right;\"> 0.3114931 </td>\n   <td style=\"text-align:right;\"> 0.1846286 </td>\n   <td style=\"text-align:right;\"> 0.0915776 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobPart Time </td>\n   <td style=\"text-align:right;\"> -0.1640795 </td>\n   <td style=\"text-align:right;\"> 0.0855055 </td>\n   <td style=\"text-align:right;\"> 0.0549926 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobStudent </td>\n   <td style=\"text-align:right;\"> -0.2596616 </td>\n   <td style=\"text-align:right;\"> 0.1956821 </td>\n   <td style=\"text-align:right;\"> 0.1845232 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobUnemployed </td>\n   <td style=\"text-align:right;\"> 0.0299534 </td>\n   <td style=\"text-align:right;\"> 0.0846908 </td>\n   <td style=\"text-align:right;\"> 0.7235793 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobMissing </td>\n   <td style=\"text-align:right;\"> -0.5690129 </td>\n   <td style=\"text-align:right;\"> 0.6021055 </td>\n   <td style=\"text-align:right;\"> 0.3446392 </td>\n  </tr>\n  <tr grouplength=\"3\"><td colspan=\"5\" style=\"border-bottom: 1px solid;\"><strong>Marital (ref level Married or Partnered)</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> maritalNever married </td>\n   <td style=\"text-align:right;\"> 0.2686716 </td>\n   <td style=\"text-align:right;\"> 0.0884782 </td>\n   <td style=\"text-align:right;\"> 0.0023927 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> maritalSeparated/Divorced/Widowed </td>\n   <td style=\"text-align:right;\"> 0.2431355 </td>\n   <td style=\"text-align:right;\"> 0.1008997 </td>\n   <td style=\"text-align:right;\"> 0.0159667 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> maritalMissing </td>\n   <td style=\"text-align:right;\"> 0.5755636 </td>\n   <td style=\"text-align:right;\"> 0.6054473 </td>\n   <td style=\"text-align:right;\"> 0.3417862 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean </td>\n   <td style=\"text-align:left;\"> heroin1 </td>\n   <td style=\"text-align:right;\"> -0.1291437 </td>\n   <td style=\"text-align:right;\"> 0.0619663 </td>\n   <td style=\"text-align:right;\"> 0.0371516 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean </td>\n   <td style=\"text-align:left;\"> opioid1 </td>\n   <td style=\"text-align:right;\"> 0.2627274 </td>\n   <td style=\"text-align:right;\"> 0.0567428 </td>\n   <td style=\"text-align:right;\"> 0.0000037 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> precision </td>\n   <td style=\"text-align:left;\"> (phi) </td>\n   <td style=\"text-align:right;\"> 1.2804061 </td>\n   <td style=\"text-align:right;\"> 0.0325090 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncat(\"\\n\\n### No major difference between Projects\\n\\n\")\n```\n\n\n\n### No major difference between Projects\n\n```{.r .cell-code}\ncat(\"\\n\\nUpdate models by adding project and look for marginal means between projects\\n\\n\")\n```\n\n\n\nUpdate models by adding project and look for marginal means between projects\n\n```{.r .cell-code}\ncat(\"\\n\\n#### Compliance\\n\\n\")\n```\n\n\n\n#### Compliance\n\n```{.r .cell-code}\nggemmeans(update(beta_compliance_red,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> project </th>\n   <th style=\"text-align:right;\"> predicted </th>\n   <th style=\"text-align:right;\"> conf.low </th>\n   <th style=\"text-align:right;\"> conf.high </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 27 </td>\n   <td style=\"text-align:right;\"> 0.2862537 </td>\n   <td style=\"text-align:right;\"> 0.2271404 </td>\n   <td style=\"text-align:right;\"> 0.3453670 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 30 </td>\n   <td style=\"text-align:right;\"> 0.2495486 </td>\n   <td style=\"text-align:right;\"> 0.1970343 </td>\n   <td style=\"text-align:right;\"> 0.3020629 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 51 </td>\n   <td style=\"text-align:right;\"> 0.3312811 </td>\n   <td style=\"text-align:right;\"> 0.2736646 </td>\n   <td style=\"text-align:right;\"> 0.3888977 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncat(\"\\n\\n#### Attendance\\n\\n\")\n```\n\n\n\n#### Attendance\n\n```{.r .cell-code}\nggemmeans(update(beta_attendance_red,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> project </th>\n   <th style=\"text-align:right;\"> predicted </th>\n   <th style=\"text-align:right;\"> conf.low </th>\n   <th style=\"text-align:right;\"> conf.high </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 27 </td>\n   <td style=\"text-align:right;\"> 0.4234444 </td>\n   <td style=\"text-align:right;\"> 0.3310894 </td>\n   <td style=\"text-align:right;\"> 0.5157993 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 30 </td>\n   <td style=\"text-align:right;\"> 0.4437619 </td>\n   <td style=\"text-align:right;\"> 0.3556613 </td>\n   <td style=\"text-align:right;\"> 0.5318625 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 51 </td>\n   <td style=\"text-align:right;\"> 0.4345425 </td>\n   <td style=\"text-align:right;\"> 0.3448335 </td>\n   <td style=\"text-align:right;\"> 0.5242516 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncat(\"\\n\\n### Attendance\\n\\n\")\n```\n\n\n\n### Attendance\n\n```{.r .cell-code}\ntidy(beta_attendance_red) %>%\n  dplyr::select(-statistic) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Job (reference level Full Time)\", 3, 7) %>%\n  pack_rows(\"Is living stable (reference level No)\", 8, 9) %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 10, 12)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> component </th>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> mean </td>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> -1.1593638 </td>\n   <td style=\"text-align:right;\"> 0.2248213 </td>\n   <td style=\"text-align:right;\"> 0.0000003 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean </td>\n   <td style=\"text-align:left;\"> age </td>\n   <td style=\"text-align:right;\"> 0.0075580 </td>\n   <td style=\"text-align:right;\"> 0.0024485 </td>\n   <td style=\"text-align:right;\"> 0.0020234 </td>\n  </tr>\n  <tr grouplength=\"5\"><td colspan=\"5\" style=\"border-bottom: 1px solid;\"><strong>Job (reference level Full Time)</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobOther </td>\n   <td style=\"text-align:right;\"> 0.3098685 </td>\n   <td style=\"text-align:right;\"> 0.1813007 </td>\n   <td style=\"text-align:right;\"> 0.0874248 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobPart Time </td>\n   <td style=\"text-align:right;\"> -0.1632520 </td>\n   <td style=\"text-align:right;\"> 0.0856712 </td>\n   <td style=\"text-align:right;\"> 0.0567067 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobStudent </td>\n   <td style=\"text-align:right;\"> 0.0124950 </td>\n   <td style=\"text-align:right;\"> 0.1970223 </td>\n   <td style=\"text-align:right;\"> 0.9494328 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobUnemployed </td>\n   <td style=\"text-align:right;\"> 0.0808107 </td>\n   <td style=\"text-align:right;\"> 0.0845202 </td>\n   <td style=\"text-align:right;\"> 0.3390160 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> jobMissing </td>\n   <td style=\"text-align:right;\"> -0.7457840 </td>\n   <td style=\"text-align:right;\"> 0.8317397 </td>\n   <td style=\"text-align:right;\"> 0.3699027 </td>\n  </tr>\n  <tr grouplength=\"2\"><td colspan=\"5\" style=\"border-bottom: 1px solid;\"><strong>Is living stable (reference level No)</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> is_living_stableYes </td>\n   <td style=\"text-align:right;\"> 0.3387088 </td>\n   <td style=\"text-align:right;\"> 0.1782797 </td>\n   <td style=\"text-align:right;\"> 0.0574498 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> is_living_stableMissing </td>\n   <td style=\"text-align:right;\"> 1.2729703 </td>\n   <td style=\"text-align:right;\"> 1.1954770 </td>\n   <td style=\"text-align:right;\"> 0.2869565 </td>\n  </tr>\n  <tr grouplength=\"3\"><td colspan=\"5\" style=\"border-bottom: 1px solid;\"><strong>Marital (ref level Married or Partnered)</strong></td></tr>\n<tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> maritalNever married </td>\n   <td style=\"text-align:right;\"> 0.2358692 </td>\n   <td style=\"text-align:right;\"> 0.0874130 </td>\n   <td style=\"text-align:right;\"> 0.0069688 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> maritalSeparated/Divorced/Widowed </td>\n   <td style=\"text-align:right;\"> 0.0987595 </td>\n   <td style=\"text-align:right;\"> 0.1001031 </td>\n   <td style=\"text-align:right;\"> 0.3238495 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;padding-left: 2em;\" indentlevel=\"1\"> mean </td>\n   <td style=\"text-align:left;\"> maritalMissing </td>\n   <td style=\"text-align:right;\"> 0.0036187 </td>\n   <td style=\"text-align:right;\"> 0.8424911 </td>\n   <td style=\"text-align:right;\"> 0.9965729 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean </td>\n   <td style=\"text-align:left;\"> opioid1 </td>\n   <td style=\"text-align:right;\"> 0.2378354 </td>\n   <td style=\"text-align:right;\"> 0.0517281 </td>\n   <td style=\"text-align:right;\"> 0.0000043 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean </td>\n   <td style=\"text-align:left;\"> speed1 </td>\n   <td style=\"text-align:right;\"> -0.1193640 </td>\n   <td style=\"text-align:right;\"> 0.0573867 </td>\n   <td style=\"text-align:right;\"> 0.0375262 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> precision </td>\n   <td style=\"text-align:left;\"> (phi) </td>\n   <td style=\"text-align:right;\"> 1.4512074 </td>\n   <td style=\"text-align:right;\"> 0.0337427 </td>\n   <td style=\"text-align:right;\"> 0.0000000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncat(\"\\n\\n## Estimated marginal means\\n\\n\")\n```\n\n\n\n## Estimated marginal means\n\n```{.r .cell-code}\ncat(\"\\n\\n### Age\\n\\n\")\n```\n\n\n\n### Age\n\n```{.r .cell-code}\nemm_compliance_age <- ggemmeans(beta_compliance_red, \"age\") %>% mutate(outcome=\"compliance\")\nemm_attendance_age <- ggemmeans(beta_attendance_red, \"age\") %>% mutate(outcome=\"attendance\")\n\nbind_rows(emm_attendance_age, emm_compliance_age) %>%\n  ggplot(aes(x=x, y=predicted, ymax=conf.high, ymin=conf.low, color=outcome, fill=outcome)) + geom_smooth() + theme_bw() +scale_y_continuous(label=percent) + geom_ribbon(alpha=0.5, color=NA) + labs(y=\"Estimate\",x=\"Age\") + theme(legend.position = \"bottom\")\n```\n\n![](index_files/figure-html/compliance-1.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n### Age (raw data) \\n\\n\")\n```\n\n\n\n### Age (raw data) \n\n```{.r .cell-code}\ncompliance_results %>% ungroup() %>% dplyr::select(compliance, attendance, age) %>% pivot_longer(-age) %>% ggplot(aes(x=age,y=value, color=name, fill=name)) + geom_point(alpha=0.25) + geom_smooth() + theme_bw() + labs(color=\"Outcome\", fill=\"Outcome\", y=\"Rate\") + theme(legend.position = \"bottom\") + scale_y_continuous(label=percent)\n```\n\n![](index_files/figure-html/compliance-2.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n### Marital\\n\\n\")\n```\n\n\n\n### Marital\n\n```{.r .cell-code}\nemm_compliance_marital <- ggemmeans(beta_compliance_red, \"marital\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_marital <- ggemmeans(beta_attendance_red, \"marital\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_marital, emm_compliance_marital) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"Marital\", x=\"Estimate\") + facet_grid(~outcome)\n```\n\n![](index_files/figure-html/compliance-3.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n### Job\\n\\n\")\n```\n\n\n\n### Job\n\n```{.r .cell-code}\nemm_compliance_job <- ggemmeans(beta_compliance_red, \"job\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_job <- ggemmeans(beta_attendance_red, \"job\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_job, emm_compliance_job) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"Job\", x=\"Estimate\") + facet_grid(~outcome)\n```\n\n![](index_files/figure-html/compliance-4.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n### Opioid\\n\\n\")\n```\n\n\n\n### Opioid\n\n```{.r .cell-code}\nemm_compliance_opioid <- ggemmeans(beta_compliance_red, \"opioid\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_opioid <- ggemmeans(beta_attendance_red, \"opioid\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_opioid, emm_compliance_opioid) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"opioid\", x=\"Estimate\") + facet_grid(~outcome)\n```\n\n![](index_files/figure-html/compliance-5.png){width=2400}\n\n```{.r .cell-code}\n#test_predictions(beta_compliance_red, \"marital\") %>%\n#  kable() %>%\n#  kable_styling()\n\ncat(\"\\n\\n### Race (compliance alone)\\n\\n\")\n```\n\n\n\n### Race (compliance alone)\n\n```{.r .cell-code}\nplot(ggemmeans(beta_compliance_red, \"race\"))\n```\n\n![](index_files/figure-html/compliance-6.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n### Heroin (compliance alone)\\n\\n\")\n```\n\n\n\n### Heroin (compliance alone)\n\n```{.r .cell-code}\nplot(ggemmeans(beta_compliance_red, \"heroin\"))\n```\n\n![](index_files/figure-html/compliance-7.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n### Speed (attendance alone)\\n\\n\")\n```\n\n\n\n### Speed (attendance alone)\n\n```{.r .cell-code}\nplot(ggemmeans(beta_attendance_red, \"speed\"))\n```\n\n![](index_files/figure-html/compliance-8.png){width=2400}\n\n```{.r .cell-code}\ncat(\"\\n\\n### Is living stable (attendance alone)\\n\\n\")\n```\n\n\n\n### Is living stable (attendance alone)\n\n```{.r .cell-code}\nplot(ggemmeans(beta_attendance_red, \"is_living_stable\"))\n```\n\n![](index_files/figure-html/compliance-9.png){width=2400}\n\n\n# CONCLUSIONS\n\nAnalyses of the data indicate that the age of the participant is the most important factor for both successful randomization and higher attendance/compliance, however the effects go in opposite directions:\n\n-   For randomization, the probability of enrollment is lower with increasing age.\n\n-   Once randomized, the rates of attendance and compliance goe up with increasing age.\n\nFor randomization, the other predictors are the total reported drugs and martial status, but in both cases missing is the most important factor  and there, lack of reported data (indicating unwillingness to participate by reporting data?) indicates lower probability of being randomized. The predictive power of this model is quite strong (AUC 0.8, linear calibration curve).\n\nFor compliance and attendance, the predictive power of models are lower. Age remains the most powerful predictor, while other predictors appear to be race, job, marital status, and heroin and opioid.\n\nFuture recruitment of patients into drug treatment trials might try greater outreach to older patients, who seemed less willing to participate but more successful.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}