{"title":"R/Medicine 2024 Data Challenge","markdown":{"yaml":{"title":"R/Medicine 2024 Data Challenge","author":"Mitchell Maltenfort","number-sections":true,"fig-height":8,"fig-width":8,"fig-dpi":300,"execute":{"output":"asis","warning":false,"error":false}},"headingText":"INTRODUCTION","containsRefs":false,"markdown":"\n\n\nThis is my attempt at the analyses requested in <https://rconsortium.github.io/RMedicine_website/Competition.html>. I focused on identifying predictive factors associated with two questions.\n\n1.  Of the potential patients providing data, what factors were associated with succesful randomization?\n\n2.  Defining compliance as the % of potential study weeks where a patient showed up with a negative test, what factors were associated with higher compliance?\n\n```{r setup}\n# load data and packages\nrequire(tidyverse)\nrequire(public.ctn0094data)\nrequire(public.ctn0094extra)\nrequire(pROC)\nrequire(ggeffects)\nrequire(kableExtra)\nrequire(broom)\nrequire(rms)\nrequire(betareg)\nrequire(scales)\nrequire(emmeans)\n```\n\n# SUCCESSFUL RANDOMIZATION\n\nOf the patients listed in 'everybody' which ones are successfully randomized ('randomization')?\n\n```{r randomization}\n# create wide table of drug usge\n\nrbs_wide <-\n  rbs %>%\n  mutate(value = case_when(did_use == \"Yes\" ~ 1, did_use == \"No\" ~ 0)) %>%\n  dplyr::select(who, what, value) %>%\n  right_join(everybody %>% dplyr::select(who)) %>%\n  mutate(value = case_when(is.na(value) ~ 0, TRUE ~ value)) %>%\n  pivot_wider(names_from = what, values_fill = 0) %>%\n  mutate(total_reported_drugs = cocaine + heroin + speedball + opioid + speed) %>%\n  dplyr::select(-`NA`) %>%\n  mutate(total_reported_drugs = as.factor(total_reported_drugs))\n\nrandomization_tbl <-\n  demographics %>%\n  left_join(randomization %>% filter(which == 1)) %>%\n  mutate(randomization = as.factor(case_when(is.na(which) ~ \"0\", TRUE ~ which))) %>%\n  inner_join(rbs_wide) %>%\n  mutate(job = as.factor(case_when(is.na(job) ~ \"Missing\", TRUE ~ job))) %>%\n  mutate(is_living_stable = as.factor(case_when(is.na(is_living_stable) ~ \"Missing\", TRUE ~ is_living_stable))) %>%\n  mutate(education = as.factor(case_when(is.na(education) ~ \"Missing\", TRUE ~ education))) %>%\n  mutate(marital = as.factor(case_when(is.na(marital) ~ \"Missing\", TRUE ~ marital))) %>%\n  mutate(job = fct_relevel(job, \"Missing\", after = Inf)) %>%\n  mutate(is_living_stable = fct_relevel(is_living_stable, \"Missing\", after = Inf)) %>%\n  mutate(education = fct_relevel(education, \"Missing\", after = Inf)) %>%\n  mutate(marital = fct_relevel(marital, \"Missing\", after = Inf)) %>%\n  mutate(cocaine = as.factor(cocaine), heroin = as.factor(heroin), speedball = as.factor(speedball), opioid = as.factor(opioid), speed = as.factor(speed)) %>%\n  inner_join(everybody)\n\n# use optimum penalty of 1 determined manually using 'pentrace'\n\nlrm_randomization <-\n  lrm(randomization ~ pol(age, 2) + job + education + marital + is_male + is_hispanic + race + total_reported_drugs + heroin + speedball + opioid, randomization_tbl, x = TRUE, y = TRUE, penalty = 1)\n\n\ncat(\"\\n\\n## Use bootstrap validation to determine what values are persistent\\n\\n\")\ncat(\"\\n\\n'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs\\n\\n\")\n\nvalidate_randomization <- validate(lrm_randomization, B = 200, bw = TRUE)\n\nsummary(attr(validate_randomization, \"kept\")) %>%\n  kable() %>%\n  kable_styling()\n\nlrm_final <- lrm(randomization ~ pol(age, 2) + marital + total_reported_drugs, randomization_tbl, x = TRUE, y = TRUE, penalty = 1)\n\nrandomization_tbl$predict_randomization <- predict(lrm_final, type = \"fitted\")\n\ncat(\"\\n\\n## Project 51 has almost perfect randomization compared to other two\\n\\n\")\n\nggemmeans(update(lrm_final,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n\ncat(\"\\n\\n## Use bootstrap validtion to determine what values are persistent\\n\\n\")\n\ncoef <- coefficients(lrm_final)\nse <- sqrt(diag(vcov(lrm_final)))\n\ncat(\"\\n\\n## Final logistic regression model predicting successful randomization (log-odds)\\n\\n\")\ncat(\"\\n\\n(factor reference levels based on alphabetical order)\\n\\n\")\ntibble(term = names(coef), coef, se) %>%\n  mutate(p = 2 * case_when(coef > 0 ~ pnorm(coef / se, lower.tail = FALSE), TRUE ~ pnorm(coef / se, lower.tail = TRUE))) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 4, 6) %>%\n  pack_rows(\"Total Reported Drugs (reference level 0)\", 7, 11)\n\n\ncalibrate_final <- calibrate(lrm_final, B = 200)\n\ncalibrate_tbl <-\n  calibrate_final[, c(\"predy\", \"calibrated.orig\", \"calibrated.corrected\")] %>%\n  as_tibble() %>%\n  pivot_longer(calibrated.orig:calibrated.corrected)\n\ncat(\"\\n\\n## Show calibration (predicted vs actual) for predictive model of randomization\\n\\n\")\n\ncalibrate_tbl %>%\n  ggplot(aes(x = predy, y = value, color = name)) +\n  geom_line(linewidth = 1) +\n  theme_bw() +\n  labs(color = \"calibration\", x = \"Predicted Probability\", y = \"Actual Probability\") +\n  theme(legend.position = c(0.8, 0.2)) +\n  geom_abline(linetype = \"dashed\")\n\n\n\nauc <- ci.auc(roc(randomization ~ predict_randomization, data = randomization_tbl %>% filter(!is.na(predict_randomization))))\n\ncat(sprintf(\"\\n\\n## ROC curve AUC is %0.2f (95 percent CI %0.2f - %0.2f)\\n\\n\", auc[2], auc[1], auc[3]))\n\nplot(roc(randomization ~ predict_randomization, data = randomization_tbl %>% filter(!is.na(predict_randomization))))\n\ncat(\"\\n\\n\")\n\ncat(\"\\n\\n## Estimated marginal means\\n\\n\")\n\ncat(\"\\n\\n### Marital\\n\\n\")\nplot(ggemmeans(lrm_final, \"marital\"))\ncat(\"\\n\\n\")\ntest_predictions(lrm_final, \"marital\") %>%\n  kable() %>%\n  kable_styling()\n\ncat(\"\\n\\n### Total reported drugs\\n\\n\")\nplot(ggemmeans(lrm_final, \"total_reported_drugs\"))\ncat(\"\\n\\n\")\ntest_predictions(lrm_final, \"total_reported_drugs\") %>%\n  kable() %>%\n  kable_styling()\n\ncat(\"\\n\\n### Age\\n\\n\")\nplot(ggemmeans(lrm_final, \"age[all]\"))\n```\n\n# ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION\n\nThis adapts the code from 'public.ctn0094extra' vignette to summarise substance use across weeks.\n\nI define compliance as how many times the patient showed up with a negative UDS report, divided by the length of time in the study (Study Week + 1 for Baseline). Attendance is how many times the patient showed up with a report (positive or negative), divided by length of time in the study.\n\nBeta regression is used to create a parsimonious model, pruned \"by hand\" to get rid of irrelevant predictors. The correlation coefficients for these models are not good (R-squared \\< 0.03) but there may be some insight into how to get better attendance or compliance for patients\n\n```{r compliance}\ndata_ls <- loadRawData(c(\"randomization\", \"treatment\"))\n\ndata_ls$randomization <-\n  data_ls$randomization %>%\n  select(who, when, treatment, randomized = which) %>%\n  # Remove second randomization events\n  filter(randomized != 2)\n\ndata_ls$treatment <-\n  data_ls$treatment\n\nstart_int <- c(`27` = -30L, `51` = -30L)\nend_int <- c(`27` = 168L, `51` = 168L)\nbackbone2751_df <-\n  CreateProtocolHistory(\n    start_vec = start_int,\n    end_vec = end_int\n  )\n\nbackbone30_df <-\n  randomization %>%\n  full_join(everybody, by = \"who\") %>%\n  filter(project == \"30\") %>%\n  CreateCTN30ProtocolHistory() %>%\n  mutate(project = \"30\") %>%\n  select(who, project, when)\n\nbackbone_df <-\n  bind_rows(backbone2751_df, backbone30_df) %>%\n  arrange(who)\n\nrm(backbone2751_df, backbone30_df, start_int, end_int)\n\ndata_ls <- loadRawData(c(\"randomization\", \"visit\"))\n\ndata_ls$randomization <-\n  data_ls$randomization %>%\n  select(who, when, treatment, randomized = which) %>%\n  # Remove second randomization events\n  filter(randomized != 2)\n\ndata_ls$visit <-\n  data_ls$visit\n\n\ntimelineRand1_df <-\n  data_ls$randomization %>%\n  mutate(randomized = randomized == \"1\") %>%\n  # Join to backbone and arrange within subject by day\n  full_join(backbone_df, by = c(\"who\", \"when\")) %>%\n  group_by(who) %>%\n  arrange(when, .by_group = TRUE) %>%\n  select(who, project, when, randomized)\n\ntimelineVisit1_df <-\n  data_ls$visit %>%\n  select(who, when, visit, status = what) %>%\n  filter(status %in% c(\"visit\", \"final\")) %>%\n  mutate(visit = TRUE) %>%\n  select(who, when, visit) %>%\n  left_join(timelineRand1_df, ., by = c(\"who\", \"when\")) %>%\n  distinct()\n\ntimelineMissing1_df <- MarkMissing(timelineVisit1_df)\n\nderived_visitImputed <-\n  timelineMissing1_df %>%\n  mutate(visit = as.character(visit)) %>%\n  replace_na(list(visit = \"\", visitYM = \"\")) %>%\n  mutate(visitImputed = paste0(visit, visitYM)) %>%\n  mutate(\n    visitImputed = str_replace(\n      visitImputed,\n      pattern = \"TRUETRUE\", replacement = \"Present\"\n    )\n  ) %>%\n  select(who, when, visitImputed) %>%\n  filter(visitImputed != \"\") %>%\n  ungroup()\n\n\nrandomized_df <-\n  randomization %>%\n  mutate(randomized = as.integer(as.character(which))) %>%\n  select(who, when, randomized) %>%\n  left_join(everybody, by = \"who\") %>%\n  filter(!(randomized == 2 & project %in% c(\"27\", \"51\"))) %>%\n  select(-project)\n\nudsUse2_df <-\n  backbone_df %>%\n  left_join(randomized_df, by = c(\"who\", \"when\")) %>%\n  left_join(derived_visitImputed, by = c(\"who\", \"when\")) %>%\n  left_join(uds, by = c(\"who\", \"when\")) %>%\n  # So we can use MarkUse() with UDS data (instead of all_drugs)\n  mutate(source = \"UDS\")\n\nrm(\n  backbone_df, data_ls, timelineMissing1_df, timelineRand1_df, timelineVisit1_df\n)\n\nnonStudyOpioids_ls <- list(\n  \"Buprenorphine\" = c(\"Opioid\", \"Methadone\"),\n  \"Methadone\"     = c(\"Opioid\", \"Buprenorphine\"),\n  \"Naltrexone\"    = c(\"Opioid\", \"Methadone\", \"Buprenorphine\"),\n  \"Not treated\"   = c(\"Opioid\", \"Methadone\", \"Buprenorphine\")\n)\n\ntreatGroups_ls <-\n  randomization %>%\n  filter(which == 1) %>%\n  left_join(everybody, by = \"who\") %>%\n  select(who, treatment) %>%\n  mutate(\n    treat_drug = case_when(\n      str_detect(treatment, \"BUP\") ~ \"Buprenorphine\",\n      treatment == \"Methadone\" ~ \"Methadone\",\n      treatment == \"Inpatient NR-NTX\" ~ \"Naltrexone\"\n    )\n  ) %>%\n  select(-treatment) %>%\n  split(f = .$treat_drug) %>%\n  map(.f = \"who\")\n\nopioidUse_df <-\n  udsUse2_df %>%\n  mutate(\n    treat_group = case_when(\n      who %in% treatGroups_ls$Buprenorphine ~ \"Buprenorphine\",\n      who %in% treatGroups_ls$Methadone ~ \"Methadone\",\n      who %in% treatGroups_ls$Naltrexone ~ \"Naltrexone\",\n      TRUE ~ \"Not treated\"\n    )\n  ) %>%\n  split(f = .$treat_group) %>%\n  # List of data in alphabetical order, so the non-study drugs ls should match\n  map2(\n    .y = nonStudyOpioids_ls,\n    .f = ~ {\n      # REQUIRES \"source\" COLUMN\n      MarkUse(\n        targetDrugs_char = .y,\n        drugs_df = .x,\n        # because we have participants with no recorded UDS; in practice DO NOT\n        #   use this command\n        retainEmptyRows = TRUE\n      )\n    }\n  ) %>%\n  bind_rows() %>%\n  mutate(\n    udsOpioid = case_when(\n      is.na(when) ~ NA,\n      !is.na(when) ~ TRUE\n    )\n  ) %>%\n  select(who, when, udsOpioid)\n\ntimelineUDS_df <-\n  udsUse2_df %>%\n  left_join(opioidUse_df, by = c(\"who\", \"when\")) %>%\n  select(-what, -source) %>%\n  # 2,089 rows to 1,994\n  distinct()\n\nrm(\n  derived_visitImputed, opioidUse_df, randomized_df, treatGroups_ls, udsUse2_df\n)\n\nwasRandomized_int <-\n  timelineUDS_df %>%\n  group_by(who) %>%\n  summarise(randomized = any(randomized %in% 1:2)) %>%\n  filter(randomized) %>%\n  pull(who)\nnotRandomized_int <-\n  timelineUDS_df %>%\n  filter(!(who %in% wasRandomized_int)) %>%\n  pull(who) %>%\n  unique()\n\ntimelineUDS2_df <-\n  timelineUDS_df %>%\n  filter(who %in% wasRandomized_int) %>%\n  group_by(who) %>%\n  filter(!is.na(randomized)) %>%\n  mutate(\n    whenRandomized1 = case_when(randomized == 1 ~ when),\n    whenRandomized2 = case_when(randomized == 2 ~ when)\n  ) %>%\n  select(who, when, whenRandomized1, whenRandomized2) %>%\n  left_join(timelineUDS_df, ., by = c(\"who\", \"when\")) %>%\n  filter(who %in% wasRandomized_int) %>%\n  # Add back in the groupings BEFORE the fill()\n  group_by(who) %>%\n  fill(whenRandomized1, .direction = \"updown\") %>%\n  fill(whenRandomized2, .direction = \"updown\") %>%\n  mutate(daysSinceRand1 = when - whenRandomized1) %>%\n  mutate(daysSinceRand2 = when - whenRandomized2) %>%\n  select(-whenRandomized1, -whenRandomized2)\n\nweeklyUse_df <-\n  timelineUDS2_df %>%\n  # The (daysSinceRand1 - 1) adjustment is to ensure that the first study week\n  #   is a full 7 days, since \"day 0\" is the day before randomization. The \"+1\"\n  #   at the end is to shift the study week label such that \"week 0\" is the\n  #   week *BEFORE* treatment, rather than the first week of treatment. So, the\n  #   randomization day is the last day of \"week 0\" (the pre-treatment period).\n  mutate(studyWeek1 = (daysSinceRand1 - 1) %/% 7 + 1) %>%\n  mutate(studyWeek2 = (daysSinceRand2 - 1) %/% 7 + 1) %>%\n  group_by(who, studyWeek1) %>%\n  # There are some study weeks with multiple UDS, so we count the number of\n  #   positive and negative UDS per week.\n  summarise(\n    nPosUDS  = sum(udsOpioid == 1, na.rm = TRUE),\n    nNegUDS  = sum(visitImputed == \"Present\" & is.na(udsOpioid), na.rm = TRUE),\n    nMissing = sum(visitImputed == \"Missing\", na.rm = TRUE),\n    randWk1  = sum(randomized == 1, na.rm = TRUE) > 0,\n    randWk2  = sum(randomized == 2 & project == \"30\", na.rm = TRUE) > 0\n  ) %>%\n  ungroup()\n\nuseByWeekRandomized_df <-\n  weeklyUse_df %>%\n  mutate(\n    udsStatus = case_when(\n      # If we see a positive UDS and no negative UDS, it's positive\n      nPosUDS > 0 & nNegUDS == 0 ~ \"+\",\n      # If we see a negative UDS and no positive UDS, it's negative\n      nPosUDS == 0 & nNegUDS > 0 ~ \"-\",\n      # If we see both positive and negative UDS in a single week, it's both\n      #   (note that we can recode all \"B\"s to be \"+\" as necessary)\n      nPosUDS > 0 & nNegUDS > 0 ~ \"*\",\n      # If we don't have any UDS in a week after randomization, it's missing\n      # UPDATE 2022-03-08: I had this as a 0 originally, and I was using this\n      #   in context of consent, not randomization. This was wrong.\n      nPosUDS == 0 & nNegUDS == 0 & studyWeek1 >= 1 ~ \"o\",\n      # If none of the above are true, but we still have a missing value as\n      #   marked by the MarkMissing() function, then it's missing\n      nMissing > 0 ~ \"o\",\n      # If none of the above conditions are true (probably because it's a week\n      #   before randomization but not during a baseline visit for consent),\n      #   then leave it blank (pre-study)\n      TRUE ~ \"_\"\n    )\n  ) %>%\n  group_by(who) %>%\n  # For CTN-0030, Phase II could have started on any day of the week, even in\n  #   the middle of a treatment week. If we try to start counting Phase II\n  #   weeks the day after treatment arms are switched, we can end up with the\n  #   last \"week\" of Phase I not having 7 days. I'm going to leave the first\n  #   week of Phase II as whatever week the switch happened in.\n  mutate(\n    rand1Active = studyWeek1 > 0,\n    # This returns 0 for any week before the Phase II randomization, and 1 for\n    #   the Phase II randomization week and all subsequent weeks (because the\n    #   randWk2 column is 1 only for the week of second randomization and 0\n    #   all other rows).\n    rand2Active = cumsum(randWk2),\n    trialPhase  = rand1Active + rand2Active\n  ) %>%\n  dplyr::select(\n    who,\n    studyWeek = studyWeek1, randWk1, randWk2, udsStatus, trialPhase\n  )\n\n\n#### NEW\n\n\ncompliance_results <-\n  useByWeekRandomized_df %>%\n  filter(trialPhase == 1) %>%\n  filter(studyWeek >= 0) %>%\n  inner_join(everybody) %>%\n  group_by(project, who) %>%\n  summarise(sum_pos = sum(udsStatus == \"+\"), sum_neg = sum(udsStatus == \"-\"), sumMissing = sum(udsStatus == \"o\"), total_weeks = 1 + max(studyWeek)) %>%\n  mutate(compliance = sum_neg / total_weeks, attendance = (sum_neg+sum_pos)/total_weeks) %>%\n  inner_join(randomization_tbl %>% dplyr::select(who, age, is_hispanic, race, job, education, is_living_stable, marital, is_male, cocaine:total_reported_drugs, predict_randomization)) %>%\n  mutate(project=as.factor(project))\n\n# from https://stats.stackexchange.com/questions/31300/dealing-with-0-1-values-in-a-beta-regression\n# squeeze 0 and 1 so can use beta regression\n\nN <- dim(compliance_results)[1]\n\ncompliance_results <- mutate(compliance_results, squeeze_compliance = (compliance * (N - 1) + 0.5) / N, squeeze_attendance = (attendance * (N - 1) + 0.5) / N)\n\n\nbeta_compliance <- betareg(squeeze_compliance ~ age + is_hispanic + race + education + job + is_living_stable + marital + is_male + cocaine + heroin + speedball + opioid + speed, compliance_results)\n\nbeta_compliance_red <- betareg(squeeze_compliance ~ age + race + job + marital + heroin + opioid, compliance_results)\n\nbeta_attendance <- betareg(squeeze_attendance ~ age + is_hispanic + race + education + job + is_living_stable + marital + is_male + cocaine + heroin + speedball + opioid + speed, compliance_results)\n\nbeta_attendance_red <- betareg(squeeze_attendance ~ age   + job + is_living_stable + marital + opioid + speed, compliance_results)\n\n\n\n\n\ncat(\"\\n\\n## Beta regression coefficients (factor reference levels based on alphabetical order)\\n\\n\")\n\n\ncat(\"\\n\\n### Compliance\\n\\n\")\n\ntidy(beta_compliance_red) %>%\n  dplyr::select(-statistic) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Race (reference level Black)\", 3, 5) %>%\n  pack_rows(\"job (reference level Full Time)\", 6, 10) %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 11, 13)\n\n\ncat(\"\\n\\n### No major difference between Projects\\n\\n\")\n\ncat(\"\\n\\nUpdate models by adding project and look for marginal means between projects\\n\\n\")\n\ncat(\"\\n\\n#### Compliance\\n\\n\")\n\nggemmeans(update(beta_compliance_red,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n\ncat(\"\\n\\n#### Attendance\\n\\n\")\n\nggemmeans(update(beta_attendance_red,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n\ncat(\"\\n\\n### Attendance\\n\\n\")\n\ntidy(beta_attendance_red) %>%\n  dplyr::select(-statistic) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Job (reference level Full Time)\", 3, 7) %>%\n  pack_rows(\"Is living stable (reference level No)\", 8, 9) %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 10, 12)\n\n\ncat(\"\\n\\n## Estimated marginal means\\n\\n\")\n\ncat(\"\\n\\n### Age\\n\\n\")\n\nemm_compliance_age <- ggemmeans(beta_compliance_red, \"age\") %>% mutate(outcome=\"compliance\")\nemm_attendance_age <- ggemmeans(beta_attendance_red, \"age\") %>% mutate(outcome=\"attendance\")\n\nbind_rows(emm_attendance_age, emm_compliance_age) %>%\n  ggplot(aes(x=x, y=predicted, ymax=conf.high, ymin=conf.low, color=outcome, fill=outcome)) + geom_smooth() + theme_bw() +scale_y_continuous(label=percent) + geom_ribbon(alpha=0.5, color=NA) + labs(y=\"Estimate\",x=\"Age\") + theme(legend.position = \"bottom\")\n\ncat(\"\\n\\n### Age (raw data) \\n\\n\")\n\n\ncompliance_results %>% ungroup() %>% dplyr::select(compliance, attendance, age) %>% pivot_longer(-age) %>% ggplot(aes(x=age,y=value, color=name, fill=name)) + geom_point(alpha=0.25) + geom_smooth() + theme_bw() + labs(color=\"Outcome\", fill=\"Outcome\", y=\"Rate\") + theme(legend.position = \"bottom\") + scale_y_continuous(label=percent)\n\ncat(\"\\n\\n### Marital\\n\\n\")\n\nemm_compliance_marital <- ggemmeans(beta_compliance_red, \"marital\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_marital <- ggemmeans(beta_attendance_red, \"marital\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_marital, emm_compliance_marital) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"Marital\", x=\"Estimate\") + facet_grid(~outcome)\n\ncat(\"\\n\\n### Job\\n\\n\")\n\nemm_compliance_job <- ggemmeans(beta_compliance_red, \"job\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_job <- ggemmeans(beta_attendance_red, \"job\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_job, emm_compliance_job) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"Job\", x=\"Estimate\") + facet_grid(~outcome)\n\ncat(\"\\n\\n### Opioid\\n\\n\")\n\nemm_compliance_opioid <- ggemmeans(beta_compliance_red, \"opioid\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_opioid <- ggemmeans(beta_attendance_red, \"opioid\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_opioid, emm_compliance_opioid) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"opioid\", x=\"Estimate\") + facet_grid(~outcome)\n\n\n#test_predictions(beta_compliance_red, \"marital\") %>%\n#  kable() %>%\n#  kable_styling()\n\ncat(\"\\n\\n### Race (compliance alone)\\n\\n\")\nplot(ggemmeans(beta_compliance_red, \"race\"))\n\ncat(\"\\n\\n### Heroin (compliance alone)\\n\\n\")\nplot(ggemmeans(beta_compliance_red, \"heroin\"))\n\ncat(\"\\n\\n### Speed (attendance alone)\\n\\n\")\nplot(ggemmeans(beta_attendance_red, \"speed\"))\n\ncat(\"\\n\\n### Is living stable (attendance alone)\\n\\n\")\nplot(ggemmeans(beta_attendance_red, \"is_living_stable\"))\n\n\n\n\n```\n\n# CONCLUSIONS\n\nAnalyses of the data indicate that the age of the participant is the most important factor for both successful randomization and higher attendance/compliance, however the effects go in opposite directions:\n\n-   For randomization, the probability of enrollment is lower with increasing age.\n\n-   Once randomized, the rates of attendance and compliance goe up with increasing age.\n\nFor randomization, the other predictors are the total reported drugs and martial status, but in both cases missing is the most important factor – and there, lack of reported data (indicating unwillingness to participate by reporting data?) indicates lower probability of being randomized. The predictive power of this model is quite strong (AUC 0.8, linear calibration curve).\n\nFor compliance and attendance, the predictive power of models are lower. Age remains the most powerful predictor, while other predictors appear to be race, job, marital status, and heroin and opioid.\n\nFuture recruitment of patients into drug treatment trials might try greater outreach to older patients, who seemed less willing to participate but more successful.\n","srcMarkdownNoYaml":"\n\n# INTRODUCTION\n\nThis is my attempt at the analyses requested in <https://rconsortium.github.io/RMedicine_website/Competition.html>. I focused on identifying predictive factors associated with two questions.\n\n1.  Of the potential patients providing data, what factors were associated with succesful randomization?\n\n2.  Defining compliance as the % of potential study weeks where a patient showed up with a negative test, what factors were associated with higher compliance?\n\n```{r setup}\n# load data and packages\nrequire(tidyverse)\nrequire(public.ctn0094data)\nrequire(public.ctn0094extra)\nrequire(pROC)\nrequire(ggeffects)\nrequire(kableExtra)\nrequire(broom)\nrequire(rms)\nrequire(betareg)\nrequire(scales)\nrequire(emmeans)\n```\n\n# SUCCESSFUL RANDOMIZATION\n\nOf the patients listed in 'everybody' which ones are successfully randomized ('randomization')?\n\n```{r randomization}\n# create wide table of drug usge\n\nrbs_wide <-\n  rbs %>%\n  mutate(value = case_when(did_use == \"Yes\" ~ 1, did_use == \"No\" ~ 0)) %>%\n  dplyr::select(who, what, value) %>%\n  right_join(everybody %>% dplyr::select(who)) %>%\n  mutate(value = case_when(is.na(value) ~ 0, TRUE ~ value)) %>%\n  pivot_wider(names_from = what, values_fill = 0) %>%\n  mutate(total_reported_drugs = cocaine + heroin + speedball + opioid + speed) %>%\n  dplyr::select(-`NA`) %>%\n  mutate(total_reported_drugs = as.factor(total_reported_drugs))\n\nrandomization_tbl <-\n  demographics %>%\n  left_join(randomization %>% filter(which == 1)) %>%\n  mutate(randomization = as.factor(case_when(is.na(which) ~ \"0\", TRUE ~ which))) %>%\n  inner_join(rbs_wide) %>%\n  mutate(job = as.factor(case_when(is.na(job) ~ \"Missing\", TRUE ~ job))) %>%\n  mutate(is_living_stable = as.factor(case_when(is.na(is_living_stable) ~ \"Missing\", TRUE ~ is_living_stable))) %>%\n  mutate(education = as.factor(case_when(is.na(education) ~ \"Missing\", TRUE ~ education))) %>%\n  mutate(marital = as.factor(case_when(is.na(marital) ~ \"Missing\", TRUE ~ marital))) %>%\n  mutate(job = fct_relevel(job, \"Missing\", after = Inf)) %>%\n  mutate(is_living_stable = fct_relevel(is_living_stable, \"Missing\", after = Inf)) %>%\n  mutate(education = fct_relevel(education, \"Missing\", after = Inf)) %>%\n  mutate(marital = fct_relevel(marital, \"Missing\", after = Inf)) %>%\n  mutate(cocaine = as.factor(cocaine), heroin = as.factor(heroin), speedball = as.factor(speedball), opioid = as.factor(opioid), speed = as.factor(speed)) %>%\n  inner_join(everybody)\n\n# use optimum penalty of 1 determined manually using 'pentrace'\n\nlrm_randomization <-\n  lrm(randomization ~ pol(age, 2) + job + education + marital + is_male + is_hispanic + race + total_reported_drugs + heroin + speedball + opioid, randomization_tbl, x = TRUE, y = TRUE, penalty = 1)\n\n\ncat(\"\\n\\n## Use bootstrap validation to determine what values are persistent\\n\\n\")\ncat(\"\\n\\n'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs\\n\\n\")\n\nvalidate_randomization <- validate(lrm_randomization, B = 200, bw = TRUE)\n\nsummary(attr(validate_randomization, \"kept\")) %>%\n  kable() %>%\n  kable_styling()\n\nlrm_final <- lrm(randomization ~ pol(age, 2) + marital + total_reported_drugs, randomization_tbl, x = TRUE, y = TRUE, penalty = 1)\n\nrandomization_tbl$predict_randomization <- predict(lrm_final, type = \"fitted\")\n\ncat(\"\\n\\n## Project 51 has almost perfect randomization compared to other two\\n\\n\")\n\nggemmeans(update(lrm_final,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n\ncat(\"\\n\\n## Use bootstrap validtion to determine what values are persistent\\n\\n\")\n\ncoef <- coefficients(lrm_final)\nse <- sqrt(diag(vcov(lrm_final)))\n\ncat(\"\\n\\n## Final logistic regression model predicting successful randomization (log-odds)\\n\\n\")\ncat(\"\\n\\n(factor reference levels based on alphabetical order)\\n\\n\")\ntibble(term = names(coef), coef, se) %>%\n  mutate(p = 2 * case_when(coef > 0 ~ pnorm(coef / se, lower.tail = FALSE), TRUE ~ pnorm(coef / se, lower.tail = TRUE))) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 4, 6) %>%\n  pack_rows(\"Total Reported Drugs (reference level 0)\", 7, 11)\n\n\ncalibrate_final <- calibrate(lrm_final, B = 200)\n\ncalibrate_tbl <-\n  calibrate_final[, c(\"predy\", \"calibrated.orig\", \"calibrated.corrected\")] %>%\n  as_tibble() %>%\n  pivot_longer(calibrated.orig:calibrated.corrected)\n\ncat(\"\\n\\n## Show calibration (predicted vs actual) for predictive model of randomization\\n\\n\")\n\ncalibrate_tbl %>%\n  ggplot(aes(x = predy, y = value, color = name)) +\n  geom_line(linewidth = 1) +\n  theme_bw() +\n  labs(color = \"calibration\", x = \"Predicted Probability\", y = \"Actual Probability\") +\n  theme(legend.position = c(0.8, 0.2)) +\n  geom_abline(linetype = \"dashed\")\n\n\n\nauc <- ci.auc(roc(randomization ~ predict_randomization, data = randomization_tbl %>% filter(!is.na(predict_randomization))))\n\ncat(sprintf(\"\\n\\n## ROC curve AUC is %0.2f (95 percent CI %0.2f - %0.2f)\\n\\n\", auc[2], auc[1], auc[3]))\n\nplot(roc(randomization ~ predict_randomization, data = randomization_tbl %>% filter(!is.na(predict_randomization))))\n\ncat(\"\\n\\n\")\n\ncat(\"\\n\\n## Estimated marginal means\\n\\n\")\n\ncat(\"\\n\\n### Marital\\n\\n\")\nplot(ggemmeans(lrm_final, \"marital\"))\ncat(\"\\n\\n\")\ntest_predictions(lrm_final, \"marital\") %>%\n  kable() %>%\n  kable_styling()\n\ncat(\"\\n\\n### Total reported drugs\\n\\n\")\nplot(ggemmeans(lrm_final, \"total_reported_drugs\"))\ncat(\"\\n\\n\")\ntest_predictions(lrm_final, \"total_reported_drugs\") %>%\n  kable() %>%\n  kable_styling()\n\ncat(\"\\n\\n### Age\\n\\n\")\nplot(ggemmeans(lrm_final, \"age[all]\"))\n```\n\n# ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION\n\nThis adapts the code from 'public.ctn0094extra' vignette to summarise substance use across weeks.\n\nI define compliance as how many times the patient showed up with a negative UDS report, divided by the length of time in the study (Study Week + 1 for Baseline). Attendance is how many times the patient showed up with a report (positive or negative), divided by length of time in the study.\n\nBeta regression is used to create a parsimonious model, pruned \"by hand\" to get rid of irrelevant predictors. The correlation coefficients for these models are not good (R-squared \\< 0.03) but there may be some insight into how to get better attendance or compliance for patients\n\n```{r compliance}\ndata_ls <- loadRawData(c(\"randomization\", \"treatment\"))\n\ndata_ls$randomization <-\n  data_ls$randomization %>%\n  select(who, when, treatment, randomized = which) %>%\n  # Remove second randomization events\n  filter(randomized != 2)\n\ndata_ls$treatment <-\n  data_ls$treatment\n\nstart_int <- c(`27` = -30L, `51` = -30L)\nend_int <- c(`27` = 168L, `51` = 168L)\nbackbone2751_df <-\n  CreateProtocolHistory(\n    start_vec = start_int,\n    end_vec = end_int\n  )\n\nbackbone30_df <-\n  randomization %>%\n  full_join(everybody, by = \"who\") %>%\n  filter(project == \"30\") %>%\n  CreateCTN30ProtocolHistory() %>%\n  mutate(project = \"30\") %>%\n  select(who, project, when)\n\nbackbone_df <-\n  bind_rows(backbone2751_df, backbone30_df) %>%\n  arrange(who)\n\nrm(backbone2751_df, backbone30_df, start_int, end_int)\n\ndata_ls <- loadRawData(c(\"randomization\", \"visit\"))\n\ndata_ls$randomization <-\n  data_ls$randomization %>%\n  select(who, when, treatment, randomized = which) %>%\n  # Remove second randomization events\n  filter(randomized != 2)\n\ndata_ls$visit <-\n  data_ls$visit\n\n\ntimelineRand1_df <-\n  data_ls$randomization %>%\n  mutate(randomized = randomized == \"1\") %>%\n  # Join to backbone and arrange within subject by day\n  full_join(backbone_df, by = c(\"who\", \"when\")) %>%\n  group_by(who) %>%\n  arrange(when, .by_group = TRUE) %>%\n  select(who, project, when, randomized)\n\ntimelineVisit1_df <-\n  data_ls$visit %>%\n  select(who, when, visit, status = what) %>%\n  filter(status %in% c(\"visit\", \"final\")) %>%\n  mutate(visit = TRUE) %>%\n  select(who, when, visit) %>%\n  left_join(timelineRand1_df, ., by = c(\"who\", \"when\")) %>%\n  distinct()\n\ntimelineMissing1_df <- MarkMissing(timelineVisit1_df)\n\nderived_visitImputed <-\n  timelineMissing1_df %>%\n  mutate(visit = as.character(visit)) %>%\n  replace_na(list(visit = \"\", visitYM = \"\")) %>%\n  mutate(visitImputed = paste0(visit, visitYM)) %>%\n  mutate(\n    visitImputed = str_replace(\n      visitImputed,\n      pattern = \"TRUETRUE\", replacement = \"Present\"\n    )\n  ) %>%\n  select(who, when, visitImputed) %>%\n  filter(visitImputed != \"\") %>%\n  ungroup()\n\n\nrandomized_df <-\n  randomization %>%\n  mutate(randomized = as.integer(as.character(which))) %>%\n  select(who, when, randomized) %>%\n  left_join(everybody, by = \"who\") %>%\n  filter(!(randomized == 2 & project %in% c(\"27\", \"51\"))) %>%\n  select(-project)\n\nudsUse2_df <-\n  backbone_df %>%\n  left_join(randomized_df, by = c(\"who\", \"when\")) %>%\n  left_join(derived_visitImputed, by = c(\"who\", \"when\")) %>%\n  left_join(uds, by = c(\"who\", \"when\")) %>%\n  # So we can use MarkUse() with UDS data (instead of all_drugs)\n  mutate(source = \"UDS\")\n\nrm(\n  backbone_df, data_ls, timelineMissing1_df, timelineRand1_df, timelineVisit1_df\n)\n\nnonStudyOpioids_ls <- list(\n  \"Buprenorphine\" = c(\"Opioid\", \"Methadone\"),\n  \"Methadone\"     = c(\"Opioid\", \"Buprenorphine\"),\n  \"Naltrexone\"    = c(\"Opioid\", \"Methadone\", \"Buprenorphine\"),\n  \"Not treated\"   = c(\"Opioid\", \"Methadone\", \"Buprenorphine\")\n)\n\ntreatGroups_ls <-\n  randomization %>%\n  filter(which == 1) %>%\n  left_join(everybody, by = \"who\") %>%\n  select(who, treatment) %>%\n  mutate(\n    treat_drug = case_when(\n      str_detect(treatment, \"BUP\") ~ \"Buprenorphine\",\n      treatment == \"Methadone\" ~ \"Methadone\",\n      treatment == \"Inpatient NR-NTX\" ~ \"Naltrexone\"\n    )\n  ) %>%\n  select(-treatment) %>%\n  split(f = .$treat_drug) %>%\n  map(.f = \"who\")\n\nopioidUse_df <-\n  udsUse2_df %>%\n  mutate(\n    treat_group = case_when(\n      who %in% treatGroups_ls$Buprenorphine ~ \"Buprenorphine\",\n      who %in% treatGroups_ls$Methadone ~ \"Methadone\",\n      who %in% treatGroups_ls$Naltrexone ~ \"Naltrexone\",\n      TRUE ~ \"Not treated\"\n    )\n  ) %>%\n  split(f = .$treat_group) %>%\n  # List of data in alphabetical order, so the non-study drugs ls should match\n  map2(\n    .y = nonStudyOpioids_ls,\n    .f = ~ {\n      # REQUIRES \"source\" COLUMN\n      MarkUse(\n        targetDrugs_char = .y,\n        drugs_df = .x,\n        # because we have participants with no recorded UDS; in practice DO NOT\n        #   use this command\n        retainEmptyRows = TRUE\n      )\n    }\n  ) %>%\n  bind_rows() %>%\n  mutate(\n    udsOpioid = case_when(\n      is.na(when) ~ NA,\n      !is.na(when) ~ TRUE\n    )\n  ) %>%\n  select(who, when, udsOpioid)\n\ntimelineUDS_df <-\n  udsUse2_df %>%\n  left_join(opioidUse_df, by = c(\"who\", \"when\")) %>%\n  select(-what, -source) %>%\n  # 2,089 rows to 1,994\n  distinct()\n\nrm(\n  derived_visitImputed, opioidUse_df, randomized_df, treatGroups_ls, udsUse2_df\n)\n\nwasRandomized_int <-\n  timelineUDS_df %>%\n  group_by(who) %>%\n  summarise(randomized = any(randomized %in% 1:2)) %>%\n  filter(randomized) %>%\n  pull(who)\nnotRandomized_int <-\n  timelineUDS_df %>%\n  filter(!(who %in% wasRandomized_int)) %>%\n  pull(who) %>%\n  unique()\n\ntimelineUDS2_df <-\n  timelineUDS_df %>%\n  filter(who %in% wasRandomized_int) %>%\n  group_by(who) %>%\n  filter(!is.na(randomized)) %>%\n  mutate(\n    whenRandomized1 = case_when(randomized == 1 ~ when),\n    whenRandomized2 = case_when(randomized == 2 ~ when)\n  ) %>%\n  select(who, when, whenRandomized1, whenRandomized2) %>%\n  left_join(timelineUDS_df, ., by = c(\"who\", \"when\")) %>%\n  filter(who %in% wasRandomized_int) %>%\n  # Add back in the groupings BEFORE the fill()\n  group_by(who) %>%\n  fill(whenRandomized1, .direction = \"updown\") %>%\n  fill(whenRandomized2, .direction = \"updown\") %>%\n  mutate(daysSinceRand1 = when - whenRandomized1) %>%\n  mutate(daysSinceRand2 = when - whenRandomized2) %>%\n  select(-whenRandomized1, -whenRandomized2)\n\nweeklyUse_df <-\n  timelineUDS2_df %>%\n  # The (daysSinceRand1 - 1) adjustment is to ensure that the first study week\n  #   is a full 7 days, since \"day 0\" is the day before randomization. The \"+1\"\n  #   at the end is to shift the study week label such that \"week 0\" is the\n  #   week *BEFORE* treatment, rather than the first week of treatment. So, the\n  #   randomization day is the last day of \"week 0\" (the pre-treatment period).\n  mutate(studyWeek1 = (daysSinceRand1 - 1) %/% 7 + 1) %>%\n  mutate(studyWeek2 = (daysSinceRand2 - 1) %/% 7 + 1) %>%\n  group_by(who, studyWeek1) %>%\n  # There are some study weeks with multiple UDS, so we count the number of\n  #   positive and negative UDS per week.\n  summarise(\n    nPosUDS  = sum(udsOpioid == 1, na.rm = TRUE),\n    nNegUDS  = sum(visitImputed == \"Present\" & is.na(udsOpioid), na.rm = TRUE),\n    nMissing = sum(visitImputed == \"Missing\", na.rm = TRUE),\n    randWk1  = sum(randomized == 1, na.rm = TRUE) > 0,\n    randWk2  = sum(randomized == 2 & project == \"30\", na.rm = TRUE) > 0\n  ) %>%\n  ungroup()\n\nuseByWeekRandomized_df <-\n  weeklyUse_df %>%\n  mutate(\n    udsStatus = case_when(\n      # If we see a positive UDS and no negative UDS, it's positive\n      nPosUDS > 0 & nNegUDS == 0 ~ \"+\",\n      # If we see a negative UDS and no positive UDS, it's negative\n      nPosUDS == 0 & nNegUDS > 0 ~ \"-\",\n      # If we see both positive and negative UDS in a single week, it's both\n      #   (note that we can recode all \"B\"s to be \"+\" as necessary)\n      nPosUDS > 0 & nNegUDS > 0 ~ \"*\",\n      # If we don't have any UDS in a week after randomization, it's missing\n      # UPDATE 2022-03-08: I had this as a 0 originally, and I was using this\n      #   in context of consent, not randomization. This was wrong.\n      nPosUDS == 0 & nNegUDS == 0 & studyWeek1 >= 1 ~ \"o\",\n      # If none of the above are true, but we still have a missing value as\n      #   marked by the MarkMissing() function, then it's missing\n      nMissing > 0 ~ \"o\",\n      # If none of the above conditions are true (probably because it's a week\n      #   before randomization but not during a baseline visit for consent),\n      #   then leave it blank (pre-study)\n      TRUE ~ \"_\"\n    )\n  ) %>%\n  group_by(who) %>%\n  # For CTN-0030, Phase II could have started on any day of the week, even in\n  #   the middle of a treatment week. If we try to start counting Phase II\n  #   weeks the day after treatment arms are switched, we can end up with the\n  #   last \"week\" of Phase I not having 7 days. I'm going to leave the first\n  #   week of Phase II as whatever week the switch happened in.\n  mutate(\n    rand1Active = studyWeek1 > 0,\n    # This returns 0 for any week before the Phase II randomization, and 1 for\n    #   the Phase II randomization week and all subsequent weeks (because the\n    #   randWk2 column is 1 only for the week of second randomization and 0\n    #   all other rows).\n    rand2Active = cumsum(randWk2),\n    trialPhase  = rand1Active + rand2Active\n  ) %>%\n  dplyr::select(\n    who,\n    studyWeek = studyWeek1, randWk1, randWk2, udsStatus, trialPhase\n  )\n\n\n#### NEW\n\n\ncompliance_results <-\n  useByWeekRandomized_df %>%\n  filter(trialPhase == 1) %>%\n  filter(studyWeek >= 0) %>%\n  inner_join(everybody) %>%\n  group_by(project, who) %>%\n  summarise(sum_pos = sum(udsStatus == \"+\"), sum_neg = sum(udsStatus == \"-\"), sumMissing = sum(udsStatus == \"o\"), total_weeks = 1 + max(studyWeek)) %>%\n  mutate(compliance = sum_neg / total_weeks, attendance = (sum_neg+sum_pos)/total_weeks) %>%\n  inner_join(randomization_tbl %>% dplyr::select(who, age, is_hispanic, race, job, education, is_living_stable, marital, is_male, cocaine:total_reported_drugs, predict_randomization)) %>%\n  mutate(project=as.factor(project))\n\n# from https://stats.stackexchange.com/questions/31300/dealing-with-0-1-values-in-a-beta-regression\n# squeeze 0 and 1 so can use beta regression\n\nN <- dim(compliance_results)[1]\n\ncompliance_results <- mutate(compliance_results, squeeze_compliance = (compliance * (N - 1) + 0.5) / N, squeeze_attendance = (attendance * (N - 1) + 0.5) / N)\n\n\nbeta_compliance <- betareg(squeeze_compliance ~ age + is_hispanic + race + education + job + is_living_stable + marital + is_male + cocaine + heroin + speedball + opioid + speed, compliance_results)\n\nbeta_compliance_red <- betareg(squeeze_compliance ~ age + race + job + marital + heroin + opioid, compliance_results)\n\nbeta_attendance <- betareg(squeeze_attendance ~ age + is_hispanic + race + education + job + is_living_stable + marital + is_male + cocaine + heroin + speedball + opioid + speed, compliance_results)\n\nbeta_attendance_red <- betareg(squeeze_attendance ~ age   + job + is_living_stable + marital + opioid + speed, compliance_results)\n\n\n\n\n\ncat(\"\\n\\n## Beta regression coefficients (factor reference levels based on alphabetical order)\\n\\n\")\n\n\ncat(\"\\n\\n### Compliance\\n\\n\")\n\ntidy(beta_compliance_red) %>%\n  dplyr::select(-statistic) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Race (reference level Black)\", 3, 5) %>%\n  pack_rows(\"job (reference level Full Time)\", 6, 10) %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 11, 13)\n\n\ncat(\"\\n\\n### No major difference between Projects\\n\\n\")\n\ncat(\"\\n\\nUpdate models by adding project and look for marginal means between projects\\n\\n\")\n\ncat(\"\\n\\n#### Compliance\\n\\n\")\n\nggemmeans(update(beta_compliance_red,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n\ncat(\"\\n\\n#### Attendance\\n\\n\")\n\nggemmeans(update(beta_attendance_red,.~.+project),\"project\") %>% as.data.frame()   %>% dplyr::select(project=x, predicted, conf.low, conf.high) %>% kable() %>% kable_styling()\n\ncat(\"\\n\\n### Attendance\\n\\n\")\n\ntidy(beta_attendance_red) %>%\n  dplyr::select(-statistic) %>%\n  kable() %>%\n  kable_styling() %>%\n  pack_rows(\"Job (reference level Full Time)\", 3, 7) %>%\n  pack_rows(\"Is living stable (reference level No)\", 8, 9) %>%\n  pack_rows(\"Marital (ref level Married or Partnered)\", 10, 12)\n\n\ncat(\"\\n\\n## Estimated marginal means\\n\\n\")\n\ncat(\"\\n\\n### Age\\n\\n\")\n\nemm_compliance_age <- ggemmeans(beta_compliance_red, \"age\") %>% mutate(outcome=\"compliance\")\nemm_attendance_age <- ggemmeans(beta_attendance_red, \"age\") %>% mutate(outcome=\"attendance\")\n\nbind_rows(emm_attendance_age, emm_compliance_age) %>%\n  ggplot(aes(x=x, y=predicted, ymax=conf.high, ymin=conf.low, color=outcome, fill=outcome)) + geom_smooth() + theme_bw() +scale_y_continuous(label=percent) + geom_ribbon(alpha=0.5, color=NA) + labs(y=\"Estimate\",x=\"Age\") + theme(legend.position = \"bottom\")\n\ncat(\"\\n\\n### Age (raw data) \\n\\n\")\n\n\ncompliance_results %>% ungroup() %>% dplyr::select(compliance, attendance, age) %>% pivot_longer(-age) %>% ggplot(aes(x=age,y=value, color=name, fill=name)) + geom_point(alpha=0.25) + geom_smooth() + theme_bw() + labs(color=\"Outcome\", fill=\"Outcome\", y=\"Rate\") + theme(legend.position = \"bottom\") + scale_y_continuous(label=percent)\n\ncat(\"\\n\\n### Marital\\n\\n\")\n\nemm_compliance_marital <- ggemmeans(beta_compliance_red, \"marital\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_marital <- ggemmeans(beta_attendance_red, \"marital\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_marital, emm_compliance_marital) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"Marital\", x=\"Estimate\") + facet_grid(~outcome)\n\ncat(\"\\n\\n### Job\\n\\n\")\n\nemm_compliance_job <- ggemmeans(beta_compliance_red, \"job\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_job <- ggemmeans(beta_attendance_red, \"job\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_job, emm_compliance_job) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"Job\", x=\"Estimate\") + facet_grid(~outcome)\n\ncat(\"\\n\\n### Opioid\\n\\n\")\n\nemm_compliance_opioid <- ggemmeans(beta_compliance_red, \"opioid\") %>% mutate(outcome=\"compliance\") %>% as.data.frame()\nemm_attendance_opioid <- ggemmeans(beta_attendance_red, \"opioid\") %>% mutate(outcome=\"attendance\")%>% as.data.frame()\nbind_rows(emm_attendance_opioid, emm_compliance_opioid) %>%\n  filter(!is.na(x)) %>%\n  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat=\"identity\", position=\"dodge\") + geom_errorbar(position=\"dodge\") + theme_bw() + theme(legend.position = \"bottom\") + scale_x_continuous(label=percent) + labs(y=\"opioid\", x=\"Estimate\") + facet_grid(~outcome)\n\n\n#test_predictions(beta_compliance_red, \"marital\") %>%\n#  kable() %>%\n#  kable_styling()\n\ncat(\"\\n\\n### Race (compliance alone)\\n\\n\")\nplot(ggemmeans(beta_compliance_red, \"race\"))\n\ncat(\"\\n\\n### Heroin (compliance alone)\\n\\n\")\nplot(ggemmeans(beta_compliance_red, \"heroin\"))\n\ncat(\"\\n\\n### Speed (attendance alone)\\n\\n\")\nplot(ggemmeans(beta_attendance_red, \"speed\"))\n\ncat(\"\\n\\n### Is living stable (attendance alone)\\n\\n\")\nplot(ggemmeans(beta_attendance_red, \"is_living_stable\"))\n\n\n\n\n```\n\n# CONCLUSIONS\n\nAnalyses of the data indicate that the age of the participant is the most important factor for both successful randomization and higher attendance/compliance, however the effects go in opposite directions:\n\n-   For randomization, the probability of enrollment is lower with increasing age.\n\n-   Once randomized, the rates of attendance and compliance goe up with increasing age.\n\nFor randomization, the other predictors are the total reported drugs and martial status, but in both cases missing is the most important factor – and there, lack of reported data (indicating unwillingness to participate by reporting data?) indicates lower probability of being randomized. The predictive power of this model is quite strong (AUC 0.8, linear calibration curve).\n\nFor compliance and attendance, the predictive power of models are lower. Age remains the most powerful predictor, while other predictors appear to be race, job, marital status, and heroin and opioid.\n\nFuture recruitment of patients into drug treatment trials might try greater outreach to older patients, who seemed less willing to participate but more successful.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":8,"fig-height":8,"fig-format":"retina","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":"asis","warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":{"source":true,"toggle":true,"caption":"none"},"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"embed-resources":false,"number-sections":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.450","editor":"visual","theme":"cosmo","title":"R/Medicine 2024 Data Challenge","author":"Mitchell Maltenfort"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}