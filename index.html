<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mitchell Maltenfort">

<title>R_medicine_competition_MGM - R/Medicine 2024 Data Challenge</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R_medicine_competition_MGM</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> INTRODUCTION</a></li>
  <li><a href="#successful-randomization" id="toc-successful-randomization" class="nav-link" data-scroll-target="#successful-randomization"><span class="header-section-number">2</span> SUCCESSFUL RANDOMIZATION</a>
  <ul class="collapse">
  <li><a href="#use-bootstrap-validation-to-determine-what-values-are-persistent" id="toc-use-bootstrap-validation-to-determine-what-values-are-persistent" class="nav-link" data-scroll-target="#use-bootstrap-validation-to-determine-what-values-are-persistent"><span class="header-section-number">2.1</span> Use bootstrap validation to determine what values are persistent</a></li>
  <li><a href="#project-51-has-almost-perfect-randomization-compared-to-other-two" id="toc-project-51-has-almost-perfect-randomization-compared-to-other-two" class="nav-link" data-scroll-target="#project-51-has-almost-perfect-randomization-compared-to-other-two"><span class="header-section-number">2.2</span> Project 51 has almost perfect randomization compared to other two</a></li>
  <li><a href="#use-bootstrap-validtion-to-determine-what-values-are-persistent" id="toc-use-bootstrap-validtion-to-determine-what-values-are-persistent" class="nav-link" data-scroll-target="#use-bootstrap-validtion-to-determine-what-values-are-persistent"><span class="header-section-number">2.3</span> Use bootstrap validtion to determine what values are persistent</a></li>
  <li><a href="#final-logistic-regression-model-predicting-successful-randomization-log-odds" id="toc-final-logistic-regression-model-predicting-successful-randomization-log-odds" class="nav-link" data-scroll-target="#final-logistic-regression-model-predicting-successful-randomization-log-odds"><span class="header-section-number">2.4</span> Final logistic regression model predicting successful randomization (log-odds)</a></li>
  <li><a href="#show-calibration-predicted-vs-actual-for-predictive-model-of-randomization" id="toc-show-calibration-predicted-vs-actual-for-predictive-model-of-randomization" class="nav-link" data-scroll-target="#show-calibration-predicted-vs-actual-for-predictive-model-of-randomization"><span class="header-section-number">2.5</span> Show calibration (predicted vs actual) for predictive model of randomization</a></li>
  <li><a href="#roc-curve-auc-is-0.81-95-percent-ci-0.79---0.83" id="toc-roc-curve-auc-is-0.81-95-percent-ci-0.79---0.83" class="nav-link" data-scroll-target="#roc-curve-auc-is-0.81-95-percent-ci-0.79---0.83"><span class="header-section-number">2.6</span> ROC curve AUC is 0.81 (95 percent CI 0.79 - 0.83)</a></li>
  <li><a href="#estimated-marginal-means" id="toc-estimated-marginal-means" class="nav-link" data-scroll-target="#estimated-marginal-means"><span class="header-section-number">2.7</span> Estimated marginal means</a>
  <ul class="collapse">
  <li><a href="#marital" id="toc-marital" class="nav-link" data-scroll-target="#marital"><span class="header-section-number">2.7.1</span> Marital</a></li>
  <li><a href="#total-reported-drugs" id="toc-total-reported-drugs" class="nav-link" data-scroll-target="#total-reported-drugs"><span class="header-section-number">2.7.2</span> Total reported drugs</a></li>
  <li><a href="#age" id="toc-age" class="nav-link" data-scroll-target="#age"><span class="header-section-number">2.7.3</span> Age</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#attendance-and-compliance-post-randomization" id="toc-attendance-and-compliance-post-randomization" class="nav-link" data-scroll-target="#attendance-and-compliance-post-randomization"><span class="header-section-number">3</span> ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION</a>
  <ul class="collapse">
  <li><a href="#beta-regression-coefficients-factor-reference-levels-based-on-alphabetical-order" id="toc-beta-regression-coefficients-factor-reference-levels-based-on-alphabetical-order" class="nav-link" data-scroll-target="#beta-regression-coefficients-factor-reference-levels-based-on-alphabetical-order"><span class="header-section-number">3.1</span> Beta regression coefficients (factor reference levels based on alphabetical order)</a>
  <ul class="collapse">
  <li><a href="#compliance" id="toc-compliance" class="nav-link" data-scroll-target="#compliance"><span class="header-section-number">3.1.1</span> Compliance</a></li>
  <li><a href="#no-major-difference-between-projects" id="toc-no-major-difference-between-projects" class="nav-link" data-scroll-target="#no-major-difference-between-projects"><span class="header-section-number">3.1.2</span> No major difference between Projects</a></li>
  <li><a href="#attendance-1" id="toc-attendance-1" class="nav-link" data-scroll-target="#attendance-1"><span class="header-section-number">3.1.3</span> Attendance</a></li>
  </ul></li>
  <li><a href="#estimated-marginal-means-1" id="toc-estimated-marginal-means-1" class="nav-link" data-scroll-target="#estimated-marginal-means-1"><span class="header-section-number">3.2</span> Estimated marginal means</a>
  <ul class="collapse">
  <li><a href="#age-1" id="toc-age-1" class="nav-link" data-scroll-target="#age-1"><span class="header-section-number">3.2.1</span> Age</a></li>
  <li><a href="#age-raw-data" id="toc-age-raw-data" class="nav-link" data-scroll-target="#age-raw-data"><span class="header-section-number">3.2.2</span> Age (raw data)</a></li>
  <li><a href="#marital-1" id="toc-marital-1" class="nav-link" data-scroll-target="#marital-1"><span class="header-section-number">3.2.3</span> Marital</a></li>
  <li><a href="#job" id="toc-job" class="nav-link" data-scroll-target="#job"><span class="header-section-number">3.2.4</span> Job</a></li>
  <li><a href="#opioid" id="toc-opioid" class="nav-link" data-scroll-target="#opioid"><span class="header-section-number">3.2.5</span> Opioid</a></li>
  <li><a href="#race-compliance-alone" id="toc-race-compliance-alone" class="nav-link" data-scroll-target="#race-compliance-alone"><span class="header-section-number">3.2.6</span> Race (compliance alone)</a></li>
  <li><a href="#heroin-compliance-alone" id="toc-heroin-compliance-alone" class="nav-link" data-scroll-target="#heroin-compliance-alone"><span class="header-section-number">3.2.7</span> Heroin (compliance alone)</a></li>
  <li><a href="#speed-attendance-alone" id="toc-speed-attendance-alone" class="nav-link" data-scroll-target="#speed-attendance-alone"><span class="header-section-number">3.2.8</span> Speed (attendance alone)</a></li>
  <li><a href="#is-living-stable-attendance-alone" id="toc-is-living-stable-attendance-alone" class="nav-link" data-scroll-target="#is-living-stable-attendance-alone"><span class="header-section-number">3.2.9</span> Is living stable (attendance alone)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">4</span> CONCLUSIONS</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">R/Medicine 2024 Data Challenge</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mitchell Maltenfort </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> INTRODUCTION</h1>
<p>This is my attempt at the analyses requested in <a href="https://rconsortium.github.io/RMedicine_website/Competition.html" class="uri">https://rconsortium.github.io/RMedicine_website/Competition.html</a>. I focused on identifying predictive factors associated with two questions.</p>
<ol type="1">
<li><p>Of the potential patients providing data, what factors were associated with succesful randomization?</p></li>
<li><p>Defining compliance as the % of potential study weeks where a patient showed up with a negative test, what factors were associated with higher compliance?</p></li>
</ol>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data and packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(public.ctn0094data)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(public.ctn0094extra)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(pROC)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggeffects)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(kableExtra)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(broom)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(rms)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(betareg)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(scales)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(emmeans)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(marginaleffects)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="successful-randomization" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> SUCCESSFUL RANDOMIZATION</h1>
<p>Of the patients listed in ‘everybody’ which ones are successfully randomized (‘randomization’)?</p>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create wide table of drug usage</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>data_ls <span class="ot">&lt;-</span> <span class="fu">loadRawData</span>(<span class="fu">c</span>(<span class="st">"randomization"</span>, <span class="st">"treatment"</span>, <span class="st">"rbs"</span>, <span class="st">"demographics"</span>, <span class="st">"everybody"</span>))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>rbs_wide <span class="ot">&lt;-</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>rbs <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(did_use <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="dv">1</span>, did_use <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(who, what, value) <span class="sc">%&gt;%</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_ls<span class="sc">$</span>everybody <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(who)) <span class="sc">%&gt;%</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(value) <span class="sc">~</span> <span class="dv">0</span>, <span class="cn">TRUE</span> <span class="sc">~</span> value)) <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> what, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_reported_drugs =</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed) <span class="sc">%&gt;%</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">NA</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_reported_drugs =</span> <span class="fu">as.factor</span>(total_reported_drugs))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>randomization_tbl <span class="ot">&lt;-</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>demographics <span class="sc">%&gt;%</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>( data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span> <span class="fu">filter</span>(which <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomization =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(which) <span class="sc">~</span> <span class="st">"0"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> which))) <span class="sc">%&gt;%</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(rbs_wide) <span class="sc">%&gt;%</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(job) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> job))) <span class="sc">%&gt;%</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_living_stable =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(is_living_stable) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> is_living_stable))) <span class="sc">%&gt;%</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">education =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(education) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> education))) <span class="sc">%&gt;%</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">marital =</span> <span class="fu">as.factor</span>(<span class="fu">case_when</span>(<span class="fu">is.na</span>(marital) <span class="sc">~</span> <span class="st">"Missing"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> marital))) <span class="sc">%&gt;%</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job =</span> <span class="fu">fct_relevel</span>(job, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_living_stable =</span> <span class="fu">fct_relevel</span>(is_living_stable, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">education =</span> <span class="fu">fct_relevel</span>(education, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">marital =</span> <span class="fu">fct_relevel</span>(marital, <span class="st">"Missing"</span>, <span class="at">after =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cocaine =</span> <span class="fu">as.factor</span>(cocaine), <span class="at">heroin =</span> <span class="fu">as.factor</span>(heroin), <span class="at">speedball =</span> <span class="fu">as.factor</span>(speedball), <span class="at">opioid =</span> <span class="fu">as.factor</span>(opioid), <span class="at">speed =</span> <span class="fu">as.factor</span>(speed)) <span class="sc">%&gt;%</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(everybody)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># use optimum penalty of 1 determined manually using 'pentrace'</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>lrm_randomization <span class="ot">&lt;-</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrm</span>(randomization <span class="sc">~</span> <span class="fu">pol</span>(age, <span class="dv">2</span>) <span class="sc">+</span> job <span class="sc">+</span> education <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> total_reported_drugs <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid, randomization_tbl, <span class="at">x =</span> <span class="cn">TRUE</span>, <span class="at">y =</span> <span class="cn">TRUE</span>, <span class="at">penalty =</span> <span class="dv">1</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Use bootstrap validation to determine what values are persistent</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="use-bootstrap-validation-to-determine-what-values-are-persistent" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="use-bootstrap-validation-to-determine-what-values-are-persistent"><span class="header-section-number">2.1</span> Use bootstrap validation to determine what values are persistent</h2>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>‘Total reported drugs’ is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs</p>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>validate_randomization <span class="ot">&lt;-</span> <span class="fu">validate</span>(lrm_randomization, <span class="at">B =</span> <span class="dv">200</span>, <span class="at">bw =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>    Backwards Step-down - Original Model</code></pre>
<p>Deleted Chi-Sq d.f. P Residual d.f. P AIC<br>
job 0.23 5 0.9988 0.23 5 0.9988 -9.77 education 2.69 3 0.4427 2.92 8 0.9395 -13.08 is_hispanic 0.11 1 0.7370 3.03 9 0.9632 -14.97 is_male 0.17 1 0.6795 3.20 10 0.9763 -16.80 speedball 1.84 1 0.1749 5.04 11 0.9293 -16.96 race 8.97 3 0.0297 14.01 14 0.4493 -13.99 heroin 6.24 1 0.0125 20.25 15 0.1627 -9.75 opioid 5.43 1 0.0198 25.68 16 0.0587 -6.32</p>
<p>Approximate Estimates after Deleting Factors</p>
<pre><code>                                     Coef      S.E.  Wald Z         P</code></pre>
<p>Intercept 0.2726217 0.6201659 0.4396 6.602e-01 age -0.0731720 0.0295826 -2.4735 1.338e-02 age^2 0.0005492 0.0003716 1.4780 1.394e-01 marital=Never married 0.1830554 0.2178662 0.8402 4.008e-01 marital=Separated/Divorced/Widowed 0.2124224 0.2446399 0.8683 3.852e-01 marital=Missing -0.9641235 0.1857561 -5.1903 2.100e-07 total_reported_drugs=1 3.7372456 0.2154768 17.3441 0.000e+00 total_reported_drugs=2 3.6986121 0.2124678 17.4079 0.000e+00 total_reported_drugs=3 3.6472251 0.2211314 16.4935 0.000e+00 total_reported_drugs=4 3.8151182 0.2815350 13.5511 0.000e+00 total_reported_drugs=5 3.4882191 0.4293229 8.1249 4.441e-16</p>
<p>Factors in Final Model</p>
<p>[1] age marital total_reported_drugs</p>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">attr</span>(validate_randomization, <span class="st">"kept"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">age</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">job</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">education</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">marital</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">is_male</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">is_hispanic</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">race</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">total_reported_drugs</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">heroin</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">speedball</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">opioid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">Mode:logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode:logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
<td style="text-align: left;">Mode :logical</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">TRUE:200</td>
<td style="text-align: left;">FALSE:198</td>
<td style="text-align: left;">FALSE:172</td>
<td style="text-align: left;">FALSE:23</td>
<td style="text-align: left;">FALSE:197</td>
<td style="text-align: left;">FALSE:196</td>
<td style="text-align: left;">FALSE:153</td>
<td style="text-align: left;">TRUE:200</td>
<td style="text-align: left;">FALSE:145</td>
<td style="text-align: left;">FALSE:162</td>
<td style="text-align: left;">FALSE:126</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE :2</td>
<td style="text-align: left;">TRUE :28</td>
<td style="text-align: left;">TRUE :177</td>
<td style="text-align: left;">TRUE :3</td>
<td style="text-align: left;">TRUE :4</td>
<td style="text-align: left;">TRUE :47</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE :55</td>
<td style="text-align: left;">TRUE :38</td>
<td style="text-align: left;">TRUE :74</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>lrm_final <span class="ot">&lt;-</span> <span class="fu">lrm</span>(randomization <span class="sc">~</span> <span class="fu">pol</span>(age, <span class="dv">2</span>) <span class="sc">+</span> marital <span class="sc">+</span> total_reported_drugs, randomization_tbl, <span class="at">x =</span> <span class="cn">TRUE</span>, <span class="at">y =</span> <span class="cn">TRUE</span>, <span class="at">penalty =</span> <span class="dv">1</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>randomization_tbl<span class="sc">$</span>predict_randomization <span class="ot">&lt;-</span> <span class="fu">predict</span>(lrm_final, <span class="at">type =</span> <span class="st">"fitted"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Project 51 has almost perfect randomization compared to other two</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="project-51-has-almost-perfect-randomization-compared-to-other-two" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="project-51-has-almost-perfect-randomization-compared-to-other-two"><span class="header-section-number">2.2</span> Project 51 has almost perfect randomization compared to other two</h2>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(lrm_final,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">project</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">predicted</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">27</td>
<td style="text-align: right;">0.6509355</td>
<td style="text-align: right;">0.5791867</td>
<td style="text-align: right;">0.7164402</td>
</tr>
<tr class="even">
<td style="text-align: left;">30</td>
<td style="text-align: right;">0.7240205</td>
<td style="text-align: right;">0.6693301</td>
<td style="text-align: right;">0.7727367</td>
</tr>
<tr class="odd">
<td style="text-align: left;">51</td>
<td style="text-align: right;">0.9940233</td>
<td style="text-align: right;">0.9824580</td>
<td style="text-align: right;">0.9979793</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Use bootstrap validtion to determine what values are persistent</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="use-bootstrap-validtion-to-determine-what-values-are-persistent" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="use-bootstrap-validtion-to-determine-what-values-are-persistent"><span class="header-section-number">2.3</span> Use bootstrap validtion to determine what values are persistent</h2>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>coef <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(lrm_final)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(lrm_final)))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Final logistic regression model predicting successful randomization (log-odds)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="final-logistic-regression-model-predicting-successful-randomization-log-odds" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="final-logistic-regression-model-predicting-successful-randomization-log-odds"><span class="header-section-number">2.4</span> Final logistic regression model predicting successful randomization (log-odds)</h2>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">(factor reference levels based on alphabetical order)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(factor reference levels based on alphabetical order)</p>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">term =</span> <span class="fu">names</span>(coef), coef, se) <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">case_when</span>(coef <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">pnorm</span>(coef <span class="sc">/</span> se, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>), <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">pnorm</span>(coef <span class="sc">/</span> se, <span class="at">lower.tail =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">4</span>, <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Total Reported Drugs (reference level 0)"</span>, <span class="dv">7</span>, <span class="dv">11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">coef</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">0.1741456</td>
<td style="text-align: right;">0.6158886</td>
<td style="text-align: right;">0.7773647</td>
</tr>
<tr class="even">
<td style="text-align: left;">age</td>
<td style="text-align: right;">-0.0722803</td>
<td style="text-align: right;">0.0294367</td>
<td style="text-align: right;">0.0140707</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age^2</td>
<td style="text-align: right;">0.0005367</td>
<td style="text-align: right;">0.0003702</td>
<td style="text-align: right;">0.1471491</td>
</tr>
<tr class="even" data-grouplength="3">
<td colspan="4" style="text-align: left; border-bottom: 1px solid;"><strong>Marital (ref level Married or Partnered)</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">marital=Never married</td>
<td style="text-align: right;">0.1860933</td>
<td style="text-align: right;">0.2177973</td>
<td style="text-align: right;">0.3928649</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">marital=Separated/Divorced/Widowed</td>
<td style="text-align: right;">0.2180355</td>
<td style="text-align: right;">0.2447502</td>
<td style="text-align: right;">0.3730099</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">marital=Missing</td>
<td style="text-align: right;">-0.9700294</td>
<td style="text-align: right;">0.1860135</td>
<td style="text-align: right;">0.0000002</td>
</tr>
<tr class="even" data-grouplength="5">
<td colspan="4" style="text-align: left; border-bottom: 1px solid;"><strong>Total Reported Drugs (reference level 0)</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=1</td>
<td style="text-align: right;">3.8333471</td>
<td style="text-align: right;">0.2133380</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=2</td>
<td style="text-align: right;">3.8023090</td>
<td style="text-align: right;">0.2102814</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=3</td>
<td style="text-align: right;">3.7605650</td>
<td style="text-align: right;">0.2188092</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=4</td>
<td style="text-align: right;">3.9294689</td>
<td style="text-align: right;">0.2790591</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">total_reported_drugs=5</td>
<td style="text-align: right;">3.5772414</td>
<td style="text-align: right;">0.4260219</td>
<td style="text-align: right;">0.0000000</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>calibrate_final <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(lrm_final, <span class="at">B =</span> <span class="dv">200</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>calibrate_tbl <span class="ot">&lt;-</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  calibrate_final[, <span class="fu">c</span>(<span class="st">"predy"</span>, <span class="st">"calibrated.orig"</span>, <span class="st">"calibrated.corrected"</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(calibrated.orig<span class="sc">:</span>calibrated.corrected)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Show calibration (predicted vs actual) for predictive model of randomization</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="show-calibration-predicted-vs-actual-for-predictive-model-of-randomization" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="show-calibration-predicted-vs-actual-for-predictive-model-of-randomization"><span class="header-section-number">2.5</span> Show calibration (predicted vs actual) for predictive model of randomization</h2>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>calibrate_tbl <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> predy, <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"calibration"</span>, <span class="at">x =</span> <span class="st">"Predicted Probability"</span>, <span class="at">y =</span> <span class="st">"Actual Probability"</span>) <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/randomization-1.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">&lt;-</span> <span class="fu">ci.auc</span>(<span class="fu">roc</span>(randomization <span class="sc">~</span> predict_randomization, <span class="at">data =</span> randomization_tbl <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(predict_randomization))))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## ROC curve AUC is %0.2f (95 percent CI %0.2f - %0.2f)</span><span class="sc">\n\n</span><span class="st">"</span>, auc[<span class="dv">2</span>], auc[<span class="dv">1</span>], auc[<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="roc-curve-auc-is-0.81-95-percent-ci-0.79---0.83" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="roc-curve-auc-is-0.81-95-percent-ci-0.79---0.83"><span class="header-section-number">2.6</span> ROC curve AUC is 0.81 (95 percent CI 0.79 - 0.83)</h2>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">roc</span>(randomization <span class="sc">~</span> predict_randomization, <span class="at">data =</span> randomization_tbl <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(predict_randomization))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/randomization-2.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Estimated marginal means</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="estimated-marginal-means" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="estimated-marginal-means"><span class="header-section-number">2.7</span> Estimated marginal means</h2>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Marital</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="marital" class="level3" data-number="2.7.1">
<h3 data-number="2.7.1" class="anchored" data-anchor-id="marital"><span class="header-section-number">2.7.1</span> Marital</h3>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"marital"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/randomization-3.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_predictions</span>(lrm_final, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">marital</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Contrast</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Married or Partnered-Never married</td>
<td style="text-align: right;">-0.0252404</td>
<td style="text-align: right;">-0.0824855</td>
<td style="text-align: right;">0.0320046</td>
<td style="text-align: right;">0.3874862</td>
</tr>
<tr class="even">
<td style="text-align: left;">Married or Partnered-Separated/Divorced/Widowed</td>
<td style="text-align: right;">-0.0298955</td>
<td style="text-align: right;">-0.0961135</td>
<td style="text-align: right;">0.0363225</td>
<td style="text-align: right;">0.3762287</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Married or Partnered-Missing</td>
<td style="text-align: right;">0.0870519</td>
<td style="text-align: right;">0.0348838</td>
<td style="text-align: right;">0.1392201</td>
<td style="text-align: right;">0.0010734</td>
</tr>
<tr class="even">
<td style="text-align: left;">Never married-Separated/Divorced/Widowed</td>
<td style="text-align: right;">-0.0046551</td>
<td style="text-align: right;">-0.0666364</td>
<td style="text-align: right;">0.0573262</td>
<td style="text-align: right;">0.8829721</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Never married-Missing</td>
<td style="text-align: right;">0.1122923</td>
<td style="text-align: right;">0.0624778</td>
<td style="text-align: right;">0.1621069</td>
<td style="text-align: right;">0.0000100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Separated/Divorced/Widowed-Missing</td>
<td style="text-align: right;">0.1169474</td>
<td style="text-align: right;">0.0563531</td>
<td style="text-align: right;">0.1775418</td>
<td style="text-align: right;">0.0001551</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Total reported drugs</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="total-reported-drugs" class="level3" data-number="2.7.2">
<h3 data-number="2.7.2" class="anchored" data-anchor-id="total-reported-drugs"><span class="header-section-number">2.7.2</span> Total reported drugs</h3>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"total_reported_drugs"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/randomization-4.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_predictions</span>(lrm_final, <span class="st">"total_reported_drugs"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">total_reported_drugs</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Contrast</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0-1</td>
<td style="text-align: right;">-0.7408890</td>
<td style="text-align: right;">-0.7933182</td>
<td style="text-align: right;">-0.6884598</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">0-2</td>
<td style="text-align: right;">-0.7378239</td>
<td style="text-align: right;">-0.7897550</td>
<td style="text-align: right;">-0.6858928</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0-3</td>
<td style="text-align: right;">-0.7335837</td>
<td style="text-align: right;">-0.7869992</td>
<td style="text-align: right;">-0.6801682</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">0-4</td>
<td style="text-align: right;">-0.7499212</td>
<td style="text-align: right;">-0.8116047</td>
<td style="text-align: right;">-0.6882376</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0-5</td>
<td style="text-align: right;">-0.7132936</td>
<td style="text-align: right;">-0.8138319</td>
<td style="text-align: right;">-0.6127554</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">1-2</td>
<td style="text-align: right;">0.0030651</td>
<td style="text-align: right;">-0.0206425</td>
<td style="text-align: right;">0.0267727</td>
<td style="text-align: right;">0.7999593</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1-3</td>
<td style="text-align: right;">0.0073053</td>
<td style="text-align: right;">-0.0197899</td>
<td style="text-align: right;">0.0344004</td>
<td style="text-align: right;">0.5971954</td>
</tr>
<tr class="even">
<td style="text-align: left;">1-4</td>
<td style="text-align: right;">-0.0090321</td>
<td style="text-align: right;">-0.0490508</td>
<td style="text-align: right;">0.0309865</td>
<td style="text-align: right;">0.6582287</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1-5</td>
<td style="text-align: right;">0.0275954</td>
<td style="text-align: right;">-0.0627017</td>
<td style="text-align: right;">0.1178925</td>
<td style="text-align: right;">0.5491874</td>
</tr>
<tr class="even">
<td style="text-align: left;">2-3</td>
<td style="text-align: right;">0.0042402</td>
<td style="text-align: right;">-0.0220300</td>
<td style="text-align: right;">0.0305104</td>
<td style="text-align: right;">0.7517362</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2-4</td>
<td style="text-align: right;">-0.0120972</td>
<td style="text-align: right;">-0.0516237</td>
<td style="text-align: right;">0.0274293</td>
<td style="text-align: right;">0.5486031</td>
</tr>
<tr class="even">
<td style="text-align: left;">2-5</td>
<td style="text-align: right;">0.0245303</td>
<td style="text-align: right;">-0.0654250</td>
<td style="text-align: right;">0.1144856</td>
<td style="text-align: right;">0.5930158</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3-4</td>
<td style="text-align: right;">-0.0163374</td>
<td style="text-align: right;">-0.0578999</td>
<td style="text-align: right;">0.0252251</td>
<td style="text-align: right;">0.4410482</td>
</tr>
<tr class="even">
<td style="text-align: left;">3-5</td>
<td style="text-align: right;">0.0202901</td>
<td style="text-align: right;">-0.0704499</td>
<td style="text-align: right;">0.1110301</td>
<td style="text-align: right;">0.6611965</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4-5</td>
<td style="text-align: right;">0.0366275</td>
<td style="text-align: right;">-0.0585622</td>
<td style="text-align: right;">0.1318173</td>
<td style="text-align: right;">0.4507509</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="age" class="level3" data-number="2.7.3">
<h3 data-number="2.7.3" class="anchored" data-anchor-id="age"><span class="header-section-number">2.7.3</span> Age</h3>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(lrm_final, <span class="st">"age[all]"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/randomization-5.png" class="img-fluid" width="2400"></p>
</section>
</section>
</section>
<section id="attendance-and-compliance-post-randomization" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION</h1>
<p>This adapts the code from ‘public.ctn0094extra’ vignette to summarise substance use across weeks.</p>
<p>I define compliance as how many times the patient showed up with a negative UDS report, divided by the length of time in the study (Study Week + 1 for Baseline). Attendance is how many times the patient showed up with a report (positive or negative), divided by length of time in the study.</p>
<p>Beta regression is used to create a parsimonious model, pruned “by hand” to get rid of irrelevant predictors. The correlation coefficients for these models are not good (R-squared &lt; 0.03) but there may be some insight into how to get better attendance or compliance for patients</p>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>data_ls <span class="ot">&lt;-</span> <span class="fu">loadRawData</span>(<span class="fu">c</span>(<span class="st">"randomization"</span>, <span class="st">"treatment"</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>randomization <span class="ot">&lt;-</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, treatment, <span class="at">randomized =</span> which) <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove second randomization events</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized <span class="sc">!=</span> <span class="dv">2</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>treatment <span class="ot">&lt;-</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>treatment</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>start_int <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">27</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span><span class="dv">30</span>L, <span class="st">`</span><span class="at">51</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span><span class="dv">30</span>L)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>end_int <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">27</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">168</span>L, <span class="st">`</span><span class="at">51</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">168</span>L)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>backbone2751_df <span class="ot">&lt;-</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CreateProtocolHistory</span>(</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_vec =</span> start_int,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_vec =</span> end_int</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>backbone30_df <span class="ot">&lt;-</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(project <span class="sc">==</span> <span class="st">"30"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CreateCTN30ProtocolHistory</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">project =</span> <span class="st">"30"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, project, when)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>backbone_df <span class="ot">&lt;-</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(backbone2751_df, backbone30_df) <span class="sc">%&gt;%</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(who)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(backbone2751_df, backbone30_df, start_int, end_int)</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>data_ls <span class="ot">&lt;-</span> <span class="fu">loadRawData</span>(<span class="fu">c</span>(<span class="st">"randomization"</span>, <span class="st">"visit"</span>))</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>randomization <span class="ot">&lt;-</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, treatment, <span class="at">randomized =</span> which) <span class="sc">%&gt;%</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove second randomization events</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized <span class="sc">!=</span> <span class="dv">2</span>)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>data_ls<span class="sc">$</span>visit <span class="ot">&lt;-</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>visit</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>timelineRand1_df <span class="ot">&lt;-</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>randomization <span class="sc">%&gt;%</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomized =</span> randomized <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join to backbone and arrange within subject by day</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(backbone_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(when, <span class="at">.by_group =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, project, when, randomized)</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>timelineVisit1_df <span class="ot">&lt;-</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>  data_ls<span class="sc">$</span>visit <span class="sc">%&gt;%</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visit, <span class="at">status =</span> what) <span class="sc">%&gt;%</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"visit"</span>, <span class="st">"final"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visit) <span class="sc">%&gt;%</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(timelineRand1_df, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>timelineMissing1_df <span class="ot">&lt;-</span> <span class="fu">MarkMissing</span>(timelineVisit1_df)</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>derived_visitImputed <span class="ot">&lt;-</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>  timelineMissing1_df <span class="sc">%&gt;%</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visit =</span> <span class="fu">as.character</span>(visit)) <span class="sc">%&gt;%</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">visit =</span> <span class="st">""</span>, <span class="at">visitYM =</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">visitImputed =</span> <span class="fu">paste0</span>(visit, visitYM)) <span class="sc">%&gt;%</span></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">visitImputed =</span> <span class="fu">str_replace</span>(</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>      visitImputed,</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">pattern =</span> <span class="st">"TRUETRUE"</span>, <span class="at">replacement =</span> <span class="st">"Present"</span></span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, visitImputed) <span class="sc">%&gt;%</span></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(visitImputed <span class="sc">!=</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>randomized_df <span class="ot">&lt;-</span></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">randomized =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(which))) <span class="sc">%&gt;%</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, randomized) <span class="sc">%&gt;%</span></span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> project <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"27"</span>, <span class="st">"51"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>project)</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>udsUse2_df <span class="ot">&lt;-</span></span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>  backbone_df <span class="sc">%&gt;%</span></span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(randomized_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(derived_visitImputed, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(uds, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So we can use MarkUse() with UDS data (instead of all_drugs)</span></span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"UDS"</span>)</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>  backbone_df, data_ls, timelineMissing1_df, timelineRand1_df, timelineVisit1_df</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>nonStudyOpioids_ls <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Buprenorphine"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>),</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Methadone"</span>     <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Buprenorphine"</span>),</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Naltrexone"</span>    <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>, <span class="st">"Buprenorphine"</span>),</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Not treated"</span>   <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"Methadone"</span>, <span class="st">"Buprenorphine"</span>)</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>treatGroups_ls <span class="ot">&lt;-</span></span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>  randomization <span class="sc">%&gt;%</span></span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(which <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(everybody, <span class="at">by =</span> <span class="st">"who"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, treatment) <span class="sc">%&gt;%</span></span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_drug =</span> <span class="fu">case_when</span>(</span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(treatment, <span class="st">"BUP"</span>) <span class="sc">~</span> <span class="st">"Buprenorphine"</span>,</span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a>      treatment <span class="sc">==</span> <span class="st">"Methadone"</span> <span class="sc">~</span> <span class="st">"Methadone"</span>,</span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>      treatment <span class="sc">==</span> <span class="st">"Inpatient NR-NTX"</span> <span class="sc">~</span> <span class="st">"Naltrexone"</span></span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>treatment) <span class="sc">%&gt;%</span></span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="at">f =</span> .<span class="sc">$</span>treat_drug) <span class="sc">%&gt;%</span></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="st">"who"</span>)</span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a>opioidUse_df <span class="ot">&lt;-</span></span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>  udsUse2_df <span class="sc">%&gt;%</span></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Buprenorphine <span class="sc">~</span> <span class="st">"Buprenorphine"</span>,</span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Methadone <span class="sc">~</span> <span class="st">"Methadone"</span>,</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>      who <span class="sc">%in%</span> treatGroups_ls<span class="sc">$</span>Naltrexone <span class="sc">~</span> <span class="st">"Naltrexone"</span>,</span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Not treated"</span></span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="at">f =</span> .<span class="sc">$</span>treat_group) <span class="sc">%&gt;%</span></span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of data in alphabetical order, so the non-study drugs ls should match</span></span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map2</span>(</span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">.y =</span> nonStudyOpioids_ls,</span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a>      <span class="co"># REQUIRES "source" COLUMN</span></span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>      <span class="fu">MarkUse</span>(</span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>        <span class="at">targetDrugs_char =</span> .y,</span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a>        <span class="at">drugs_df =</span> .x,</span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>        <span class="co"># because we have participants with no recorded UDS; in practice DO NOT</span></span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   use this command</span></span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a>        <span class="at">retainEmptyRows =</span> <span class="cn">TRUE</span></span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">udsOpioid =</span> <span class="fu">case_when</span>(</span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(when) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(when) <span class="sc">~</span> <span class="cn">TRUE</span></span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, udsOpioid)</span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-159"><a href="#cb30-159" aria-hidden="true" tabindex="-1"></a>timelineUDS_df <span class="ot">&lt;-</span></span>
<span id="cb30-160"><a href="#cb30-160" aria-hidden="true" tabindex="-1"></a>  udsUse2_df <span class="sc">%&gt;%</span></span>
<span id="cb30-161"><a href="#cb30-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(opioidUse_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-162"><a href="#cb30-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>what, <span class="sc">-</span>source) <span class="sc">%&gt;%</span></span>
<span id="cb30-163"><a href="#cb30-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2,089 rows to 1,994</span></span>
<span id="cb30-164"><a href="#cb30-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb30-165"><a href="#cb30-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-166"><a href="#cb30-166" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(</span>
<span id="cb30-167"><a href="#cb30-167" aria-hidden="true" tabindex="-1"></a>  derived_visitImputed, opioidUse_df, randomized_df, treatGroups_ls, udsUse2_df</span>
<span id="cb30-168"><a href="#cb30-168" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-169"><a href="#cb30-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-170"><a href="#cb30-170" aria-hidden="true" tabindex="-1"></a>wasRandomized_int <span class="ot">&lt;-</span></span>
<span id="cb30-171"><a href="#cb30-171" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb30-172"><a href="#cb30-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb30-173"><a href="#cb30-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">randomized =</span> <span class="fu">any</span>(randomized <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-174"><a href="#cb30-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(randomized) <span class="sc">%&gt;%</span></span>
<span id="cb30-175"><a href="#cb30-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(who)</span>
<span id="cb30-176"><a href="#cb30-176" aria-hidden="true" tabindex="-1"></a>notRandomized_int <span class="ot">&lt;-</span></span>
<span id="cb30-177"><a href="#cb30-177" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb30-178"><a href="#cb30-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(who <span class="sc">%in%</span> wasRandomized_int)) <span class="sc">%&gt;%</span></span>
<span id="cb30-179"><a href="#cb30-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb30-180"><a href="#cb30-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb30-181"><a href="#cb30-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-182"><a href="#cb30-182" aria-hidden="true" tabindex="-1"></a>timelineUDS2_df <span class="ot">&lt;-</span></span>
<span id="cb30-183"><a href="#cb30-183" aria-hidden="true" tabindex="-1"></a>  timelineUDS_df <span class="sc">%&gt;%</span></span>
<span id="cb30-184"><a href="#cb30-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(who <span class="sc">%in%</span> wasRandomized_int) <span class="sc">%&gt;%</span></span>
<span id="cb30-185"><a href="#cb30-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb30-186"><a href="#cb30-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(randomized)) <span class="sc">%&gt;%</span></span>
<span id="cb30-187"><a href="#cb30-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-188"><a href="#cb30-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">whenRandomized1 =</span> <span class="fu">case_when</span>(randomized <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> when),</span>
<span id="cb30-189"><a href="#cb30-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">whenRandomized2 =</span> <span class="fu">case_when</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> when)</span>
<span id="cb30-190"><a href="#cb30-190" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-191"><a href="#cb30-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(who, when, whenRandomized1, whenRandomized2) <span class="sc">%&gt;%</span></span>
<span id="cb30-192"><a href="#cb30-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(timelineUDS_df, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"who"</span>, <span class="st">"when"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-193"><a href="#cb30-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(who <span class="sc">%in%</span> wasRandomized_int) <span class="sc">%&gt;%</span></span>
<span id="cb30-194"><a href="#cb30-194" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add back in the groupings BEFORE the fill()</span></span>
<span id="cb30-195"><a href="#cb30-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb30-196"><a href="#cb30-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(whenRandomized1, <span class="at">.direction =</span> <span class="st">"updown"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-197"><a href="#cb30-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(whenRandomized2, <span class="at">.direction =</span> <span class="st">"updown"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-198"><a href="#cb30-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">daysSinceRand1 =</span> when <span class="sc">-</span> whenRandomized1) <span class="sc">%&gt;%</span></span>
<span id="cb30-199"><a href="#cb30-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">daysSinceRand2 =</span> when <span class="sc">-</span> whenRandomized2) <span class="sc">%&gt;%</span></span>
<span id="cb30-200"><a href="#cb30-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>whenRandomized1, <span class="sc">-</span>whenRandomized2)</span>
<span id="cb30-201"><a href="#cb30-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-202"><a href="#cb30-202" aria-hidden="true" tabindex="-1"></a>weeklyUse_df <span class="ot">&lt;-</span></span>
<span id="cb30-203"><a href="#cb30-203" aria-hidden="true" tabindex="-1"></a>  timelineUDS2_df <span class="sc">%&gt;%</span></span>
<span id="cb30-204"><a href="#cb30-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The (daysSinceRand1 - 1) adjustment is to ensure that the first study week</span></span>
<span id="cb30-205"><a href="#cb30-205" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   is a full 7 days, since "day 0" is the day before randomization. The "+1"</span></span>
<span id="cb30-206"><a href="#cb30-206" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   at the end is to shift the study week label such that "week 0" is the</span></span>
<span id="cb30-207"><a href="#cb30-207" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   week *BEFORE* treatment, rather than the first week of treatment. So, the</span></span>
<span id="cb30-208"><a href="#cb30-208" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   randomization day is the last day of "week 0" (the pre-treatment period).</span></span>
<span id="cb30-209"><a href="#cb30-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">studyWeek1 =</span> (daysSinceRand1 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> <span class="dv">7</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-210"><a href="#cb30-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">studyWeek2 =</span> (daysSinceRand2 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> <span class="dv">7</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-211"><a href="#cb30-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who, studyWeek1) <span class="sc">%&gt;%</span></span>
<span id="cb30-212"><a href="#cb30-212" aria-hidden="true" tabindex="-1"></a>  <span class="co"># There are some study weeks with multiple UDS, so we count the number of</span></span>
<span id="cb30-213"><a href="#cb30-213" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   positive and negative UDS per week.</span></span>
<span id="cb30-214"><a href="#cb30-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb30-215"><a href="#cb30-215" aria-hidden="true" tabindex="-1"></a>    <span class="at">nPosUDS  =</span> <span class="fu">sum</span>(udsOpioid <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-216"><a href="#cb30-216" aria-hidden="true" tabindex="-1"></a>    <span class="at">nNegUDS  =</span> <span class="fu">sum</span>(visitImputed <span class="sc">==</span> <span class="st">"Present"</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(udsOpioid), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-217"><a href="#cb30-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">nMissing =</span> <span class="fu">sum</span>(visitImputed <span class="sc">==</span> <span class="st">"Missing"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-218"><a href="#cb30-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">randWk1  =</span> <span class="fu">sum</span>(randomized <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb30-219"><a href="#cb30-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">randWk2  =</span> <span class="fu">sum</span>(randomized <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> project <span class="sc">==</span> <span class="st">"30"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb30-220"><a href="#cb30-220" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-221"><a href="#cb30-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb30-222"><a href="#cb30-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-223"><a href="#cb30-223" aria-hidden="true" tabindex="-1"></a>useByWeekRandomized_df <span class="ot">&lt;-</span></span>
<span id="cb30-224"><a href="#cb30-224" aria-hidden="true" tabindex="-1"></a>  weeklyUse_df <span class="sc">%&gt;%</span></span>
<span id="cb30-225"><a href="#cb30-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-226"><a href="#cb30-226" aria-hidden="true" tabindex="-1"></a>    <span class="at">udsStatus =</span> <span class="fu">case_when</span>(</span>
<span id="cb30-227"><a href="#cb30-227" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see a positive UDS and no negative UDS, it's positive</span></span>
<span id="cb30-228"><a href="#cb30-228" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"+"</span>,</span>
<span id="cb30-229"><a href="#cb30-229" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see a negative UDS and no positive UDS, it's negative</span></span>
<span id="cb30-230"><a href="#cb30-230" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"-"</span>,</span>
<span id="cb30-231"><a href="#cb30-231" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we see both positive and negative UDS in a single week, it's both</span></span>
<span id="cb30-232"><a href="#cb30-232" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   (note that we can recode all "B"s to be "+" as necessary)</span></span>
<span id="cb30-233"><a href="#cb30-233" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"*"</span>,</span>
<span id="cb30-234"><a href="#cb30-234" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we don't have any UDS in a week after randomization, it's missing</span></span>
<span id="cb30-235"><a href="#cb30-235" aria-hidden="true" tabindex="-1"></a>      <span class="co"># UPDATE 2022-03-08: I had this as a 0 originally, and I was using this</span></span>
<span id="cb30-236"><a href="#cb30-236" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   in context of consent, not randomization. This was wrong.</span></span>
<span id="cb30-237"><a href="#cb30-237" aria-hidden="true" tabindex="-1"></a>      nPosUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nNegUDS <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> studyWeek1 <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"o"</span>,</span>
<span id="cb30-238"><a href="#cb30-238" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If none of the above are true, but we still have a missing value as</span></span>
<span id="cb30-239"><a href="#cb30-239" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   marked by the MarkMissing() function, then it's missing</span></span>
<span id="cb30-240"><a href="#cb30-240" aria-hidden="true" tabindex="-1"></a>      nMissing <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"o"</span>,</span>
<span id="cb30-241"><a href="#cb30-241" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If none of the above conditions are true (probably because it's a week</span></span>
<span id="cb30-242"><a href="#cb30-242" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   before randomization but not during a baseline visit for consent),</span></span>
<span id="cb30-243"><a href="#cb30-243" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   then leave it blank (pre-study)</span></span>
<span id="cb30-244"><a href="#cb30-244" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"_"</span></span>
<span id="cb30-245"><a href="#cb30-245" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-246"><a href="#cb30-246" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-247"><a href="#cb30-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(who) <span class="sc">%&gt;%</span></span>
<span id="cb30-248"><a href="#cb30-248" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For CTN-0030, Phase II could have started on any day of the week, even in</span></span>
<span id="cb30-249"><a href="#cb30-249" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   the middle of a treatment week. If we try to start counting Phase II</span></span>
<span id="cb30-250"><a href="#cb30-250" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   weeks the day after treatment arms are switched, we can end up with the</span></span>
<span id="cb30-251"><a href="#cb30-251" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   last "week" of Phase I not having 7 days. I'm going to leave the first</span></span>
<span id="cb30-252"><a href="#cb30-252" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   week of Phase II as whatever week the switch happened in.</span></span>
<span id="cb30-253"><a href="#cb30-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-254"><a href="#cb30-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">rand1Active =</span> studyWeek1 <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb30-255"><a href="#cb30-255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This returns 0 for any week before the Phase II randomization, and 1 for</span></span>
<span id="cb30-256"><a href="#cb30-256" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   the Phase II randomization week and all subsequent weeks (because the</span></span>
<span id="cb30-257"><a href="#cb30-257" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   randWk2 column is 1 only for the week of second randomization and 0</span></span>
<span id="cb30-258"><a href="#cb30-258" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   all other rows).</span></span>
<span id="cb30-259"><a href="#cb30-259" aria-hidden="true" tabindex="-1"></a>    <span class="at">rand2Active =</span> <span class="fu">cumsum</span>(randWk2),</span>
<span id="cb30-260"><a href="#cb30-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">trialPhase  =</span> rand1Active <span class="sc">+</span> rand2Active</span>
<span id="cb30-261"><a href="#cb30-261" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-262"><a href="#cb30-262" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb30-263"><a href="#cb30-263" aria-hidden="true" tabindex="-1"></a>    who,</span>
<span id="cb30-264"><a href="#cb30-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">studyWeek =</span> studyWeek1, randWk1, randWk2, udsStatus, trialPhase</span>
<span id="cb30-265"><a href="#cb30-265" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-266"><a href="#cb30-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-267"><a href="#cb30-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-268"><a href="#cb30-268" aria-hidden="true" tabindex="-1"></a><span class="do">#### NEW</span></span>
<span id="cb30-269"><a href="#cb30-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-270"><a href="#cb30-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-271"><a href="#cb30-271" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="ot">&lt;-</span></span>
<span id="cb30-272"><a href="#cb30-272" aria-hidden="true" tabindex="-1"></a>  useByWeekRandomized_df <span class="sc">%&gt;%</span></span>
<span id="cb30-273"><a href="#cb30-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(trialPhase <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-274"><a href="#cb30-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(studyWeek <span class="sc">&gt;=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-275"><a href="#cb30-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(everybody) <span class="sc">%&gt;%</span></span>
<span id="cb30-276"><a href="#cb30-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(project, who) <span class="sc">%&gt;%</span></span>
<span id="cb30-277"><a href="#cb30-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">sum_pos =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"+"</span>), <span class="at">sum_neg =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"-"</span>), <span class="at">sumMissing =</span> <span class="fu">sum</span>(udsStatus <span class="sc">==</span> <span class="st">"o"</span>), <span class="at">total_weeks =</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">max</span>(studyWeek)) <span class="sc">%&gt;%</span></span>
<span id="cb30-278"><a href="#cb30-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">compliance =</span> sum_neg <span class="sc">/</span> total_weeks, <span class="at">attendance =</span> (sum_neg<span class="sc">+</span>sum_pos)<span class="sc">/</span>total_weeks) <span class="sc">%&gt;%</span></span>
<span id="cb30-279"><a href="#cb30-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(randomization_tbl <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(who, age, is_hispanic, race, job, education, is_living_stable, marital, is_male, cocaine<span class="sc">:</span>total_reported_drugs, predict_randomization)) <span class="sc">%&gt;%</span></span>
<span id="cb30-280"><a href="#cb30-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">project=</span><span class="fu">as.factor</span>(project))</span>
<span id="cb30-281"><a href="#cb30-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-282"><a href="#cb30-282" aria-hidden="true" tabindex="-1"></a><span class="co"># from https://stats.stackexchange.com/questions/31300/dealing-with-0-1-values-in-a-beta-regression</span></span>
<span id="cb30-283"><a href="#cb30-283" aria-hidden="true" tabindex="-1"></a><span class="co"># squeeze 0 and 1 so can use beta regression</span></span>
<span id="cb30-284"><a href="#cb30-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-285"><a href="#cb30-285" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">dim</span>(compliance_results)[<span class="dv">1</span>]</span>
<span id="cb30-286"><a href="#cb30-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-287"><a href="#cb30-287" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="ot">&lt;-</span> <span class="fu">mutate</span>(compliance_results, <span class="at">squeeze_compliance =</span> (compliance <span class="sc">*</span> (N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">/</span> N, <span class="at">squeeze_attendance =</span> (attendance <span class="sc">*</span> (N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">/</span> N)</span>
<span id="cb30-288"><a href="#cb30-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-289"><a href="#cb30-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-290"><a href="#cb30-290" aria-hidden="true" tabindex="-1"></a>beta_compliance <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_compliance <span class="sc">~</span> age <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span>
<span id="cb30-291"><a href="#cb30-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-292"><a href="#cb30-292" aria-hidden="true" tabindex="-1"></a>beta_compliance_red <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_compliance <span class="sc">~</span> age <span class="sc">+</span> race <span class="sc">+</span> job <span class="sc">+</span> marital <span class="sc">+</span> heroin <span class="sc">+</span> opioid, compliance_results)</span>
<span id="cb30-293"><a href="#cb30-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-294"><a href="#cb30-294" aria-hidden="true" tabindex="-1"></a>beta_attendance <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_attendance <span class="sc">~</span> age <span class="sc">+</span> is_hispanic <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> is_male <span class="sc">+</span> cocaine <span class="sc">+</span> heroin <span class="sc">+</span> speedball <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span>
<span id="cb30-295"><a href="#cb30-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-296"><a href="#cb30-296" aria-hidden="true" tabindex="-1"></a>beta_attendance_red <span class="ot">&lt;-</span> <span class="fu">betareg</span>(squeeze_attendance <span class="sc">~</span> age   <span class="sc">+</span> job <span class="sc">+</span> is_living_stable <span class="sc">+</span> marital <span class="sc">+</span> opioid <span class="sc">+</span> speed, compliance_results)</span>
<span id="cb30-297"><a href="#cb30-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-298"><a href="#cb30-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-299"><a href="#cb30-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-300"><a href="#cb30-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-301"><a href="#cb30-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-302"><a href="#cb30-302" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Beta regression coefficients (factor reference levels based on alphabetical order)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="beta-regression-coefficients-factor-reference-levels-based-on-alphabetical-order" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="beta-regression-coefficients-factor-reference-levels-based-on-alphabetical-order"><span class="header-section-number">3.1</span> Beta regression coefficients (factor reference levels based on alphabetical order)</h2>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Compliance</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="compliance" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="compliance"><span class="header-section-number">3.1.1</span> Compliance</h3>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(beta_compliance_red) <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>statistic) <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Race (reference level Black)"</span>, <span class="dv">3</span>, <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"job (reference level Full Time)"</span>, <span class="dv">6</span>, <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">11</span>, <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">component</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.4656202</td>
<td style="text-align: right;">0.1722355</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.0077218</td>
<td style="text-align: right;">0.0025338</td>
<td style="text-align: right;">0.0023075</td>
</tr>
<tr class="odd" data-grouplength="3">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Race (reference level Black)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">raceOther</td>
<td style="text-align: right;">-0.0000154</td>
<td style="text-align: right;">0.1035300</td>
<td style="text-align: right;">0.9998809</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">raceRefused/missing</td>
<td style="text-align: right;">-0.1131639</td>
<td style="text-align: right;">0.3348571</td>
<td style="text-align: right;">0.7354034</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">raceWhite</td>
<td style="text-align: right;">0.1482887</td>
<td style="text-align: right;">0.0878694</td>
<td style="text-align: right;">0.0914874</td>
</tr>
<tr class="odd" data-grouplength="5">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>job (reference level Full Time)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobOther</td>
<td style="text-align: right;">0.3114931</td>
<td style="text-align: right;">0.1846286</td>
<td style="text-align: right;">0.0915776</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobPart Time</td>
<td style="text-align: right;">-0.1640795</td>
<td style="text-align: right;">0.0855055</td>
<td style="text-align: right;">0.0549926</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobStudent</td>
<td style="text-align: right;">-0.2596616</td>
<td style="text-align: right;">0.1956821</td>
<td style="text-align: right;">0.1845232</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobUnemployed</td>
<td style="text-align: right;">0.0299534</td>
<td style="text-align: right;">0.0846908</td>
<td style="text-align: right;">0.7235793</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobMissing</td>
<td style="text-align: right;">-0.5690129</td>
<td style="text-align: right;">0.6021055</td>
<td style="text-align: right;">0.3446392</td>
</tr>
<tr class="odd" data-grouplength="3">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Marital (ref level Married or Partnered)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalNever married</td>
<td style="text-align: right;">0.2686716</td>
<td style="text-align: right;">0.0884782</td>
<td style="text-align: right;">0.0023927</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalSeparated/Divorced/Widowed</td>
<td style="text-align: right;">0.2431355</td>
<td style="text-align: right;">0.1008997</td>
<td style="text-align: right;">0.0159667</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalMissing</td>
<td style="text-align: right;">0.5755636</td>
<td style="text-align: right;">0.6054473</td>
<td style="text-align: right;">0.3417862</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">heroin1</td>
<td style="text-align: right;">-0.1291437</td>
<td style="text-align: right;">0.0619663</td>
<td style="text-align: right;">0.0371516</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">opioid1</td>
<td style="text-align: right;">0.2627274</td>
<td style="text-align: right;">0.0567428</td>
<td style="text-align: right;">0.0000037</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">(phi)</td>
<td style="text-align: right;">1.2804061</td>
<td style="text-align: right;">0.0325090</td>
<td style="text-align: right;">0.0000000</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### No major difference between Projects</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="no-major-difference-between-projects" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="no-major-difference-between-projects"><span class="header-section-number">3.1.2</span> No major difference between Projects</h3>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">Update models by adding project and look for marginal means between projects</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Update models by adding project and look for marginal means between projects</p>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">#### Compliance</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="compliance-1" class="level4" data-number="3.1.2.1">
<h4 data-number="3.1.2.1" class="anchored" data-anchor-id="compliance-1"><span class="header-section-number">3.1.2.1</span> Compliance</h4>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(beta_compliance_red,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">project</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">predicted</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">27</td>
<td style="text-align: right;">0.2862537</td>
<td style="text-align: right;">0.2271404</td>
<td style="text-align: right;">0.3453670</td>
</tr>
<tr class="even">
<td style="text-align: left;">30</td>
<td style="text-align: right;">0.2495486</td>
<td style="text-align: right;">0.1970343</td>
<td style="text-align: right;">0.3020629</td>
</tr>
<tr class="odd">
<td style="text-align: left;">51</td>
<td style="text-align: right;">0.3312811</td>
<td style="text-align: right;">0.2736646</td>
<td style="text-align: right;">0.3888977</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">#### Attendance</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="attendance" class="level4" data-number="3.1.2.2">
<h4 data-number="3.1.2.2" class="anchored" data-anchor-id="attendance"><span class="header-section-number">3.1.2.2</span> Attendance</h4>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggemmeans</span>(<span class="fu">update</span>(beta_attendance_red,.<span class="sc">~</span>.<span class="sc">+</span>project),<span class="st">"project"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()   <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">project=</span>x, predicted, conf.low, conf.high) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">project</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">predicted</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">27</td>
<td style="text-align: right;">0.4234444</td>
<td style="text-align: right;">0.3310894</td>
<td style="text-align: right;">0.5157993</td>
</tr>
<tr class="even">
<td style="text-align: left;">30</td>
<td style="text-align: right;">0.4437619</td>
<td style="text-align: right;">0.3556613</td>
<td style="text-align: right;">0.5318625</td>
</tr>
<tr class="odd">
<td style="text-align: left;">51</td>
<td style="text-align: right;">0.4345425</td>
<td style="text-align: right;">0.3448335</td>
<td style="text-align: right;">0.5242516</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Attendance</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="attendance-1" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="attendance-1"><span class="header-section-number">3.1.3</span> Attendance</h3>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(beta_attendance_red) <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>statistic) <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Job (reference level Full Time)"</span>, <span class="dv">3</span>, <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Is living stable (reference level No)"</span>, <span class="dv">8</span>, <span class="dv">9</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Marital (ref level Married or Partnered)"</span>, <span class="dv">10</span>, <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>
<table class="table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">component</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.1593638</td>
<td style="text-align: right;">0.2248213</td>
<td style="text-align: right;">0.0000003</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.0075580</td>
<td style="text-align: right;">0.0024485</td>
<td style="text-align: right;">0.0020234</td>
</tr>
<tr class="odd" data-grouplength="5">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Job (reference level Full Time)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobOther</td>
<td style="text-align: right;">0.3098685</td>
<td style="text-align: right;">0.1813007</td>
<td style="text-align: right;">0.0874248</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobPart Time</td>
<td style="text-align: right;">-0.1632520</td>
<td style="text-align: right;">0.0856712</td>
<td style="text-align: right;">0.0567067</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobStudent</td>
<td style="text-align: right;">0.0124950</td>
<td style="text-align: right;">0.1970223</td>
<td style="text-align: right;">0.9494328</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobUnemployed</td>
<td style="text-align: right;">0.0808107</td>
<td style="text-align: right;">0.0845202</td>
<td style="text-align: right;">0.3390160</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">jobMissing</td>
<td style="text-align: right;">-0.7457840</td>
<td style="text-align: right;">0.8317397</td>
<td style="text-align: right;">0.3699027</td>
</tr>
<tr class="odd" data-grouplength="2">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Is living stable (reference level No)</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">is_living_stableYes</td>
<td style="text-align: right;">0.3387088</td>
<td style="text-align: right;">0.1782797</td>
<td style="text-align: right;">0.0574498</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">is_living_stableMissing</td>
<td style="text-align: right;">1.2729703</td>
<td style="text-align: right;">1.1954770</td>
<td style="text-align: right;">0.2869565</td>
</tr>
<tr class="even" data-grouplength="3">
<td colspan="5" style="text-align: left; border-bottom: 1px solid;"><strong>Marital (ref level Married or Partnered)</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalNever married</td>
<td style="text-align: right;">0.2358692</td>
<td style="text-align: right;">0.0874130</td>
<td style="text-align: right;">0.0069688</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalSeparated/Divorced/Widowed</td>
<td style="text-align: right;">0.0987595</td>
<td style="text-align: right;">0.1001031</td>
<td style="text-align: right;">0.3238495</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">mean</td>
<td style="text-align: left;">maritalMissing</td>
<td style="text-align: right;">0.0036187</td>
<td style="text-align: right;">0.8424911</td>
<td style="text-align: right;">0.9965729</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">opioid1</td>
<td style="text-align: right;">0.2378354</td>
<td style="text-align: right;">0.0517281</td>
<td style="text-align: right;">0.0000043</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">speed1</td>
<td style="text-align: right;">-0.1193640</td>
<td style="text-align: right;">0.0573867</td>
<td style="text-align: right;">0.0375262</td>
</tr>
<tr class="even">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">(phi)</td>
<td style="text-align: right;">1.4512074</td>
<td style="text-align: right;">0.0337427</td>
<td style="text-align: right;">0.0000000</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">## Estimated marginal means</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="estimated-marginal-means-1" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="estimated-marginal-means-1"><span class="header-section-number">3.2</span> Estimated marginal means</h2>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="age-1" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="age-1"><span class="header-section-number">3.2.1</span> Age</h3>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>emm_compliance_age <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"age"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>emm_attendance_age <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"age"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_age, emm_compliance_age) <span class="sc">%&gt;%</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>predicted, <span class="at">ymax=</span>conf.high, <span class="at">ymin=</span>conf.low, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_smooth</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">geom_ribbon</span>(<span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="cn">NA</span>) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Estimate"</span>,<span class="at">x=</span><span class="st">"Age"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-1.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Age (raw data) </span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="age-raw-data" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="age-raw-data"><span class="header-section-number">3.2.2</span> Age (raw data)</h3>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>compliance_results <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(compliance, attendance, age) <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>age) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>age,<span class="at">y=</span>value, <span class="at">color=</span>name, <span class="at">fill=</span>name)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.25</span>) <span class="sc">+</span> <span class="fu">geom_smooth</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">color=</span><span class="st">"Outcome"</span>, <span class="at">fill=</span><span class="st">"Outcome"</span>, <span class="at">y=</span><span class="st">"Rate"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">label=</span>percent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-2.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Marital</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="marital-1" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="marital-1"><span class="header-section-number">3.2.3</span> Marital</h3>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>emm_compliance_marital <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>emm_attendance_marital <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"marital"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_marital, emm_compliance_marital) <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Marital"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-3.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Job</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="job" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="job"><span class="header-section-number">3.2.4</span> Job</h3>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>emm_compliance_job <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"job"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>emm_attendance_job <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"job"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_job, emm_compliance_job) <span class="sc">%&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Job"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-4.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Opioid</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="opioid" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="opioid"><span class="header-section-number">3.2.5</span> Opioid</h3>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>emm_compliance_opioid <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"opioid"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"compliance"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>emm_attendance_opioid <span class="ot">&lt;-</span> <span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"opioid"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outcome=</span><span class="st">"attendance"</span>)<span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(emm_attendance_opioid, emm_compliance_opioid) <span class="sc">%&gt;%</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)) <span class="sc">%&gt;%</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>x, <span class="at">x=</span>predicted, <span class="at">xmax=</span>conf.high, <span class="at">xmin=</span> predicted, <span class="at">color=</span>outcome, <span class="at">fill=</span>outcome, <span class="at">group=</span>outcome)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="st">"dodge"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">label=</span>percent) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"opioid"</span>, <span class="at">x=</span><span class="st">"Estimate"</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span>outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-5.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#test_predictions(beta_compliance_red, "marital") %&gt;%</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  kable() %&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  kable_styling()</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Race (compliance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="race-compliance-alone" class="level3" data-number="3.2.6">
<h3 data-number="3.2.6" class="anchored" data-anchor-id="race-compliance-alone"><span class="header-section-number">3.2.6</span> Race (compliance alone)</h3>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"race"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-6.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Heroin (compliance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="heroin-compliance-alone" class="level3" data-number="3.2.7">
<h3 data-number="3.2.7" class="anchored" data-anchor-id="heroin-compliance-alone"><span class="header-section-number">3.2.7</span> Heroin (compliance alone)</h3>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_compliance_red, <span class="st">"heroin"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-7.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Speed (attendance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="speed-attendance-alone" class="level3" data-number="3.2.8">
<h3 data-number="3.2.8" class="anchored" data-anchor-id="speed-attendance-alone"><span class="header-section-number">3.2.8</span> Speed (attendance alone)</h3>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"speed"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-8.png" class="img-fluid" width="2400"></p>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">### Is living stable (attendance alone)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="is-living-stable-attendance-alone" class="level3" data-number="3.2.9">
<h3 data-number="3.2.9" class="anchored" data-anchor-id="is-living-stable-attendance-alone"><span class="header-section-number">3.2.9</span> Is living stable (attendance alone)</h3>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggemmeans</span>(beta_attendance_red, <span class="st">"is_living_stable"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="index_files/figure-html/compliance-9.png" class="img-fluid" width="2400"></p>
</section>
</section>
</section>
<section id="conclusions" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> CONCLUSIONS</h1>
<p>Analyses of the data indicate that the age of the participant is the most important factor for both successful randomization and higher attendance/compliance, however the effects go in opposite directions:</p>
<ul>
<li><p>For randomization, the probability of enrollment is lower with increasing age.</p></li>
<li><p>Once randomized, the rates of attendance and compliance goe up with increasing age.</p></li>
</ul>
<p>For randomization, the other predictors are the total reported drugs and martial status, but in both cases missing is the most important factor – and there, lack of reported data (indicating unwillingness to participate by reporting data?) indicates lower probability of being randomized. The predictive power of this model is quite strong (AUC 0.8, linear calibration curve).</p>
<p>For compliance and attendance, the predictive power of models are lower. Age remains the most powerful predictor, while other predictors appear to be race, job, marital status, and heroin and opioid.</p>
<p>Future recruitment of patients into drug treatment trials might try greater outreach to older patients, who seemed less willing to participate but more successful.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/maltenform\.github\.io\/r_medicine_comp\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb60" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "R/Medicine 2024 Data Challenge"</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Mitchell Maltenfort"</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="an">number-sections:</span><span class="co"> TRUE</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="an">fig-height:</span><span class="co"> 8</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="an">fig-width:</span><span class="co"> 8</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="an">fig-dpi:</span><span class="co"> 300</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="co">  output: asis</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="co">  error: false</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="fu"># INTRODUCTION</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>This is my attempt at the analyses requested in <span class="ot">&lt;https://rconsortium.github.io/RMedicine_website/Competition.html&gt;</span>. I focused on identifying predictive factors associated with two questions.</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Of the potential patients providing data, what factors were associated with succesful randomization?</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Defining compliance as the % of potential study weeks where a patient showed up with a negative test, what factors were associated with higher compliance?</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="in"># load data and packages</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="in">require(tidyverse)</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="in">require(public.ctn0094data)</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a><span class="in">require(public.ctn0094extra)</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a><span class="in">require(pROC)</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a><span class="in">require(ggeffects)</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a><span class="in">require(kableExtra)</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a><span class="in">require(broom)</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a><span class="in">require(rms)</span></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a><span class="in">require(betareg)</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a><span class="in">require(scales)</span></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a><span class="in">require(emmeans)</span></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a><span class="in">require(marginaleffects)</span></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a><span class="fu"># SUCCESSFUL RANDOMIZATION</span></span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>Of the patients listed in 'everybody' which ones are successfully randomized ('randomization')?</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r randomization}</span></span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a><span class="in"># create wide table of drug usage</span></span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a><span class="in">data_ls &lt;- loadRawData(c("randomization", "treatment", "rbs", "demographics", "everybody"))</span></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a><span class="in">rbs_wide &lt;-</span></span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a><span class="in">  data_ls$rbs %&gt;%</span></span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(value = case_when(did_use == "Yes" ~ 1, did_use == "No" ~ 0)) %&gt;%</span></span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(who, what, value) %&gt;%</span></span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a><span class="in">  right_join(data_ls$everybody %&gt;% dplyr::select(who)) %&gt;%</span></span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(value = case_when(is.na(value) ~ 0, TRUE ~ value)) %&gt;%</span></span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = what, values_fill = 0) %&gt;%</span></span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(total_reported_drugs = cocaine + heroin + speedball + opioid + speed) %&gt;%</span></span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-`NA`) %&gt;%</span></span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(total_reported_drugs = as.factor(total_reported_drugs))</span></span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a><span class="in">randomization_tbl &lt;-</span></span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a><span class="in">  data_ls$demographics %&gt;%</span></span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join( data_ls$randomization %&gt;% filter(which == 1)) %&gt;%</span></span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(randomization = as.factor(case_when(is.na(which) ~ "0", TRUE ~ which))) %&gt;%</span></span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_join(rbs_wide) %&gt;%</span></span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(job = as.factor(case_when(is.na(job) ~ "Missing", TRUE ~ job))) %&gt;%</span></span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(is_living_stable = as.factor(case_when(is.na(is_living_stable) ~ "Missing", TRUE ~ is_living_stable))) %&gt;%</span></span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(education = as.factor(case_when(is.na(education) ~ "Missing", TRUE ~ education))) %&gt;%</span></span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(marital = as.factor(case_when(is.na(marital) ~ "Missing", TRUE ~ marital))) %&gt;%</span></span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(job = fct_relevel(job, "Missing", after = Inf)) %&gt;%</span></span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(is_living_stable = fct_relevel(is_living_stable, "Missing", after = Inf)) %&gt;%</span></span>
<span id="cb60-75"><a href="#cb60-75" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(education = fct_relevel(education, "Missing", after = Inf)) %&gt;%</span></span>
<span id="cb60-76"><a href="#cb60-76" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(marital = fct_relevel(marital, "Missing", after = Inf)) %&gt;%</span></span>
<span id="cb60-77"><a href="#cb60-77" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(cocaine = as.factor(cocaine), heroin = as.factor(heroin), speedball = as.factor(speedball), opioid = as.factor(opioid), speed = as.factor(speed)) %&gt;%</span></span>
<span id="cb60-78"><a href="#cb60-78" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_join(everybody)</span></span>
<span id="cb60-79"><a href="#cb60-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-80"><a href="#cb60-80" aria-hidden="true" tabindex="-1"></a><span class="in"># use optimum penalty of 1 determined manually using 'pentrace'</span></span>
<span id="cb60-81"><a href="#cb60-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-82"><a href="#cb60-82" aria-hidden="true" tabindex="-1"></a><span class="in">lrm_randomization &lt;-</span></span>
<span id="cb60-83"><a href="#cb60-83" aria-hidden="true" tabindex="-1"></a><span class="in">  lrm(randomization ~ pol(age, 2) + job + education + marital + is_male + is_hispanic + race + total_reported_drugs + heroin + speedball + opioid, randomization_tbl, x = TRUE, y = TRUE, penalty = 1)</span></span>
<span id="cb60-84"><a href="#cb60-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-85"><a href="#cb60-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-86"><a href="#cb60-86" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n## Use bootstrap validation to determine what values are persistent\n\n")</span></span>
<span id="cb60-87"><a href="#cb60-87" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n'Total reported drugs' is cocaine + speed + speedball + opioid + heroin as 0/1 from rbs\n\n")</span></span>
<span id="cb60-88"><a href="#cb60-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-89"><a href="#cb60-89" aria-hidden="true" tabindex="-1"></a><span class="in">validate_randomization &lt;- validate(lrm_randomization, B = 200, bw = TRUE)</span></span>
<span id="cb60-90"><a href="#cb60-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-91"><a href="#cb60-91" aria-hidden="true" tabindex="-1"></a><span class="in">summary(attr(validate_randomization, "kept")) %&gt;%</span></span>
<span id="cb60-92"><a href="#cb60-92" aria-hidden="true" tabindex="-1"></a><span class="in">  kable() %&gt;%</span></span>
<span id="cb60-93"><a href="#cb60-93" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling()</span></span>
<span id="cb60-94"><a href="#cb60-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-95"><a href="#cb60-95" aria-hidden="true" tabindex="-1"></a><span class="in">lrm_final &lt;- lrm(randomization ~ pol(age, 2) + marital + total_reported_drugs, randomization_tbl, x = TRUE, y = TRUE, penalty = 1)</span></span>
<span id="cb60-96"><a href="#cb60-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-97"><a href="#cb60-97" aria-hidden="true" tabindex="-1"></a><span class="in">randomization_tbl$predict_randomization &lt;- predict(lrm_final, type = "fitted")</span></span>
<span id="cb60-98"><a href="#cb60-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-99"><a href="#cb60-99" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n## Project 51 has almost perfect randomization compared to other two\n\n")</span></span>
<span id="cb60-100"><a href="#cb60-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-101"><a href="#cb60-101" aria-hidden="true" tabindex="-1"></a><span class="in">ggemmeans(update(lrm_final,.~.+project),"project") %&gt;% as.data.frame()   %&gt;% dplyr::select(project=x, predicted, conf.low, conf.high) %&gt;% kable() %&gt;% kable_styling()</span></span>
<span id="cb60-102"><a href="#cb60-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-103"><a href="#cb60-103" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n## Use bootstrap validtion to determine what values are persistent\n\n")</span></span>
<span id="cb60-104"><a href="#cb60-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-105"><a href="#cb60-105" aria-hidden="true" tabindex="-1"></a><span class="in">coef &lt;- coefficients(lrm_final)</span></span>
<span id="cb60-106"><a href="#cb60-106" aria-hidden="true" tabindex="-1"></a><span class="in">se &lt;- sqrt(diag(vcov(lrm_final)))</span></span>
<span id="cb60-107"><a href="#cb60-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-108"><a href="#cb60-108" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n## Final logistic regression model predicting successful randomization (log-odds)\n\n")</span></span>
<span id="cb60-109"><a href="#cb60-109" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n(factor reference levels based on alphabetical order)\n\n")</span></span>
<span id="cb60-110"><a href="#cb60-110" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(term = names(coef), coef, se) %&gt;%</span></span>
<span id="cb60-111"><a href="#cb60-111" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(p = 2 * case_when(coef &gt; 0 ~ pnorm(coef / se, lower.tail = FALSE), TRUE ~ pnorm(coef / se, lower.tail = TRUE))) %&gt;%</span></span>
<span id="cb60-112"><a href="#cb60-112" aria-hidden="true" tabindex="-1"></a><span class="in">  kable() %&gt;%</span></span>
<span id="cb60-113"><a href="#cb60-113" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling() %&gt;%</span></span>
<span id="cb60-114"><a href="#cb60-114" aria-hidden="true" tabindex="-1"></a><span class="in">  pack_rows("Marital (ref level Married or Partnered)", 4, 6) %&gt;%</span></span>
<span id="cb60-115"><a href="#cb60-115" aria-hidden="true" tabindex="-1"></a><span class="in">  pack_rows("Total Reported Drugs (reference level 0)", 7, 11)</span></span>
<span id="cb60-116"><a href="#cb60-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-117"><a href="#cb60-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-118"><a href="#cb60-118" aria-hidden="true" tabindex="-1"></a><span class="in">calibrate_final &lt;- calibrate(lrm_final, B = 200)</span></span>
<span id="cb60-119"><a href="#cb60-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-120"><a href="#cb60-120" aria-hidden="true" tabindex="-1"></a><span class="in">calibrate_tbl &lt;-</span></span>
<span id="cb60-121"><a href="#cb60-121" aria-hidden="true" tabindex="-1"></a><span class="in">  calibrate_final[, c("predy", "calibrated.orig", "calibrated.corrected")] %&gt;%</span></span>
<span id="cb60-122"><a href="#cb60-122" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() %&gt;%</span></span>
<span id="cb60-123"><a href="#cb60-123" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(calibrated.orig:calibrated.corrected)</span></span>
<span id="cb60-124"><a href="#cb60-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-125"><a href="#cb60-125" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n## Show calibration (predicted vs actual) for predictive model of randomization\n\n")</span></span>
<span id="cb60-126"><a href="#cb60-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-127"><a href="#cb60-127" aria-hidden="true" tabindex="-1"></a><span class="in">calibrate_tbl %&gt;%</span></span>
<span id="cb60-128"><a href="#cb60-128" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = predy, y = value, color = name)) +</span></span>
<span id="cb60-129"><a href="#cb60-129" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1) +</span></span>
<span id="cb60-130"><a href="#cb60-130" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw() +</span></span>
<span id="cb60-131"><a href="#cb60-131" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(color = "calibration", x = "Predicted Probability", y = "Actual Probability") +</span></span>
<span id="cb60-132"><a href="#cb60-132" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = c(0.8, 0.2)) +</span></span>
<span id="cb60-133"><a href="#cb60-133" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_abline(linetype = "dashed")</span></span>
<span id="cb60-134"><a href="#cb60-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-135"><a href="#cb60-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-136"><a href="#cb60-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-137"><a href="#cb60-137" aria-hidden="true" tabindex="-1"></a><span class="in">auc &lt;- ci.auc(roc(randomization ~ predict_randomization, data = randomization_tbl %&gt;% filter(!is.na(predict_randomization))))</span></span>
<span id="cb60-138"><a href="#cb60-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-139"><a href="#cb60-139" aria-hidden="true" tabindex="-1"></a><span class="in">cat(sprintf("\n\n## ROC curve AUC is %0.2f (95 percent CI %0.2f - %0.2f)\n\n", auc[2], auc[1], auc[3]))</span></span>
<span id="cb60-140"><a href="#cb60-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-141"><a href="#cb60-141" aria-hidden="true" tabindex="-1"></a><span class="in">plot(roc(randomization ~ predict_randomization, data = randomization_tbl %&gt;% filter(!is.na(predict_randomization))))</span></span>
<span id="cb60-142"><a href="#cb60-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-143"><a href="#cb60-143" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n")</span></span>
<span id="cb60-144"><a href="#cb60-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-145"><a href="#cb60-145" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n## Estimated marginal means\n\n")</span></span>
<span id="cb60-146"><a href="#cb60-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-147"><a href="#cb60-147" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Marital\n\n")</span></span>
<span id="cb60-148"><a href="#cb60-148" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ggemmeans(lrm_final, "marital"))</span></span>
<span id="cb60-149"><a href="#cb60-149" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n")</span></span>
<span id="cb60-150"><a href="#cb60-150" aria-hidden="true" tabindex="-1"></a><span class="in">test_predictions(lrm_final, "marital") %&gt;%</span></span>
<span id="cb60-151"><a href="#cb60-151" aria-hidden="true" tabindex="-1"></a><span class="in">  kable() %&gt;%</span></span>
<span id="cb60-152"><a href="#cb60-152" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling()</span></span>
<span id="cb60-153"><a href="#cb60-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-154"><a href="#cb60-154" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Total reported drugs\n\n")</span></span>
<span id="cb60-155"><a href="#cb60-155" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ggemmeans(lrm_final, "total_reported_drugs"))</span></span>
<span id="cb60-156"><a href="#cb60-156" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n")</span></span>
<span id="cb60-157"><a href="#cb60-157" aria-hidden="true" tabindex="-1"></a><span class="in">test_predictions(lrm_final, "total_reported_drugs") %&gt;%</span></span>
<span id="cb60-158"><a href="#cb60-158" aria-hidden="true" tabindex="-1"></a><span class="in">  kable() %&gt;%</span></span>
<span id="cb60-159"><a href="#cb60-159" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling()</span></span>
<span id="cb60-160"><a href="#cb60-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-161"><a href="#cb60-161" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Age\n\n")</span></span>
<span id="cb60-162"><a href="#cb60-162" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ggemmeans(lrm_final, "age[all]"))</span></span>
<span id="cb60-163"><a href="#cb60-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-164"><a href="#cb60-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-165"><a href="#cb60-165" aria-hidden="true" tabindex="-1"></a><span class="fu"># ATTENDANCE AND COMPLIANCE POST-RANDOMIZATION</span></span>
<span id="cb60-166"><a href="#cb60-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-167"><a href="#cb60-167" aria-hidden="true" tabindex="-1"></a>This adapts the code from 'public.ctn0094extra' vignette to summarise substance use across weeks.</span>
<span id="cb60-168"><a href="#cb60-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-169"><a href="#cb60-169" aria-hidden="true" tabindex="-1"></a>I define compliance as how many times the patient showed up with a negative UDS report, divided by the length of time in the study (Study Week + 1 for Baseline). Attendance is how many times the patient showed up with a report (positive or negative), divided by length of time in the study.</span>
<span id="cb60-170"><a href="#cb60-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-171"><a href="#cb60-171" aria-hidden="true" tabindex="-1"></a>Beta regression is used to create a parsimonious model, pruned "by hand" to get rid of irrelevant predictors. The correlation coefficients for these models are not good (R-squared <span class="sc">\&lt;</span> 0.03) but there may be some insight into how to get better attendance or compliance for patients</span>
<span id="cb60-172"><a href="#cb60-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-173"><a href="#cb60-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compliance}</span></span>
<span id="cb60-174"><a href="#cb60-174" aria-hidden="true" tabindex="-1"></a><span class="in">data_ls &lt;- loadRawData(c("randomization", "treatment"))</span></span>
<span id="cb60-175"><a href="#cb60-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-176"><a href="#cb60-176" aria-hidden="true" tabindex="-1"></a><span class="in">data_ls$randomization &lt;-</span></span>
<span id="cb60-177"><a href="#cb60-177" aria-hidden="true" tabindex="-1"></a><span class="in">  data_ls$randomization %&gt;%</span></span>
<span id="cb60-178"><a href="#cb60-178" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, when, treatment, randomized = which) %&gt;%</span></span>
<span id="cb60-179"><a href="#cb60-179" aria-hidden="true" tabindex="-1"></a><span class="in">  # Remove second randomization events</span></span>
<span id="cb60-180"><a href="#cb60-180" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(randomized != 2)</span></span>
<span id="cb60-181"><a href="#cb60-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-182"><a href="#cb60-182" aria-hidden="true" tabindex="-1"></a><span class="in">data_ls$treatment &lt;-</span></span>
<span id="cb60-183"><a href="#cb60-183" aria-hidden="true" tabindex="-1"></a><span class="in">  data_ls$treatment</span></span>
<span id="cb60-184"><a href="#cb60-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-185"><a href="#cb60-185" aria-hidden="true" tabindex="-1"></a><span class="in">start_int &lt;- c(`27` = -30L, `51` = -30L)</span></span>
<span id="cb60-186"><a href="#cb60-186" aria-hidden="true" tabindex="-1"></a><span class="in">end_int &lt;- c(`27` = 168L, `51` = 168L)</span></span>
<span id="cb60-187"><a href="#cb60-187" aria-hidden="true" tabindex="-1"></a><span class="in">backbone2751_df &lt;-</span></span>
<span id="cb60-188"><a href="#cb60-188" aria-hidden="true" tabindex="-1"></a><span class="in">  CreateProtocolHistory(</span></span>
<span id="cb60-189"><a href="#cb60-189" aria-hidden="true" tabindex="-1"></a><span class="in">    start_vec = start_int,</span></span>
<span id="cb60-190"><a href="#cb60-190" aria-hidden="true" tabindex="-1"></a><span class="in">    end_vec = end_int</span></span>
<span id="cb60-191"><a href="#cb60-191" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb60-192"><a href="#cb60-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-193"><a href="#cb60-193" aria-hidden="true" tabindex="-1"></a><span class="in">backbone30_df &lt;-</span></span>
<span id="cb60-194"><a href="#cb60-194" aria-hidden="true" tabindex="-1"></a><span class="in">  randomization %&gt;%</span></span>
<span id="cb60-195"><a href="#cb60-195" aria-hidden="true" tabindex="-1"></a><span class="in">  full_join(everybody, by = "who") %&gt;%</span></span>
<span id="cb60-196"><a href="#cb60-196" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(project == "30") %&gt;%</span></span>
<span id="cb60-197"><a href="#cb60-197" aria-hidden="true" tabindex="-1"></a><span class="in">  CreateCTN30ProtocolHistory() %&gt;%</span></span>
<span id="cb60-198"><a href="#cb60-198" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(project = "30") %&gt;%</span></span>
<span id="cb60-199"><a href="#cb60-199" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, project, when)</span></span>
<span id="cb60-200"><a href="#cb60-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-201"><a href="#cb60-201" aria-hidden="true" tabindex="-1"></a><span class="in">backbone_df &lt;-</span></span>
<span id="cb60-202"><a href="#cb60-202" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_rows(backbone2751_df, backbone30_df) %&gt;%</span></span>
<span id="cb60-203"><a href="#cb60-203" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(who)</span></span>
<span id="cb60-204"><a href="#cb60-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-205"><a href="#cb60-205" aria-hidden="true" tabindex="-1"></a><span class="in">rm(backbone2751_df, backbone30_df, start_int, end_int)</span></span>
<span id="cb60-206"><a href="#cb60-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-207"><a href="#cb60-207" aria-hidden="true" tabindex="-1"></a><span class="in">data_ls &lt;- loadRawData(c("randomization", "visit"))</span></span>
<span id="cb60-208"><a href="#cb60-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-209"><a href="#cb60-209" aria-hidden="true" tabindex="-1"></a><span class="in">data_ls$randomization &lt;-</span></span>
<span id="cb60-210"><a href="#cb60-210" aria-hidden="true" tabindex="-1"></a><span class="in">  data_ls$randomization %&gt;%</span></span>
<span id="cb60-211"><a href="#cb60-211" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, when, treatment, randomized = which) %&gt;%</span></span>
<span id="cb60-212"><a href="#cb60-212" aria-hidden="true" tabindex="-1"></a><span class="in">  # Remove second randomization events</span></span>
<span id="cb60-213"><a href="#cb60-213" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(randomized != 2)</span></span>
<span id="cb60-214"><a href="#cb60-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-215"><a href="#cb60-215" aria-hidden="true" tabindex="-1"></a><span class="in">data_ls$visit &lt;-</span></span>
<span id="cb60-216"><a href="#cb60-216" aria-hidden="true" tabindex="-1"></a><span class="in">  data_ls$visit</span></span>
<span id="cb60-217"><a href="#cb60-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-218"><a href="#cb60-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-219"><a href="#cb60-219" aria-hidden="true" tabindex="-1"></a><span class="in">timelineRand1_df &lt;-</span></span>
<span id="cb60-220"><a href="#cb60-220" aria-hidden="true" tabindex="-1"></a><span class="in">  data_ls$randomization %&gt;%</span></span>
<span id="cb60-221"><a href="#cb60-221" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(randomized = randomized == "1") %&gt;%</span></span>
<span id="cb60-222"><a href="#cb60-222" aria-hidden="true" tabindex="-1"></a><span class="in">  # Join to backbone and arrange within subject by day</span></span>
<span id="cb60-223"><a href="#cb60-223" aria-hidden="true" tabindex="-1"></a><span class="in">  full_join(backbone_df, by = c("who", "when")) %&gt;%</span></span>
<span id="cb60-224"><a href="#cb60-224" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(who) %&gt;%</span></span>
<span id="cb60-225"><a href="#cb60-225" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(when, .by_group = TRUE) %&gt;%</span></span>
<span id="cb60-226"><a href="#cb60-226" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, project, when, randomized)</span></span>
<span id="cb60-227"><a href="#cb60-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-228"><a href="#cb60-228" aria-hidden="true" tabindex="-1"></a><span class="in">timelineVisit1_df &lt;-</span></span>
<span id="cb60-229"><a href="#cb60-229" aria-hidden="true" tabindex="-1"></a><span class="in">  data_ls$visit %&gt;%</span></span>
<span id="cb60-230"><a href="#cb60-230" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, when, visit, status = what) %&gt;%</span></span>
<span id="cb60-231"><a href="#cb60-231" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(status %in% c("visit", "final")) %&gt;%</span></span>
<span id="cb60-232"><a href="#cb60-232" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(visit = TRUE) %&gt;%</span></span>
<span id="cb60-233"><a href="#cb60-233" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, when, visit) %&gt;%</span></span>
<span id="cb60-234"><a href="#cb60-234" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(timelineRand1_df, ., by = c("who", "when")) %&gt;%</span></span>
<span id="cb60-235"><a href="#cb60-235" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct()</span></span>
<span id="cb60-236"><a href="#cb60-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-237"><a href="#cb60-237" aria-hidden="true" tabindex="-1"></a><span class="in">timelineMissing1_df &lt;- MarkMissing(timelineVisit1_df)</span></span>
<span id="cb60-238"><a href="#cb60-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-239"><a href="#cb60-239" aria-hidden="true" tabindex="-1"></a><span class="in">derived_visitImputed &lt;-</span></span>
<span id="cb60-240"><a href="#cb60-240" aria-hidden="true" tabindex="-1"></a><span class="in">  timelineMissing1_df %&gt;%</span></span>
<span id="cb60-241"><a href="#cb60-241" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(visit = as.character(visit)) %&gt;%</span></span>
<span id="cb60-242"><a href="#cb60-242" aria-hidden="true" tabindex="-1"></a><span class="in">  replace_na(list(visit = "", visitYM = "")) %&gt;%</span></span>
<span id="cb60-243"><a href="#cb60-243" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(visitImputed = paste0(visit, visitYM)) %&gt;%</span></span>
<span id="cb60-244"><a href="#cb60-244" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb60-245"><a href="#cb60-245" aria-hidden="true" tabindex="-1"></a><span class="in">    visitImputed = str_replace(</span></span>
<span id="cb60-246"><a href="#cb60-246" aria-hidden="true" tabindex="-1"></a><span class="in">      visitImputed,</span></span>
<span id="cb60-247"><a href="#cb60-247" aria-hidden="true" tabindex="-1"></a><span class="in">      pattern = "TRUETRUE", replacement = "Present"</span></span>
<span id="cb60-248"><a href="#cb60-248" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb60-249"><a href="#cb60-249" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-250"><a href="#cb60-250" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, when, visitImputed) %&gt;%</span></span>
<span id="cb60-251"><a href="#cb60-251" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(visitImputed != "") %&gt;%</span></span>
<span id="cb60-252"><a href="#cb60-252" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb60-253"><a href="#cb60-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-254"><a href="#cb60-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-255"><a href="#cb60-255" aria-hidden="true" tabindex="-1"></a><span class="in">randomized_df &lt;-</span></span>
<span id="cb60-256"><a href="#cb60-256" aria-hidden="true" tabindex="-1"></a><span class="in">  randomization %&gt;%</span></span>
<span id="cb60-257"><a href="#cb60-257" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(randomized = as.integer(as.character(which))) %&gt;%</span></span>
<span id="cb60-258"><a href="#cb60-258" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, when, randomized) %&gt;%</span></span>
<span id="cb60-259"><a href="#cb60-259" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(everybody, by = "who") %&gt;%</span></span>
<span id="cb60-260"><a href="#cb60-260" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!(randomized == 2 &amp; project %in% c("27", "51"))) %&gt;%</span></span>
<span id="cb60-261"><a href="#cb60-261" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-project)</span></span>
<span id="cb60-262"><a href="#cb60-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-263"><a href="#cb60-263" aria-hidden="true" tabindex="-1"></a><span class="in">udsUse2_df &lt;-</span></span>
<span id="cb60-264"><a href="#cb60-264" aria-hidden="true" tabindex="-1"></a><span class="in">  backbone_df %&gt;%</span></span>
<span id="cb60-265"><a href="#cb60-265" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(randomized_df, by = c("who", "when")) %&gt;%</span></span>
<span id="cb60-266"><a href="#cb60-266" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(derived_visitImputed, by = c("who", "when")) %&gt;%</span></span>
<span id="cb60-267"><a href="#cb60-267" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(uds, by = c("who", "when")) %&gt;%</span></span>
<span id="cb60-268"><a href="#cb60-268" aria-hidden="true" tabindex="-1"></a><span class="in">  # So we can use MarkUse() with UDS data (instead of all_drugs)</span></span>
<span id="cb60-269"><a href="#cb60-269" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(source = "UDS")</span></span>
<span id="cb60-270"><a href="#cb60-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-271"><a href="#cb60-271" aria-hidden="true" tabindex="-1"></a><span class="in">rm(</span></span>
<span id="cb60-272"><a href="#cb60-272" aria-hidden="true" tabindex="-1"></a><span class="in">  backbone_df, data_ls, timelineMissing1_df, timelineRand1_df, timelineVisit1_df</span></span>
<span id="cb60-273"><a href="#cb60-273" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb60-274"><a href="#cb60-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-275"><a href="#cb60-275" aria-hidden="true" tabindex="-1"></a><span class="in">nonStudyOpioids_ls &lt;- list(</span></span>
<span id="cb60-276"><a href="#cb60-276" aria-hidden="true" tabindex="-1"></a><span class="in">  "Buprenorphine" = c("Opioid", "Methadone"),</span></span>
<span id="cb60-277"><a href="#cb60-277" aria-hidden="true" tabindex="-1"></a><span class="in">  "Methadone"     = c("Opioid", "Buprenorphine"),</span></span>
<span id="cb60-278"><a href="#cb60-278" aria-hidden="true" tabindex="-1"></a><span class="in">  "Naltrexone"    = c("Opioid", "Methadone", "Buprenorphine"),</span></span>
<span id="cb60-279"><a href="#cb60-279" aria-hidden="true" tabindex="-1"></a><span class="in">  "Not treated"   = c("Opioid", "Methadone", "Buprenorphine")</span></span>
<span id="cb60-280"><a href="#cb60-280" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb60-281"><a href="#cb60-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-282"><a href="#cb60-282" aria-hidden="true" tabindex="-1"></a><span class="in">treatGroups_ls &lt;-</span></span>
<span id="cb60-283"><a href="#cb60-283" aria-hidden="true" tabindex="-1"></a><span class="in">  randomization %&gt;%</span></span>
<span id="cb60-284"><a href="#cb60-284" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(which == 1) %&gt;%</span></span>
<span id="cb60-285"><a href="#cb60-285" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(everybody, by = "who") %&gt;%</span></span>
<span id="cb60-286"><a href="#cb60-286" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, treatment) %&gt;%</span></span>
<span id="cb60-287"><a href="#cb60-287" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb60-288"><a href="#cb60-288" aria-hidden="true" tabindex="-1"></a><span class="in">    treat_drug = case_when(</span></span>
<span id="cb60-289"><a href="#cb60-289" aria-hidden="true" tabindex="-1"></a><span class="in">      str_detect(treatment, "BUP") ~ "Buprenorphine",</span></span>
<span id="cb60-290"><a href="#cb60-290" aria-hidden="true" tabindex="-1"></a><span class="in">      treatment == "Methadone" ~ "Methadone",</span></span>
<span id="cb60-291"><a href="#cb60-291" aria-hidden="true" tabindex="-1"></a><span class="in">      treatment == "Inpatient NR-NTX" ~ "Naltrexone"</span></span>
<span id="cb60-292"><a href="#cb60-292" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb60-293"><a href="#cb60-293" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-294"><a href="#cb60-294" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-treatment) %&gt;%</span></span>
<span id="cb60-295"><a href="#cb60-295" aria-hidden="true" tabindex="-1"></a><span class="in">  split(f = .$treat_drug) %&gt;%</span></span>
<span id="cb60-296"><a href="#cb60-296" aria-hidden="true" tabindex="-1"></a><span class="in">  map(.f = "who")</span></span>
<span id="cb60-297"><a href="#cb60-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-298"><a href="#cb60-298" aria-hidden="true" tabindex="-1"></a><span class="in">opioidUse_df &lt;-</span></span>
<span id="cb60-299"><a href="#cb60-299" aria-hidden="true" tabindex="-1"></a><span class="in">  udsUse2_df %&gt;%</span></span>
<span id="cb60-300"><a href="#cb60-300" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb60-301"><a href="#cb60-301" aria-hidden="true" tabindex="-1"></a><span class="in">    treat_group = case_when(</span></span>
<span id="cb60-302"><a href="#cb60-302" aria-hidden="true" tabindex="-1"></a><span class="in">      who %in% treatGroups_ls$Buprenorphine ~ "Buprenorphine",</span></span>
<span id="cb60-303"><a href="#cb60-303" aria-hidden="true" tabindex="-1"></a><span class="in">      who %in% treatGroups_ls$Methadone ~ "Methadone",</span></span>
<span id="cb60-304"><a href="#cb60-304" aria-hidden="true" tabindex="-1"></a><span class="in">      who %in% treatGroups_ls$Naltrexone ~ "Naltrexone",</span></span>
<span id="cb60-305"><a href="#cb60-305" aria-hidden="true" tabindex="-1"></a><span class="in">      TRUE ~ "Not treated"</span></span>
<span id="cb60-306"><a href="#cb60-306" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb60-307"><a href="#cb60-307" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-308"><a href="#cb60-308" aria-hidden="true" tabindex="-1"></a><span class="in">  split(f = .$treat_group) %&gt;%</span></span>
<span id="cb60-309"><a href="#cb60-309" aria-hidden="true" tabindex="-1"></a><span class="in">  # List of data in alphabetical order, so the non-study drugs ls should match</span></span>
<span id="cb60-310"><a href="#cb60-310" aria-hidden="true" tabindex="-1"></a><span class="in">  map2(</span></span>
<span id="cb60-311"><a href="#cb60-311" aria-hidden="true" tabindex="-1"></a><span class="in">    .y = nonStudyOpioids_ls,</span></span>
<span id="cb60-312"><a href="#cb60-312" aria-hidden="true" tabindex="-1"></a><span class="in">    .f = ~ {</span></span>
<span id="cb60-313"><a href="#cb60-313" aria-hidden="true" tabindex="-1"></a><span class="in">      # REQUIRES "source" COLUMN</span></span>
<span id="cb60-314"><a href="#cb60-314" aria-hidden="true" tabindex="-1"></a><span class="in">      MarkUse(</span></span>
<span id="cb60-315"><a href="#cb60-315" aria-hidden="true" tabindex="-1"></a><span class="in">        targetDrugs_char = .y,</span></span>
<span id="cb60-316"><a href="#cb60-316" aria-hidden="true" tabindex="-1"></a><span class="in">        drugs_df = .x,</span></span>
<span id="cb60-317"><a href="#cb60-317" aria-hidden="true" tabindex="-1"></a><span class="in">        # because we have participants with no recorded UDS; in practice DO NOT</span></span>
<span id="cb60-318"><a href="#cb60-318" aria-hidden="true" tabindex="-1"></a><span class="in">        #   use this command</span></span>
<span id="cb60-319"><a href="#cb60-319" aria-hidden="true" tabindex="-1"></a><span class="in">        retainEmptyRows = TRUE</span></span>
<span id="cb60-320"><a href="#cb60-320" aria-hidden="true" tabindex="-1"></a><span class="in">      )</span></span>
<span id="cb60-321"><a href="#cb60-321" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb60-322"><a href="#cb60-322" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-323"><a href="#cb60-323" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_rows() %&gt;%</span></span>
<span id="cb60-324"><a href="#cb60-324" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb60-325"><a href="#cb60-325" aria-hidden="true" tabindex="-1"></a><span class="in">    udsOpioid = case_when(</span></span>
<span id="cb60-326"><a href="#cb60-326" aria-hidden="true" tabindex="-1"></a><span class="in">      is.na(when) ~ NA,</span></span>
<span id="cb60-327"><a href="#cb60-327" aria-hidden="true" tabindex="-1"></a><span class="in">      !is.na(when) ~ TRUE</span></span>
<span id="cb60-328"><a href="#cb60-328" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb60-329"><a href="#cb60-329" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-330"><a href="#cb60-330" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, when, udsOpioid)</span></span>
<span id="cb60-331"><a href="#cb60-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-332"><a href="#cb60-332" aria-hidden="true" tabindex="-1"></a><span class="in">timelineUDS_df &lt;-</span></span>
<span id="cb60-333"><a href="#cb60-333" aria-hidden="true" tabindex="-1"></a><span class="in">  udsUse2_df %&gt;%</span></span>
<span id="cb60-334"><a href="#cb60-334" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(opioidUse_df, by = c("who", "when")) %&gt;%</span></span>
<span id="cb60-335"><a href="#cb60-335" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-what, -source) %&gt;%</span></span>
<span id="cb60-336"><a href="#cb60-336" aria-hidden="true" tabindex="-1"></a><span class="in">  # 2,089 rows to 1,994</span></span>
<span id="cb60-337"><a href="#cb60-337" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct()</span></span>
<span id="cb60-338"><a href="#cb60-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-339"><a href="#cb60-339" aria-hidden="true" tabindex="-1"></a><span class="in">rm(</span></span>
<span id="cb60-340"><a href="#cb60-340" aria-hidden="true" tabindex="-1"></a><span class="in">  derived_visitImputed, opioidUse_df, randomized_df, treatGroups_ls, udsUse2_df</span></span>
<span id="cb60-341"><a href="#cb60-341" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb60-342"><a href="#cb60-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-343"><a href="#cb60-343" aria-hidden="true" tabindex="-1"></a><span class="in">wasRandomized_int &lt;-</span></span>
<span id="cb60-344"><a href="#cb60-344" aria-hidden="true" tabindex="-1"></a><span class="in">  timelineUDS_df %&gt;%</span></span>
<span id="cb60-345"><a href="#cb60-345" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(who) %&gt;%</span></span>
<span id="cb60-346"><a href="#cb60-346" aria-hidden="true" tabindex="-1"></a><span class="in">  summarise(randomized = any(randomized %in% 1:2)) %&gt;%</span></span>
<span id="cb60-347"><a href="#cb60-347" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(randomized) %&gt;%</span></span>
<span id="cb60-348"><a href="#cb60-348" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(who)</span></span>
<span id="cb60-349"><a href="#cb60-349" aria-hidden="true" tabindex="-1"></a><span class="in">notRandomized_int &lt;-</span></span>
<span id="cb60-350"><a href="#cb60-350" aria-hidden="true" tabindex="-1"></a><span class="in">  timelineUDS_df %&gt;%</span></span>
<span id="cb60-351"><a href="#cb60-351" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!(who %in% wasRandomized_int)) %&gt;%</span></span>
<span id="cb60-352"><a href="#cb60-352" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(who) %&gt;%</span></span>
<span id="cb60-353"><a href="#cb60-353" aria-hidden="true" tabindex="-1"></a><span class="in">  unique()</span></span>
<span id="cb60-354"><a href="#cb60-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-355"><a href="#cb60-355" aria-hidden="true" tabindex="-1"></a><span class="in">timelineUDS2_df &lt;-</span></span>
<span id="cb60-356"><a href="#cb60-356" aria-hidden="true" tabindex="-1"></a><span class="in">  timelineUDS_df %&gt;%</span></span>
<span id="cb60-357"><a href="#cb60-357" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(who %in% wasRandomized_int) %&gt;%</span></span>
<span id="cb60-358"><a href="#cb60-358" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(who) %&gt;%</span></span>
<span id="cb60-359"><a href="#cb60-359" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(randomized)) %&gt;%</span></span>
<span id="cb60-360"><a href="#cb60-360" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb60-361"><a href="#cb60-361" aria-hidden="true" tabindex="-1"></a><span class="in">    whenRandomized1 = case_when(randomized == 1 ~ when),</span></span>
<span id="cb60-362"><a href="#cb60-362" aria-hidden="true" tabindex="-1"></a><span class="in">    whenRandomized2 = case_when(randomized == 2 ~ when)</span></span>
<span id="cb60-363"><a href="#cb60-363" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-364"><a href="#cb60-364" aria-hidden="true" tabindex="-1"></a><span class="in">  select(who, when, whenRandomized1, whenRandomized2) %&gt;%</span></span>
<span id="cb60-365"><a href="#cb60-365" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(timelineUDS_df, ., by = c("who", "when")) %&gt;%</span></span>
<span id="cb60-366"><a href="#cb60-366" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(who %in% wasRandomized_int) %&gt;%</span></span>
<span id="cb60-367"><a href="#cb60-367" aria-hidden="true" tabindex="-1"></a><span class="in">  # Add back in the groupings BEFORE the fill()</span></span>
<span id="cb60-368"><a href="#cb60-368" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(who) %&gt;%</span></span>
<span id="cb60-369"><a href="#cb60-369" aria-hidden="true" tabindex="-1"></a><span class="in">  fill(whenRandomized1, .direction = "updown") %&gt;%</span></span>
<span id="cb60-370"><a href="#cb60-370" aria-hidden="true" tabindex="-1"></a><span class="in">  fill(whenRandomized2, .direction = "updown") %&gt;%</span></span>
<span id="cb60-371"><a href="#cb60-371" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(daysSinceRand1 = when - whenRandomized1) %&gt;%</span></span>
<span id="cb60-372"><a href="#cb60-372" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(daysSinceRand2 = when - whenRandomized2) %&gt;%</span></span>
<span id="cb60-373"><a href="#cb60-373" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-whenRandomized1, -whenRandomized2)</span></span>
<span id="cb60-374"><a href="#cb60-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-375"><a href="#cb60-375" aria-hidden="true" tabindex="-1"></a><span class="in">weeklyUse_df &lt;-</span></span>
<span id="cb60-376"><a href="#cb60-376" aria-hidden="true" tabindex="-1"></a><span class="in">  timelineUDS2_df %&gt;%</span></span>
<span id="cb60-377"><a href="#cb60-377" aria-hidden="true" tabindex="-1"></a><span class="in">  # The (daysSinceRand1 - 1) adjustment is to ensure that the first study week</span></span>
<span id="cb60-378"><a href="#cb60-378" aria-hidden="true" tabindex="-1"></a><span class="in">  #   is a full 7 days, since "day 0" is the day before randomization. The "+1"</span></span>
<span id="cb60-379"><a href="#cb60-379" aria-hidden="true" tabindex="-1"></a><span class="in">  #   at the end is to shift the study week label such that "week 0" is the</span></span>
<span id="cb60-380"><a href="#cb60-380" aria-hidden="true" tabindex="-1"></a><span class="in">  #   week *BEFORE* treatment, rather than the first week of treatment. So, the</span></span>
<span id="cb60-381"><a href="#cb60-381" aria-hidden="true" tabindex="-1"></a><span class="in">  #   randomization day is the last day of "week 0" (the pre-treatment period).</span></span>
<span id="cb60-382"><a href="#cb60-382" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(studyWeek1 = (daysSinceRand1 - 1) %/% 7 + 1) %&gt;%</span></span>
<span id="cb60-383"><a href="#cb60-383" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(studyWeek2 = (daysSinceRand2 - 1) %/% 7 + 1) %&gt;%</span></span>
<span id="cb60-384"><a href="#cb60-384" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(who, studyWeek1) %&gt;%</span></span>
<span id="cb60-385"><a href="#cb60-385" aria-hidden="true" tabindex="-1"></a><span class="in">  # There are some study weeks with multiple UDS, so we count the number of</span></span>
<span id="cb60-386"><a href="#cb60-386" aria-hidden="true" tabindex="-1"></a><span class="in">  #   positive and negative UDS per week.</span></span>
<span id="cb60-387"><a href="#cb60-387" aria-hidden="true" tabindex="-1"></a><span class="in">  summarise(</span></span>
<span id="cb60-388"><a href="#cb60-388" aria-hidden="true" tabindex="-1"></a><span class="in">    nPosUDS  = sum(udsOpioid == 1, na.rm = TRUE),</span></span>
<span id="cb60-389"><a href="#cb60-389" aria-hidden="true" tabindex="-1"></a><span class="in">    nNegUDS  = sum(visitImputed == "Present" &amp; is.na(udsOpioid), na.rm = TRUE),</span></span>
<span id="cb60-390"><a href="#cb60-390" aria-hidden="true" tabindex="-1"></a><span class="in">    nMissing = sum(visitImputed == "Missing", na.rm = TRUE),</span></span>
<span id="cb60-391"><a href="#cb60-391" aria-hidden="true" tabindex="-1"></a><span class="in">    randWk1  = sum(randomized == 1, na.rm = TRUE) &gt; 0,</span></span>
<span id="cb60-392"><a href="#cb60-392" aria-hidden="true" tabindex="-1"></a><span class="in">    randWk2  = sum(randomized == 2 &amp; project == "30", na.rm = TRUE) &gt; 0</span></span>
<span id="cb60-393"><a href="#cb60-393" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-394"><a href="#cb60-394" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb60-395"><a href="#cb60-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-396"><a href="#cb60-396" aria-hidden="true" tabindex="-1"></a><span class="in">useByWeekRandomized_df &lt;-</span></span>
<span id="cb60-397"><a href="#cb60-397" aria-hidden="true" tabindex="-1"></a><span class="in">  weeklyUse_df %&gt;%</span></span>
<span id="cb60-398"><a href="#cb60-398" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb60-399"><a href="#cb60-399" aria-hidden="true" tabindex="-1"></a><span class="in">    udsStatus = case_when(</span></span>
<span id="cb60-400"><a href="#cb60-400" aria-hidden="true" tabindex="-1"></a><span class="in">      # If we see a positive UDS and no negative UDS, it's positive</span></span>
<span id="cb60-401"><a href="#cb60-401" aria-hidden="true" tabindex="-1"></a><span class="in">      nPosUDS &gt; 0 &amp; nNegUDS == 0 ~ "+",</span></span>
<span id="cb60-402"><a href="#cb60-402" aria-hidden="true" tabindex="-1"></a><span class="in">      # If we see a negative UDS and no positive UDS, it's negative</span></span>
<span id="cb60-403"><a href="#cb60-403" aria-hidden="true" tabindex="-1"></a><span class="in">      nPosUDS == 0 &amp; nNegUDS &gt; 0 ~ "-",</span></span>
<span id="cb60-404"><a href="#cb60-404" aria-hidden="true" tabindex="-1"></a><span class="in">      # If we see both positive and negative UDS in a single week, it's both</span></span>
<span id="cb60-405"><a href="#cb60-405" aria-hidden="true" tabindex="-1"></a><span class="in">      #   (note that we can recode all "B"s to be "+" as necessary)</span></span>
<span id="cb60-406"><a href="#cb60-406" aria-hidden="true" tabindex="-1"></a><span class="in">      nPosUDS &gt; 0 &amp; nNegUDS &gt; 0 ~ "*",</span></span>
<span id="cb60-407"><a href="#cb60-407" aria-hidden="true" tabindex="-1"></a><span class="in">      # If we don't have any UDS in a week after randomization, it's missing</span></span>
<span id="cb60-408"><a href="#cb60-408" aria-hidden="true" tabindex="-1"></a><span class="in">      # UPDATE 2022-03-08: I had this as a 0 originally, and I was using this</span></span>
<span id="cb60-409"><a href="#cb60-409" aria-hidden="true" tabindex="-1"></a><span class="in">      #   in context of consent, not randomization. This was wrong.</span></span>
<span id="cb60-410"><a href="#cb60-410" aria-hidden="true" tabindex="-1"></a><span class="in">      nPosUDS == 0 &amp; nNegUDS == 0 &amp; studyWeek1 &gt;= 1 ~ "o",</span></span>
<span id="cb60-411"><a href="#cb60-411" aria-hidden="true" tabindex="-1"></a><span class="in">      # If none of the above are true, but we still have a missing value as</span></span>
<span id="cb60-412"><a href="#cb60-412" aria-hidden="true" tabindex="-1"></a><span class="in">      #   marked by the MarkMissing() function, then it's missing</span></span>
<span id="cb60-413"><a href="#cb60-413" aria-hidden="true" tabindex="-1"></a><span class="in">      nMissing &gt; 0 ~ "o",</span></span>
<span id="cb60-414"><a href="#cb60-414" aria-hidden="true" tabindex="-1"></a><span class="in">      # If none of the above conditions are true (probably because it's a week</span></span>
<span id="cb60-415"><a href="#cb60-415" aria-hidden="true" tabindex="-1"></a><span class="in">      #   before randomization but not during a baseline visit for consent),</span></span>
<span id="cb60-416"><a href="#cb60-416" aria-hidden="true" tabindex="-1"></a><span class="in">      #   then leave it blank (pre-study)</span></span>
<span id="cb60-417"><a href="#cb60-417" aria-hidden="true" tabindex="-1"></a><span class="in">      TRUE ~ "_"</span></span>
<span id="cb60-418"><a href="#cb60-418" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb60-419"><a href="#cb60-419" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-420"><a href="#cb60-420" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(who) %&gt;%</span></span>
<span id="cb60-421"><a href="#cb60-421" aria-hidden="true" tabindex="-1"></a><span class="in">  # For CTN-0030, Phase II could have started on any day of the week, even in</span></span>
<span id="cb60-422"><a href="#cb60-422" aria-hidden="true" tabindex="-1"></a><span class="in">  #   the middle of a treatment week. If we try to start counting Phase II</span></span>
<span id="cb60-423"><a href="#cb60-423" aria-hidden="true" tabindex="-1"></a><span class="in">  #   weeks the day after treatment arms are switched, we can end up with the</span></span>
<span id="cb60-424"><a href="#cb60-424" aria-hidden="true" tabindex="-1"></a><span class="in">  #   last "week" of Phase I not having 7 days. I'm going to leave the first</span></span>
<span id="cb60-425"><a href="#cb60-425" aria-hidden="true" tabindex="-1"></a><span class="in">  #   week of Phase II as whatever week the switch happened in.</span></span>
<span id="cb60-426"><a href="#cb60-426" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb60-427"><a href="#cb60-427" aria-hidden="true" tabindex="-1"></a><span class="in">    rand1Active = studyWeek1 &gt; 0,</span></span>
<span id="cb60-428"><a href="#cb60-428" aria-hidden="true" tabindex="-1"></a><span class="in">    # This returns 0 for any week before the Phase II randomization, and 1 for</span></span>
<span id="cb60-429"><a href="#cb60-429" aria-hidden="true" tabindex="-1"></a><span class="in">    #   the Phase II randomization week and all subsequent weeks (because the</span></span>
<span id="cb60-430"><a href="#cb60-430" aria-hidden="true" tabindex="-1"></a><span class="in">    #   randWk2 column is 1 only for the week of second randomization and 0</span></span>
<span id="cb60-431"><a href="#cb60-431" aria-hidden="true" tabindex="-1"></a><span class="in">    #   all other rows).</span></span>
<span id="cb60-432"><a href="#cb60-432" aria-hidden="true" tabindex="-1"></a><span class="in">    rand2Active = cumsum(randWk2),</span></span>
<span id="cb60-433"><a href="#cb60-433" aria-hidden="true" tabindex="-1"></a><span class="in">    trialPhase  = rand1Active + rand2Active</span></span>
<span id="cb60-434"><a href="#cb60-434" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb60-435"><a href="#cb60-435" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(</span></span>
<span id="cb60-436"><a href="#cb60-436" aria-hidden="true" tabindex="-1"></a><span class="in">    who,</span></span>
<span id="cb60-437"><a href="#cb60-437" aria-hidden="true" tabindex="-1"></a><span class="in">    studyWeek = studyWeek1, randWk1, randWk2, udsStatus, trialPhase</span></span>
<span id="cb60-438"><a href="#cb60-438" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb60-439"><a href="#cb60-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-440"><a href="#cb60-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-441"><a href="#cb60-441" aria-hidden="true" tabindex="-1"></a><span class="in">#### NEW</span></span>
<span id="cb60-442"><a href="#cb60-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-443"><a href="#cb60-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-444"><a href="#cb60-444" aria-hidden="true" tabindex="-1"></a><span class="in">compliance_results &lt;-</span></span>
<span id="cb60-445"><a href="#cb60-445" aria-hidden="true" tabindex="-1"></a><span class="in">  useByWeekRandomized_df %&gt;%</span></span>
<span id="cb60-446"><a href="#cb60-446" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(trialPhase == 1) %&gt;%</span></span>
<span id="cb60-447"><a href="#cb60-447" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(studyWeek &gt;= 0) %&gt;%</span></span>
<span id="cb60-448"><a href="#cb60-448" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_join(everybody) %&gt;%</span></span>
<span id="cb60-449"><a href="#cb60-449" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(project, who) %&gt;%</span></span>
<span id="cb60-450"><a href="#cb60-450" aria-hidden="true" tabindex="-1"></a><span class="in">  summarise(sum_pos = sum(udsStatus == "+"), sum_neg = sum(udsStatus == "-"), sumMissing = sum(udsStatus == "o"), total_weeks = 1 + max(studyWeek)) %&gt;%</span></span>
<span id="cb60-451"><a href="#cb60-451" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(compliance = sum_neg / total_weeks, attendance = (sum_neg+sum_pos)/total_weeks) %&gt;%</span></span>
<span id="cb60-452"><a href="#cb60-452" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_join(randomization_tbl %&gt;% dplyr::select(who, age, is_hispanic, race, job, education, is_living_stable, marital, is_male, cocaine:total_reported_drugs, predict_randomization)) %&gt;%</span></span>
<span id="cb60-453"><a href="#cb60-453" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(project=as.factor(project))</span></span>
<span id="cb60-454"><a href="#cb60-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-455"><a href="#cb60-455" aria-hidden="true" tabindex="-1"></a><span class="in"># from https://stats.stackexchange.com/questions/31300/dealing-with-0-1-values-in-a-beta-regression</span></span>
<span id="cb60-456"><a href="#cb60-456" aria-hidden="true" tabindex="-1"></a><span class="in"># squeeze 0 and 1 so can use beta regression</span></span>
<span id="cb60-457"><a href="#cb60-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-458"><a href="#cb60-458" aria-hidden="true" tabindex="-1"></a><span class="in">N &lt;- dim(compliance_results)[1]</span></span>
<span id="cb60-459"><a href="#cb60-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-460"><a href="#cb60-460" aria-hidden="true" tabindex="-1"></a><span class="in">compliance_results &lt;- mutate(compliance_results, squeeze_compliance = (compliance * (N - 1) + 0.5) / N, squeeze_attendance = (attendance * (N - 1) + 0.5) / N)</span></span>
<span id="cb60-461"><a href="#cb60-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-462"><a href="#cb60-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-463"><a href="#cb60-463" aria-hidden="true" tabindex="-1"></a><span class="in">beta_compliance &lt;- betareg(squeeze_compliance ~ age + is_hispanic + race + education + job + is_living_stable + marital + is_male + cocaine + heroin + speedball + opioid + speed, compliance_results)</span></span>
<span id="cb60-464"><a href="#cb60-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-465"><a href="#cb60-465" aria-hidden="true" tabindex="-1"></a><span class="in">beta_compliance_red &lt;- betareg(squeeze_compliance ~ age + race + job + marital + heroin + opioid, compliance_results)</span></span>
<span id="cb60-466"><a href="#cb60-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-467"><a href="#cb60-467" aria-hidden="true" tabindex="-1"></a><span class="in">beta_attendance &lt;- betareg(squeeze_attendance ~ age + is_hispanic + race + education + job + is_living_stable + marital + is_male + cocaine + heroin + speedball + opioid + speed, compliance_results)</span></span>
<span id="cb60-468"><a href="#cb60-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-469"><a href="#cb60-469" aria-hidden="true" tabindex="-1"></a><span class="in">beta_attendance_red &lt;- betareg(squeeze_attendance ~ age   + job + is_living_stable + marital + opioid + speed, compliance_results)</span></span>
<span id="cb60-470"><a href="#cb60-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-471"><a href="#cb60-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-472"><a href="#cb60-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-473"><a href="#cb60-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-474"><a href="#cb60-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-475"><a href="#cb60-475" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n## Beta regression coefficients (factor reference levels based on alphabetical order)\n\n")</span></span>
<span id="cb60-476"><a href="#cb60-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-477"><a href="#cb60-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-478"><a href="#cb60-478" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Compliance\n\n")</span></span>
<span id="cb60-479"><a href="#cb60-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-480"><a href="#cb60-480" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(beta_compliance_red) %&gt;%</span></span>
<span id="cb60-481"><a href="#cb60-481" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-statistic) %&gt;%</span></span>
<span id="cb60-482"><a href="#cb60-482" aria-hidden="true" tabindex="-1"></a><span class="in">  kable() %&gt;%</span></span>
<span id="cb60-483"><a href="#cb60-483" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling() %&gt;%</span></span>
<span id="cb60-484"><a href="#cb60-484" aria-hidden="true" tabindex="-1"></a><span class="in">  pack_rows("Race (reference level Black)", 3, 5) %&gt;%</span></span>
<span id="cb60-485"><a href="#cb60-485" aria-hidden="true" tabindex="-1"></a><span class="in">  pack_rows("job (reference level Full Time)", 6, 10) %&gt;%</span></span>
<span id="cb60-486"><a href="#cb60-486" aria-hidden="true" tabindex="-1"></a><span class="in">  pack_rows("Marital (ref level Married or Partnered)", 11, 13)</span></span>
<span id="cb60-487"><a href="#cb60-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-488"><a href="#cb60-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-489"><a href="#cb60-489" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### No major difference between Projects\n\n")</span></span>
<span id="cb60-490"><a href="#cb60-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-491"><a href="#cb60-491" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\nUpdate models by adding project and look for marginal means between projects\n\n")</span></span>
<span id="cb60-492"><a href="#cb60-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-493"><a href="#cb60-493" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n#### Compliance\n\n")</span></span>
<span id="cb60-494"><a href="#cb60-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-495"><a href="#cb60-495" aria-hidden="true" tabindex="-1"></a><span class="in">ggemmeans(update(beta_compliance_red,.~.+project),"project") %&gt;% as.data.frame()   %&gt;% dplyr::select(project=x, predicted, conf.low, conf.high) %&gt;% kable() %&gt;% kable_styling()</span></span>
<span id="cb60-496"><a href="#cb60-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-497"><a href="#cb60-497" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n#### Attendance\n\n")</span></span>
<span id="cb60-498"><a href="#cb60-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-499"><a href="#cb60-499" aria-hidden="true" tabindex="-1"></a><span class="in">ggemmeans(update(beta_attendance_red,.~.+project),"project") %&gt;% as.data.frame()   %&gt;% dplyr::select(project=x, predicted, conf.low, conf.high) %&gt;% kable() %&gt;% kable_styling()</span></span>
<span id="cb60-500"><a href="#cb60-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-501"><a href="#cb60-501" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Attendance\n\n")</span></span>
<span id="cb60-502"><a href="#cb60-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-503"><a href="#cb60-503" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(beta_attendance_red) %&gt;%</span></span>
<span id="cb60-504"><a href="#cb60-504" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-statistic) %&gt;%</span></span>
<span id="cb60-505"><a href="#cb60-505" aria-hidden="true" tabindex="-1"></a><span class="in">  kable() %&gt;%</span></span>
<span id="cb60-506"><a href="#cb60-506" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling() %&gt;%</span></span>
<span id="cb60-507"><a href="#cb60-507" aria-hidden="true" tabindex="-1"></a><span class="in">  pack_rows("Job (reference level Full Time)", 3, 7) %&gt;%</span></span>
<span id="cb60-508"><a href="#cb60-508" aria-hidden="true" tabindex="-1"></a><span class="in">  pack_rows("Is living stable (reference level No)", 8, 9) %&gt;%</span></span>
<span id="cb60-509"><a href="#cb60-509" aria-hidden="true" tabindex="-1"></a><span class="in">  pack_rows("Marital (ref level Married or Partnered)", 10, 12)</span></span>
<span id="cb60-510"><a href="#cb60-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-511"><a href="#cb60-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-512"><a href="#cb60-512" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n## Estimated marginal means\n\n")</span></span>
<span id="cb60-513"><a href="#cb60-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-514"><a href="#cb60-514" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Age\n\n")</span></span>
<span id="cb60-515"><a href="#cb60-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-516"><a href="#cb60-516" aria-hidden="true" tabindex="-1"></a><span class="in">emm_compliance_age &lt;- ggemmeans(beta_compliance_red, "age") %&gt;% mutate(outcome="compliance")</span></span>
<span id="cb60-517"><a href="#cb60-517" aria-hidden="true" tabindex="-1"></a><span class="in">emm_attendance_age &lt;- ggemmeans(beta_attendance_red, "age") %&gt;% mutate(outcome="attendance")</span></span>
<span id="cb60-518"><a href="#cb60-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-519"><a href="#cb60-519" aria-hidden="true" tabindex="-1"></a><span class="in">bind_rows(emm_attendance_age, emm_compliance_age) %&gt;%</span></span>
<span id="cb60-520"><a href="#cb60-520" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=x, y=predicted, ymax=conf.high, ymin=conf.low, color=outcome, fill=outcome)) + geom_smooth() + theme_bw() +scale_y_continuous(label=percent) + geom_ribbon(alpha=0.5, color=NA) + labs(y="Estimate",x="Age") + theme(legend.position = "bottom")</span></span>
<span id="cb60-521"><a href="#cb60-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-522"><a href="#cb60-522" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Age (raw data) \n\n")</span></span>
<span id="cb60-523"><a href="#cb60-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-524"><a href="#cb60-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-525"><a href="#cb60-525" aria-hidden="true" tabindex="-1"></a><span class="in">compliance_results %&gt;% ungroup() %&gt;% dplyr::select(compliance, attendance, age) %&gt;% pivot_longer(-age) %&gt;% ggplot(aes(x=age,y=value, color=name, fill=name)) + geom_point(alpha=0.25) + geom_smooth() + theme_bw() + labs(color="Outcome", fill="Outcome", y="Rate") + theme(legend.position = "bottom") + scale_y_continuous(label=percent)</span></span>
<span id="cb60-526"><a href="#cb60-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-527"><a href="#cb60-527" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Marital\n\n")</span></span>
<span id="cb60-528"><a href="#cb60-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-529"><a href="#cb60-529" aria-hidden="true" tabindex="-1"></a><span class="in">emm_compliance_marital &lt;- ggemmeans(beta_compliance_red, "marital") %&gt;% mutate(outcome="compliance") %&gt;% as.data.frame()</span></span>
<span id="cb60-530"><a href="#cb60-530" aria-hidden="true" tabindex="-1"></a><span class="in">emm_attendance_marital &lt;- ggemmeans(beta_attendance_red, "marital") %&gt;% mutate(outcome="attendance")%&gt;% as.data.frame()</span></span>
<span id="cb60-531"><a href="#cb60-531" aria-hidden="true" tabindex="-1"></a><span class="in">bind_rows(emm_attendance_marital, emm_compliance_marital) %&gt;%</span></span>
<span id="cb60-532"><a href="#cb60-532" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(x)) %&gt;%</span></span>
<span id="cb60-533"><a href="#cb60-533" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat="identity", position="dodge") + geom_errorbar(position="dodge") + theme_bw() + theme(legend.position = "bottom") + scale_x_continuous(label=percent) + labs(y="Marital", x="Estimate") + facet_grid(~outcome)</span></span>
<span id="cb60-534"><a href="#cb60-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-535"><a href="#cb60-535" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Job\n\n")</span></span>
<span id="cb60-536"><a href="#cb60-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-537"><a href="#cb60-537" aria-hidden="true" tabindex="-1"></a><span class="in">emm_compliance_job &lt;- ggemmeans(beta_compliance_red, "job") %&gt;% mutate(outcome="compliance") %&gt;% as.data.frame()</span></span>
<span id="cb60-538"><a href="#cb60-538" aria-hidden="true" tabindex="-1"></a><span class="in">emm_attendance_job &lt;- ggemmeans(beta_attendance_red, "job") %&gt;% mutate(outcome="attendance")%&gt;% as.data.frame()</span></span>
<span id="cb60-539"><a href="#cb60-539" aria-hidden="true" tabindex="-1"></a><span class="in">bind_rows(emm_attendance_job, emm_compliance_job) %&gt;%</span></span>
<span id="cb60-540"><a href="#cb60-540" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(x)) %&gt;%</span></span>
<span id="cb60-541"><a href="#cb60-541" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat="identity", position="dodge") + geom_errorbar(position="dodge") + theme_bw() + theme(legend.position = "bottom") + scale_x_continuous(label=percent) + labs(y="Job", x="Estimate") + facet_grid(~outcome)</span></span>
<span id="cb60-542"><a href="#cb60-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-543"><a href="#cb60-543" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Opioid\n\n")</span></span>
<span id="cb60-544"><a href="#cb60-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-545"><a href="#cb60-545" aria-hidden="true" tabindex="-1"></a><span class="in">emm_compliance_opioid &lt;- ggemmeans(beta_compliance_red, "opioid") %&gt;% mutate(outcome="compliance") %&gt;% as.data.frame()</span></span>
<span id="cb60-546"><a href="#cb60-546" aria-hidden="true" tabindex="-1"></a><span class="in">emm_attendance_opioid &lt;- ggemmeans(beta_attendance_red, "opioid") %&gt;% mutate(outcome="attendance")%&gt;% as.data.frame()</span></span>
<span id="cb60-547"><a href="#cb60-547" aria-hidden="true" tabindex="-1"></a><span class="in">bind_rows(emm_attendance_opioid, emm_compliance_opioid) %&gt;%</span></span>
<span id="cb60-548"><a href="#cb60-548" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(x)) %&gt;%</span></span>
<span id="cb60-549"><a href="#cb60-549" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(y=x, x=predicted, xmax=conf.high, xmin= predicted, color=outcome, fill=outcome, group=outcome)) + geom_bar(stat="identity", position="dodge") + geom_errorbar(position="dodge") + theme_bw() + theme(legend.position = "bottom") + scale_x_continuous(label=percent) + labs(y="opioid", x="Estimate") + facet_grid(~outcome)</span></span>
<span id="cb60-550"><a href="#cb60-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-551"><a href="#cb60-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-552"><a href="#cb60-552" aria-hidden="true" tabindex="-1"></a><span class="in">#test_predictions(beta_compliance_red, "marital") %&gt;%</span></span>
<span id="cb60-553"><a href="#cb60-553" aria-hidden="true" tabindex="-1"></a><span class="in">#  kable() %&gt;%</span></span>
<span id="cb60-554"><a href="#cb60-554" aria-hidden="true" tabindex="-1"></a><span class="in">#  kable_styling()</span></span>
<span id="cb60-555"><a href="#cb60-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-556"><a href="#cb60-556" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Race (compliance alone)\n\n")</span></span>
<span id="cb60-557"><a href="#cb60-557" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ggemmeans(beta_compliance_red, "race"))</span></span>
<span id="cb60-558"><a href="#cb60-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-559"><a href="#cb60-559" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Heroin (compliance alone)\n\n")</span></span>
<span id="cb60-560"><a href="#cb60-560" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ggemmeans(beta_compliance_red, "heroin"))</span></span>
<span id="cb60-561"><a href="#cb60-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-562"><a href="#cb60-562" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Speed (attendance alone)\n\n")</span></span>
<span id="cb60-563"><a href="#cb60-563" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ggemmeans(beta_attendance_red, "speed"))</span></span>
<span id="cb60-564"><a href="#cb60-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-565"><a href="#cb60-565" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\n\n### Is living stable (attendance alone)\n\n")</span></span>
<span id="cb60-566"><a href="#cb60-566" aria-hidden="true" tabindex="-1"></a><span class="in">plot(ggemmeans(beta_attendance_red, "is_living_stable"))</span></span>
<span id="cb60-567"><a href="#cb60-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-568"><a href="#cb60-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-569"><a href="#cb60-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-570"><a href="#cb60-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-571"><a href="#cb60-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-572"><a href="#cb60-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-573"><a href="#cb60-573" aria-hidden="true" tabindex="-1"></a><span class="fu"># CONCLUSIONS</span></span>
<span id="cb60-574"><a href="#cb60-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-575"><a href="#cb60-575" aria-hidden="true" tabindex="-1"></a>Analyses of the data indicate that the age of the participant is the most important factor for both successful randomization and higher attendance/compliance, however the effects go in opposite directions:</span>
<span id="cb60-576"><a href="#cb60-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-577"><a href="#cb60-577" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>For randomization, the probability of enrollment is lower with increasing age.</span>
<span id="cb60-578"><a href="#cb60-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-579"><a href="#cb60-579" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Once randomized, the rates of attendance and compliance goe up with increasing age.</span>
<span id="cb60-580"><a href="#cb60-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-581"><a href="#cb60-581" aria-hidden="true" tabindex="-1"></a>For randomization, the other predictors are the total reported drugs and martial status, but in both cases missing is the most important factor – and there, lack of reported data (indicating unwillingness to participate by reporting data?) indicates lower probability of being randomized. The predictive power of this model is quite strong (AUC 0.8, linear calibration curve).</span>
<span id="cb60-582"><a href="#cb60-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-583"><a href="#cb60-583" aria-hidden="true" tabindex="-1"></a>For compliance and attendance, the predictive power of models are lower. Age remains the most powerful predictor, while other predictors appear to be race, job, marital status, and heroin and opioid.</span>
<span id="cb60-584"><a href="#cb60-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-585"><a href="#cb60-585" aria-hidden="true" tabindex="-1"></a>Future recruitment of patients into drug treatment trials might try greater outreach to older patients, who seemed less willing to participate but more successful.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>